---
og:description: Learn about best practices for custom database connection anatomy.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: カスタムデータベース接続の構造に関するベストプラクティス
og:url: https://auth0.com/docs/
permalink: anatomy
title: カスタムデータベース接続の構造に関するベストプラクティス
twitter:description: Learn about best practices for custom database connection anatomy.
twitter:title: カスタムデータベース接続の構造に関するベストプラクティス
---

You typically use a custom database connection to provide access to your own legacy identity store for authentication (sometimes referred to as **legacy authentication**) or [perform user import through automatic migration](/docs/manage-users/user-migration/configure-automatic-migration-from-your-database) (often referred to as **trickle** or **lazy** migration). You can also use custom database connections to proxy access to an Auth0 tenant in scenarios where you use Auth0 multi-tenant architecture. To learn more, read [Multi-Tenant Applications Best Practices](/docs/get-started/auth0-overview/create-tenants/multi-tenant-apps-best-practices).

You typically create and configure custom database connections using the <Tooltip tip="Auth0 Dashboard: Auth0's main product to configure your services." cta="View Glossary" href="/docs/glossary?term=Auth0+Dashboard">Auth0 Dashboard</Tooltip>. You create a database connection and then toggle **Use my own database** to enable editing of the database action scripts. A custom database connection can also be created and configured with the Auth0 <Tooltip tip="Management API: A product to allow customers to perform administrative tasks." cta="View Glossary" href="/docs/glossary?term=Management+API">Management API</Tooltip> [Create a connection endpoint](https://auth0.com/docs/api/management/v2#!/Connections/post_connections) and the `auth0` strategy.

<Frame>![Auth0 Dashboard Authentication Database Connection Custom Database Settings Use Own Database Enabled](/images/cdy7uua7fh8z/11HPAdVwJMmnWbzMVjHCJ8/f75ff47f613a41778f266643f29ab2b1/2025-02-27_17-25-36.png)</Frame>

下の図が示すように、カスタムデータベース接続をログインワークフローに使用して、認証やユーザーのインポートを行うために、ユーザーのID情報が独自のレガシーIDストアから取得できるようにします。

<Frame>![Custom Database Connection Flow](/images/cdy7uua7fh8z/1H2Ky1WyPlZ9zHZrEVlFhP/4e4856395fac6d6339c883c35d4b4ac0/custom-database-connections.png)</Frame>

すべてのデータベース接続タイプに共通なアーティファクトに加えて、カスタムデータベース接続を使用すると、アクションスクリプトを構成できるようになります。アクションスクリプトとは、レガシーIDストアとのやり取りに使用されるカスタムコードのことです。構成にどのスクリプトを選ぶかは、作成する接続の用途がレガシー認証なのか、それとも自動移行なのかに依存します。

Action scripts can be implemented as anonymous functions; however, anonymous functions make it hard to debug when it comes to interpreting the call-stack generated as a result of any exceptional error conditions. For convenience, we recommend providing a function name for each action script. To see some recommended names, read [Custom Database Action Script Execution Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts/execution).

In a legacy authentication scenario, no new user record is created; the user remains in the legacy identity store and Auth0 uses the identity it contains when authenticating the user. Custom database connections are also used outside of the <Tooltip tip="Universal Login: Your application redirects to Universal Login, hosted on Auth0's Authorization Server, to verify a user's identity." cta="View Glossary" href="/docs/glossary?term=Universal+Login">Universal Login</Tooltip> workflow. For example, a connection's `changePassword` action script is called when a password change operation occurs for a user that resides in a legacy identity store.

## 自動移行

自動移行では、Auth0は新しいユーザーをAuth0管理のIDストア（データベース）内に作成します。Auth0がユーザーを認証する際には、Auth0管理のIDストアにあるIDが使用されます。これを行うために、Auth0は、レガシーIDストアに対照してユーザーが認証されることを要求します。この認証に成功した場合にのみ、Auth0はAuth0管理のデータベース内に新しいユーザーを作成します。新しいユーザーの作成には、認証中に提供されたのと同じIDとパスワードが使用されます。

自動移行のシナリオでは、ユーザーの作成は通常、ログインアクションスクリプトが完了した後で実行されます。ユーザーをレガシーIDストアから削除する際には、ログインスクリプト内でインライン操作として行うのではなく、独立処理として行うことをお勧めします。そうすることで、ユーザーを誤って削除したために、移行でエラー条件が発生することを防ぎます。

自動移行では、ユーザーは引き続きレガシーIDストアで管理され、必要に応じて削除やアーカイブを行うことができます。これに関する弊害は、ユーザーがAuth0から削除されても、レガシーデータストアに存在したままになることです。このときに、削除されたユーザーがログインしようとすると、ログインまたはユーザー取得スクリプトが実行され、そのユーザーがレガシーIDストアから再度移行されます。

ログインまたはユーザー取得スクリプトが完了する前か、レガシーストアが最終的に削除される前に、レガシーストアのユーザーIDに移行済のマークを付けて、意図的に削除したユーザーが思いがけず作成し直されてしまうことを防ぐようにお勧めします。

## サイズ

アクションスクリプトの実装では、総サイズが100　KBを上回らないことをお勧めします。Auth0プラットフォームでパッケージングと転送が処理されるため、サイズが大きいほど遅延が長くなります。そして、これはシステムの性能にも影響を与えます。100 KBの制限には、`require`ステートメントの一部として参照された可能性のある`npm`モジュールは含まれません。

## Learn more

* [Custom Database Connection Security Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts/connection-security)
* [Custom Database Action Script Execution Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts/execution)
* [Custom Database Action Script Environment Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts/environment)