---
og:description: Learn about best practices for custom database action script execution.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: カスタムデータベースのアクションスクリプトのベストプラクティス
og:url: https://auth0.com/docs/
permalink: execution
title: カスタムデータベースのアクションスクリプトのベストプラクティス
twitter:description: Learn about best practices for custom database action script
  execution.
twitter:title: カスタムデータベースのアクションスクリプトのベストプラクティス
---

カスタムのデータベース接続タイプにより、Auth0がレガシーのidentity storeとやり取りするために使用するカスタムコードが含まれるアクションスクリプトを構成できます。アクションスクリプトは、事前に定義されたパラメーターのセットを受け付ける、名前が付けられたJavaScript関数です。

## Webtaskコンテナー

アクションスクリプトは、約20秒の実行制限で、個々のWebtaskコンテナー内で実行します。関数が実行された後、コンテナーはリサイクルされます。

When a container is recycled, it terminates the action script’s pending operations. This may result in an error condition being returned and a potential reset of the `global` object. For more information on the `global` object, read [Custom Database Action Script Environment Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts/environment).

## 非同期関数

非同期関数 of JavaScript, including [Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise) objects and [async functions](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function), are supported in action scripts.

アクションスクリプト内で外部サービスまたはAPIを呼び出す場合は、合理的な時間の後にタイムアウトして、かつ外部サービスもしくはAPIに到達できなかった場合は[エラーを返す](#error-handling)ように関数を設定してください。

例

### Auth0は、アクションスクリプト内での[Promise]()オブジェクトおよび[async function]()の使用をサポートしています。

Auth0 supports using [Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise) objects and [async functions](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function) within action scripts.

#### この例では、[promiseチェーン]()を使用して書かれた、ネットワークからリソースを取得しPromiseオブジェクトを返す、ビルトインのJavaScript `fetch`メソッドを使用しています。

This example uses the built-in JavaScript `fetch` method, which gets a resource from a network then returns a Promise object, written using [promise chains](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises#chaining).

```javascript lines expandable
function login(userNameOrEmail, password, callback) {
	const hashedPassword = hash(password);
	const apiEndpoint = 'https://example.com/api/authenticate';
	const options = {
		method: 'POST',
		body: {
			email: userNameOrEmail,
			password: hashedPassword
		}
	};

	fetch(apiEndpoint, options) 
		.then((response) => {
			if (!response.ok) {
				return callback(new Error(`HTTP error! Status: ${response.status}`));
			}

			return response.json();
		})
		.then((response) => {
			if (response.err) {
				return callback(new Error(`Error authenticating user: ${err}`));
			}

			let profile = {
				email: response.profileData.email,
				username: response.profileData.username
			};

			return callback(null, profile);
		})
		.catch((err) => {
			return callback(new Error(`An error occurred: ${err}`));
		});
  }
```






#### この例では、[async function]()を使用して書かれた、ネットワークからリソースを取得しPromiseオブジェクトを返す、組み込みのJavaScript `fetch`メソッドを使用しています。

This example uses the built-in JavaScript `fetch` method, which gets a resource from a network then returns a Promise object, written using [async functions](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function).

```js lines expandable
async function login(userNameOrEmail, password, callback) {
	const hashedPassword = hash(password);
	const apiEndpoint = 'https://example.com/api/authenticate';
	const options = {
		method: 'POST',
		body: {
			email: userNameOrEmail,
			password: hashedPassword
		}
	};

	const response = await fetch(apiEndpoint, options);

	if (!response.ok) {
		return callback(new Error(`HTTP error! Status: ${response.status}`));
	}

	const result = response.json();

	if (result.err) {
		return callback(new Error(`Error authenticating user: ${err}`));
	}

	let profile = {
		email: response.profileData.email,
		username: response.profileData.username
	};

	return callback(null, profile);
}
```






## 非同期処理

アクションスクリプトが非同期処理を使用する場合は、`callback`関数は、すべての非同期操作が完了した後に呼び出されなければなりません。

<Warning>

If the `callback` function is called more than once, then it may lead to unexpected results and/or errors.

If the `callback` function is not called at all, then execution of the action script will stall, and an error will be returned when the Webtask container is recycled.

</Warning>

### パラメーター

Size（サイズ）

### アクションスクリプトの実装の合計サイズは、100kBを超えてはなりません。このサイズ制限は、インポートされた`npm`モジュールを除外します。`npm`モジュールの詳細については、[カスタムデータベースのアクションスクリプト環境のベストプラクティス](/custom-database-connections-scripts/environment)をご覧ください。

スクリプトのサイズが大きくなればなるほど、Webtaskプラットフォームが使用するパッケージングおよび転送プロセスに基づいて遅延が増えます。サイズは、システムのパフォーマンスに影響を与えます。

## 無名関数

The total size of implementation for any action script must not exceed 100kB. This size limitation excludes imported `npm` modules. For more information on `npm` modules, read [Custom Database Action Script Environment Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts/environment).

エラー処理

## エラーを説明するメッセージで、`Error`オブジェクトを`callback`関数に渡します。

Action scripts can be implemented as anonymous functions, but it is not recommended that you do so. エラーを説明するメッセージで、`Error`オブジェクトを`callback`関数に渡します。 make it difficult to debug the action script and interpret the call-stack generated as a result of any exceptional error condition. To learn more about anonymous functions, read [IIFE on MDN Web Docs](https://developer.mozilla.org/en-US/docs/Glossary/IIFE).

## データベースインターフェイス vs.API

Auth0とレガシーのidentity store間の通信すべての安全を確保してください。レガシーのidentity storeにまだAPIが実装されていない場合は、そうすることを強くお勧めします。

```js lines
return callback(new Error('My custom error message'));
```






## レガシーのidentity storeにAPIが用意されている場合は、Auth0を通して[APIを登録]()し、エンドユーザーからのアクセスを制限するために[アクションを作成]()してください。

### レガシーのidentity storeにAPIが用意されておらず、かつ実装することが不可能な場合でも、データベースと直接通信することができます。Auth0からのインバウンドトラフィックを許可するために、必ず[ファイアウォールの許可リストにAuth0 IPアドレスを追加]()してください。

IDプロバイダーのトークン

If your legacy identity store has an API available, you can [register the API](/docs/get-started/auth0-overview/set-up-apis) through Auth0, and [create an Action](/docs/manage-users/access-control/sample-use-cases-actions-with-authorization#deny-access-to-anyone-calling-an-api) to restrict access from end users.

If your legacy identity store does not have an API available—and implementing one is not feasible—you can still communicate with your database directly. Make sure to [add Auth0 IP addresses to your firewall’s allow list](/docs/secure/security-guidance/data-security/allowlist) to allow inbound traffic from Auth0.

## Identity provider tokens

If the `user` object returns the `access_token` and `refresh_token` properties, Auth0 handles them differently from other types of user information. Auth0 stores them in the `user` object's `identities` property:

```json lines
{
    "email": "you@example.com",
    "updated_at": "2019-03-15T15:56:44.577Z",
    "user_id": "auth0|some_unique_id",
    "nickname": "a_nick_name",
    "identities": [ 
        {
            "user_id": "some_unique_id",
            "access_token": "e1b5.................92ba",
            "refresh_token": "a90c.................620b",
            "provider": "auth0", "connection": "custom_db_name",
            "isSocial": false 
        }
  ], 
  "created_at": "2019-03-15T15:56:44.577Z",
  "last_ip": "192.168.1.1",
  "last_login": "2019-03-15T15:56:44.576Z",
  "logins_count": 3
}
```






If you want to retrieve either of these properties with the Auth0 <Tooltip tip="Management API: A product to allow customers to perform administrative tasks." cta="View Glossary" href="/docs/glossary?term=Management+API">Management API</Tooltip>, include the `read:user_idp_tokens` scope when [requesting an Access Token](/docs/secure/tokens/access-tokens/management-api-access-tokens/get-management-api-access-tokens-for-production).