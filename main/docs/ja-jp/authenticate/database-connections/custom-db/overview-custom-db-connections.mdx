---
og:description: Learn about authenticating users using your database as an identity
  provider.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: 独自のユーザーストアを使用して認証する
og:url: https://auth0.com/docs/
permalink: overview-custom-db-connections
title: 独自のユーザーストアを使用して認証する
twitter:description: Learn about authenticating users using your database as an identity
  provider.
twitter:title: 独自のユーザーストアを使用して認証する
---

<Card title="Availability varies by Auth0 plan">

Your Auth0 plan or custom agreement affects whether this feature is available. To learn more, read [Pricing](https://auth0.com/pricing).

</Card>

<Warning>

Only tenants created prior to 17 July 2018 have access to Webtask.io and the Webtask CLI. If you are an enterprise customer with a newer tenant, please contact your account representative to request access. Other requests can be made through the [Auth0 Contact Form](https://auth0.com/get-started?place=documentation%20post&type=link&text=auth0%20contact%20form) and will be evaluated on a case-by-case basis.

</Warning>

以下のような目的で、独自の（レガシー）IDデータストアにアクセスを提供したい場合には、カスタムデータベース接続を使用します。

* **Authentication**: Use your database as an <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=identity+provider">identity provider</Tooltip> in Auth0 to authenticate users. (Referred to as legacy authentication.)
* **ユーザーのインポート**：自動移行（トリクルダウン移行またはレイジー移行）を使用する
* **Auth0テナントへのプロキシアクセス**：Auth0のマルチテナントアーキテクチャを使用する

カスタムデータベース接続を作成して構成するには、以下のタスクを実行します。

1. Use the [Create connections](https://auth0.com/docs/api/management/v2#!/Connections/post_connections) endpoint with the `auth0` strategy.
2. Navigate to [Auth0 Dashboard > Authentication > Database](https://manage.auth0.com/#/connections/database), create the connection, and enable the **Use my own database** option to allow database action script editing.

   <Frame>![Enable Custom Database Use My Own Database Option](/images/cdy7uua7fh8z/3kgHDpBFdVWNq9XOfhsTXI/2efa43e44793b8dd69b9f9e8b54bf752/2025-02-25_10-20-20.png)</Frame>

## 仕組み

As shown in the diagram below, you use custom database connections as part of <Tooltip tip="Universal Login: Your application redirects to Universal Login, hosted on Auth0's Authorization Server, to verify a user's identity." cta="View Glossary" href="/docs/glossary?term=Universal+Login">Universal Login</Tooltip> workflow in order to obtain user identity information from your own, legacy identity store.

<Frame>![Custom Database Connections Anatomy](/images/cdy7uua7fh8z/2lHqvZKFiEbAXURU2gmchc/626cac94211c266f2135a41456b2e49d/custom-database-connections.png)</Frame>

In addition to artifacts common for all [database connection](/docs/authenticate/database-connections) types, a custom database connection allows you to configure action scripts: custom code that’s used when interfacing with your legacy identity store. Auth0 provides [custom database action script templates](/docs/authenticate/database-connections/custom-db/templates) for configuration, and the ones you use will depend on whether you are creating a custom database connection for legacy authentication or for automatic migration.

<Card title="Best practice">

Action scripts can be implemented as anonymous functions, however anonymous functions make it hard in debugging situations when it comes to interpreting the call-stack generated as a result of any exceptional error condition. For convenience, we recommend providing a function name for each action script.

</Card>

### レガシー認証のシナリオ

レガシー認証のシナリオでは、ユーザーが初めてログインすると、新しいレコードがAuth0内に作成されますが、ユーザーのパスワードのハッシュはAuth0に保管されません。Auth0がユーザーを認証する際には必ず、レガシーIDストアとそれに含まれているIDが使用されます。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

Custom database connections are also used outside of Universal Login workflow. For example, a connection's `changePassword` action script is called when a password change operation occurs for a user that resides in a legacy identity store.

</Callout>

### 自動移行のシナリオ

自動移行やトリクルダウン移行では、Auth0は新しいユーザーをAuth0管理のIDストア（データベース）内に作成します。その後、Auth0がユーザーを認証する際には必ず、Auth0管理のIDストアにあるIDが使用されます。これを行うために、Auth0は、レガシーIDストアに対照してユーザーが認証されることを要求します。この認証に成功した場合にのみ、Auth0は新しいユーザーを作成します。新しいユーザーの作成には、認証中に提供されたのと同じIDとパスワードが使用されます。

<Card title="Best practice">

Creation of a user in an automatic migration scenario typically occurs after the `login` action script completes. We therefore recommend that you do not attempt any deletion of a user from a legacy identity store as an inline operation (i.e., within the `login` script) but perform the deletion as an independent process. This will prevent accidental deletion of a user should an error condition occur during the migration process.

</Card>

自動移行のシナリオでは、ユーザーは引き続きレガシーIDストアで管理され、必要に応じて削除やアーカイブを行うことができます。これに関する弊害は、ユーザーがAuth0から削除されても、レガシーIDストアに存在したままになることです。このときに、削除されたユーザーがログインしようとすると、`login`または/そして`getUser`スクリプトが実行され、そのユーザーがレガシーIDストアから再度移行されます。

<Card title="Best practice">

We recommend marking any legacy user identity as having been migrated before either `login` or `getUser` completes and prior to any eventual legacy store deletion.

</Card>

## サイズ

アクションスクリプトの実装では、総サイズが100 KBを上回ってはいけません。Auth0のサーバーレスWebtaskプラットフォームでパッケージングと転送が処理されるため、サイズが大きいほど遅延が長くなります。そして、これはシステムの性能にも影響を与えます。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

The 100 kB limit does not include any `npm`モジュール that may be referenced as part of any require statements.

</Callout>

## 環境

Action scripts execute as a series of called JavaScript functions in an instance of a serverless Webtask container. As part of this, a specific environment is provided, together with a number of artifacts supplied by both the Webtask container and the Auth0 <Tooltip tip="Authentication Server: Server that confirms or denies a user’s identity." cta="View Glossary" href="/docs/glossary?term=authentication+server">authentication server</Tooltip> (your Auth0 tenant) itself.

### npm modules

Auth0 serverless Webtask containers can make use of a [wide range of npm modules](https://auth0-extensions.github.io/canirequire/); `npm`モジュール not only reduce the overall size of action script code implementation, but also provide access to a wide range of pre-built functionality.

Many publicly available `npm`モジュール are supported out-of-the-box. The list has been compiled and vetted for any potential security concerns. If you require an `npm` module that is not supported out-of-the-box, then you can make a request through the [Auth0 support portal](https://support.auth0.com) or your Auth0 representative. Auth0 will evaluate your request to determine suitability. There is currently no support in Auth0 for the user of `npm`モジュール from private repositories.

### 変数

Auth0 action scripts support environment variables, accessed via what is known as the globally-available `configuration` object. To learn more, read the Add Configuration Parameters section in [Create Custom Database Connections](/docs/authenticate/database-connections/custom-db/create-db-connection).

<Card title="Best practice">

The `configuration` object should be treated as read-only, and should be used for storing sensitive information such as credentials or API keys for accessing external identity stores. This mitigates having security sensitive values hard coded in an action script.

</Card>

The configuration object can also be used to support whatever [Software Development Life Cycle (SDLC)](/docs/get-started/auth0-overview/create-tenants/set-up-multiple-environments) strategies you employ by allowing you to define variables that have tenant specific values. This mitigates hard coded values in an action script which may change depending upon which tenant is executing it.

### global object

Auth0のサーバーレスWebtaskコンテナーは、各Auth0テナントに関連付けられているプールからプロビジョニングされます。コンテナーインスタンスはそれぞれ`global`オブジェクトを使用可能にして、コンテナーインスタンス内で実行されるすべてのアクションスクリプトからアクセスできるようにします。`global`オブジェクトは、コンテナーに一意のグローバル変数として動作し、コンテナーインスタンス内で実行されるすべてのアクションスクリプトが使用する情報や機能の定義に使うことができます。

This means that the `global`オブジェクト can be used to cache expensive resources as long as those resources are not user-specific. For example, you could use it to store an <Tooltip tip="Access Token: Authorization credential, in the form of an opaque string or JWT, used to access an API." cta="View Glossary" href="/docs/glossary?term=Access+Token">Access Token</Tooltip> for a third-party (logging) API that provides non-user-specific functionality. Or you could store an Access Token to your own non-user-specific API defined in Auth0 and obtained via the [Client Credentials Flow](/docs/get-started/authentication-and-authorization-flow/client-credentials-flow).

<Warning>

An action script may execute in any of the container instances already running, or in a newly created container instance (which may subsequently be added to the pool). There is no container affinity for action script execution in Auth0. This means that you should avoid storing any user-specific information in the `global` object, and should always ensure that any declaration made within the `global`オブジェクト provides for initialization too.

</Warning>

Webtaskコンテナーが再利用されるたびに、または、Webtaskコンテナーの新しいインスタンスでは、定義されている`global`オブジェクトがリセットされます。そのため、コンテナーに関連付けられた`global`オブジェクト内のすべての代入宣言には、初期化のプロビジョニングも含まれる必要があります。

<Card title="Best practice">

To provide performance flexibility, serverless Webtask containers are provisioned in Auth0 on an ad-hoc basis and are also subject to various recycle policies. In general, we recommend that you do not consider the life of a `global`オブジェクト to be anything more than 20 minutes.

</Card>

## セキュリティ

### カスタムAPIを使ってレガシーIDストレージにアクセスする

レガシーIDストレージを一般のアクセスから保護することは、ベストプラクティスとして推奨されています。たとえば、インターネットにデータベースを公開することは、SQLなどのデータベースインターフェイスが機能性の面で極めて開放的になるため、最小特権の原則（PoLP：Principle of Least Privilege）に違反することになります。

<Card title="Best practice">

We recommend that you implement an API to provide least privilege to your legacy identity store (database), rather than simply opening up general access via the internet.

</Card>

別の方法としては、アクセストークンを使って保護できるように、簡単な（カスタムの）APIを作成して、それぞれのアクションスクリプトが呼び出せるようにします。これは、レガシーIDストアへのインターフェイスとして機能します。そして、スクリプト内からアクセストークンを取得するには、クライアント資格情報付与フローを使うことができます。性能を向上させるために、これはその後`global`オブジェクト内で再利用のためにキャッシュされます。APIは個別の保護されたエンドポイントを提供して、必要なレガシー管理の機能性（`read user`、`change password`など）だけを専用に処理します。

<Card title="Best practice">

By default, Auth0 will give you a token for any API if you authenticate successfully and include the appropriate audience. Restricting access to the legacy identity store API by restricting access token allocation via use of a Rule, will prevent unauthorized usage and mitigate a number of attack vector scenarios, such as where redirect to `/authorize` is intercepted and the audience to the API is added.

</Card>

### レガシーIDストレージにAllowListでアクセスする

レガシーIDストアへのアクセスに、カスタムのAPIと提供しているネイティブインターフェイスのどちらを使う場合でも、Auth0テナントに関連付けられているIPアドレスのリストを使って、アクセスを制限することが推奨されます。AllowListはレガシーIDストアへのアクセスを制限し、Auth0で定義されているカスタムデータベースのアクションスクリプトのみが許可されることを確実にします。

<Warning>

The Auth0 IP address allowlist is shared among all Auth0 tenants defined to a region. Never use the allowlist as the sole method of securing access to your legacy identity store; doing so could open up potential security vulnerabilities allowing unauthorized access to your users.

</Warning>

## Learn more

* [Create Custom Database Connections](/docs/authenticate/database-connections/custom-db/create-db-connection)
* [Custom Database Action Script Templates](/docs/authenticate/database-connections/custom-db/templates)
* [Troubleshoot Custom Databases](/docs/authenticate/database-connections/custom-db/error-handling)
* [Import and Export Users](/docs/manage-users/user-migration)