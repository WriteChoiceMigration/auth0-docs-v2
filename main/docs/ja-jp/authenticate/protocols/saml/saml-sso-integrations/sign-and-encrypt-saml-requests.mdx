---
og:description: Describes the special configuration scenario to sign and encrypt SAML
  requests
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: SAML要求の署名と暗号化
og:url: https://auth0.com/docs/
permalink: sign-and-encrypt-saml-requests
title: SAML要求の署名と暗号化
twitter:description: Describes the special configuration scenario to sign and encrypt
  SAML requests
twitter:title: SAML要求の署名と暗号化
---

To increase the security of your transactions, you can sign or encrypt both your requests and your responses in the <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=SAML">SAML</Tooltip> protocol. In this article, you'll find configurations for specific scenarios, separated under two use cases:

* Auth0をSAMLサービスプロバイダーとして使用する場合（たとえば、SAML接続）
* Auth0 as the SAML <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=identity+provider">identity provider</Tooltip> (for example, an application configured with the SAML Web App addon)

## Auth0をSAMLサービスプロバイダーとして使用する場合

これらのシナリオは、Auth0がSAMLサービスプロバイダーである場合に適用されます。つまり、Auth0はSAML接続を作成することによってSAML IDプロバイダーに接続します。

### SAML認証要求に署名する

Auth0がSAML**サービスプロバイダー**の場合、Auth0がIdPに送信する認証要求に署名することができます。

1. Navigate to [Auth0 Dashboard > Authentication > Enterprise](https://manage.auth0.com/#/connections/enterprise), and select **SAML**.
2. Select the name of the connection to view.
3. Locate **Sign Request**, and enable its switch.
4. Download the certificate beneath the **Sign Request** switch, and provide it to the IdP so that it can validate the signature.

#### deflateエンコードの有効化/無効化

デフォルトでは、SAML認証要求はHTTPリダイレクト経由で送信され、deflateエンコードを使用します。これにより、署名がクエリパラメーターに配置されます。

To turn off deflate encoding, you can make a [PATCH call to the Management API's Update a Connection endpoint](https://auth0.com/docs/api/management/v2#!/Connections/patch_connections_by_id) and set the `deflate` option to `false`.

SAML IDプロバイダーとしてのAuth0

Endpoint: `https://{yourDomain}/api/v2/connections/{yourConnectionId}`

Payload:

```json lines
{
	{ 
		"options" : {
			[...], // all the other connection options
		  "deflate": false
	}
}
```



### デフォルトでは、Auth0はテナントの秘密鍵を使用してSAML要求に署名します（**Sign Request（要求に署名する）**トグルが有効になっている場合）。また、独自の秘密鍵/公開鍵のペアを指定して、特定の接続からの要求に署名することもできます。

次のコマンドを使用して、独自の証明書と秘密鍵を生成できます。

接続で要求に署名する際に使用するキーの変更は、Dashboard UIでは実行できないため、Management API v2の[「Update a Connection（接続の更新）」エンドポイント]()を使用し、以下のペイロード例に示すように、`options`オブジェクトに`signing_key`プロパティを追加する必要があります。

```bash wrap lines
openssl req -x509 -nodes -sha256 -days 3650 -newkey rsa:2048 -keyout private_key.key -out certificate.crt
```






Changing the key used to sign requests in the connection can't be done on the Dashboard UI, so you will have to use the [Update a Connection endpoint](https://auth0.com/docs/api/management/v2#!/Connections/patch_connections_by_id) from the <Tooltip tip="Management API: A product to allow customers to perform administrative tasks." cta="View Glossary" href="/docs/glossary?term=Management+API">Management API</Tooltip> v2, and add a `signing_key` property to the `options` object, as shown in the payload example below.

SAML IDプロバイダーとしてのAuth0

Endpoint: `https://{yourDomain}/api/v2/connections/{yourConnectionId}`

Payload:

```json lines
{
	{ 
		"options" : {
			[...], // all the other connection options
		  "signing_key": {
				"key":"-----BEGIN PRIVATE KEY-----\n...{your private key here}...\n-----END PRIVATE KEY-----",
				"cert":"-----BEGIN CERTIFICATE-----\n...{your public key cert here}...\n-----END CERTIFICATE-----"
			}
    }
	}
}
```


To learn how to get the private key and certificate formatted as a JSON string to use in the payload, see [Work with Certificates and Keys and Strings](/docs/authenticate/protocols/saml/saml-sso-integrations/work-with-certificates-and-keys-as-strings).

### IDプロバイダーから署名証明書を取得し、その証明書をIDプロバイダーからAuth0接続に読み込むことで、応答の署名を検証するようにAuth0を構成する必要があります。

Auth0はアサーション、応答、またはその両方に対して署名付き応答を受け入れることができます。

暗号化されたSAML認証アサーションを受信します

1. Navigate to [Auth0 Dashboard > Authentication > Enterprise](https://manage.auth0.com/#/connections/enterprise), and select **SAML**.
2. Select the name of the connection to view.
3. Locate **X509 Signing Certificate**, and upload the certificate.
4. Select **Save Changes**.

Auth0がSAMLサービスプロバイダーの場合、IDプロバイダーから暗号化されたアサーションを受信する必要がある場合があります。これを行うには、テナントの公開鍵証明書をIdPに提供する必要があります。IdPは公開鍵を使用してSAMLアサーションを暗号化し、それをAuth0に送信します。Auth0はテナントの秘密鍵を使用してそれを復号化します。

### 次のリンクを使用して、異なる形式で公開鍵を取得してください。

[raw PEM]()

[PKCS#7]()

* [CER](https://YOUR_AUTH0_domain/cer?cert=connection)
* [PEM](https://YOUR_AUTH0_domain/pem?cert=connection)
* [raw PEM](https://YOUR_AUTH0_domain/rawpem?cert=connection)
* [PKCS#7](https://YOUR_AUTH0_domain/pb7?cert=connection)
* [Fingerprint](https://YOUR_AUTH0_domain/fingerprint?cert=connection)

上記のように、Auth0はデフォルトでテナントの秘密鍵/公開鍵のペアを使用して暗号化を処理します。高度なシナリオで必要な場合は、独自の秘密鍵/公開鍵のペアを指定することもできます。

### 接続で要求の暗号化と復号化に使用されるキーペアをダッシュボードUIで変更することはできません。そのため、次のペイロードの例に示すように、Management API v2の[Update a Connection（接続の更新）エンドポイント]()を使用し、`decryptionKey`プロパティを`options`オブジェクトに追加する必要があります。

接続の`options`オブジェクトを更新すると、`options`オブジェクト全体がオーバーライドされます。以前の接続オプションを保持するには、既存の`options`オブジェクトを取得し、新しいキー/値を追加します。

Changing the key pair used to encrypt and decrypt requests in the connection can't be done on the Dashboard UI, so you will have to use the [Update a Connection endpoint](https://auth0.com/docs/api/management/v2#!/Connections/patch_connections_by_id) from the Management API v2, and add a `decryptionKey` property to the `options` object, as shown in the payload example below.

SAML IDプロバイダーとしてのAuth0

Endpoint: `https://{yourDomain}/api/v2/connections/{yourConnectionId}`

Payload:

```json lines
{
	{ 
		"options" : {
			[...], // all the other connection options
		  "decryptionKey": {
				"key":"-----BEGIN PRIVATE KEY-----\n...{your private key here}...\n-----END PRIVATE KEY-----",
				"cert":"-----BEGIN CERTIFICATE-----\n...{your public key cert here}...\n-----END CERTIFICATE-----"
			}
	}
}
```






SAML応答/アサーションに署名する

## Auth0がSAML IDプロバイダーである場合、テナントの秘密鍵を使用してSAMLアサーションに署名し、署名の検証に必要な公開鍵/証明書をサービスプロバイダーに提供します。

SAMLアサーションに署名するには：

### デフォルトでは、Auth0は応答内でSAML**アサーション**に署名します。SAML**応答**に署名するには：

SAML応答の署名鍵を変更する

デフォルトでは、Auth0はSAML応答やアサーションに署名するためのテナントに割り当てられた秘密鍵/公開鍵のペアを使用します。非常に特殊なシナリオでは、独自のキーペアを提供する必要がある場合があります。次のようなルールでこれを行うことができます：

1. Go to [Auth0 Dashboard > Applications](https://manage.auth0.com/#/applications), and select the name of the application to view.
2. Scroll to the bottom of the **Settings** page, select **Show Advanced Settings**, and select the **Certificates** view.
3. Select **Download Certificate**, and select the format in which you'd like to receive your signing certificate.
4. Send your certificate to the service provider.

秘密鍵と証明書ファイルをルールで使用できる文字列に変換する方法については、「[証明書とキーと文字列の操作](/saml-configuration/saml-sso-integrations/work-with-certificates-and-keys-as-strings)」を参照してください。

1. Navigate to [Auth0 Dashboard > Applications](https://manage.auth0.com/#/applications), and select the name of the application to view.
2. Select the **Addons** view.
3. Select **SAML2 Web App** to view its settings, and locate the **Settings** code block.
4. Locate the **"****`signResponse"`** key. Uncomment it (or add it, if required), then set its value to `true` (the default value is `false`). The configuration should look like this:

   ```json lines
   {
     [...], // other settings
     "signResponse": true
   }
   ```


   

   

#### 署名付きSAML認証要求を受信する

Auth0がSAML IDプロバイダーの場合、サービスプロバイダーの秘密鍵で署名された要求を受信できます。Auth0は、公開鍵/証明書を使用して署名を検証します。

```javascript lines expandable
/**
* Handler that will be called during the execution of a PostLogin flow.
*
* @param {Event} event - Details about the user and the context in which they are logging in.
* @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
*/
exports.onExecutePostLogin = async (event, api) => {

    // replace with the ID of the application that has the SAML Web App Addon enabled
      // for which you want to change the signing key pair.
      const samlIdpClientId = 'YOUR_SAML_APP_CLIENT_ID';

    // only do this for the specific client ID.  If you have multiple IdPs that require 
    // custom certificates, you will have an "if" statement for each one.  
    if (event.client.client_id === samlIdpClientId) {

    // provide your own private key and certificate here  
    // see https://auth0.com/docs/authenticate/protocols/saml/saml-sso-integrations/work-with-certificates-and-keys-as-strings 
    // for formatting instructions basically you start with a PEM format certificate and
    // replace the line enedings with "\n"
    const signingCert = "-----BEGIN CERTIFICATE-----\nnMIIC8jCCAdqgAwIBAgIJObB6jmhG0QIEMA0GCSqGSIb3DQEBBQUAMCAxHjAcBgNV[..all the other lines..]-----END CERTIFICATE-----\n";
    const signingKey = "-----BEGIN PRIVATE KEY-----\nnMIIC8jCCAdqgAwIBAgIJObB6jmhG0QIEMA0GCSqGSIb3DQEBBQUAMCAxHjAcBgNV[..all the other lines..]-----END PRIVATE KEY-----\n";

    api.samlResponse.setCert(signingCert)    
    api.samlResponse.setKey(signingKey);

  }
  };
```






To learn how to turn the private key and certificate files into strings that you can use in a rule, see [Work with Certificates and Keys and Strings](/docs/authenticate/protocols/saml/saml-sso-integrations/work-with-certificates-and-keys-as-strings).

### 暗号化されたSAML認証アサーションを送信します

Auth0がSAML IDプロバイダーである場合は、[Actions](/actions)を使用して送信するSAMLアサーションを暗号化できます。

サービスプロバイダーから証明書と公開鍵を取得する必要があります。証明書のみを取得した場合は、`openssl`を使用して公開鍵を取得できます。証明書のファイル名が`certificate.pem`であると仮定すると、以下のように実行できます。

1. Download the service provider's certificate with the public key.
2. Navigate to [Auth0 Dashboard > Applications](https://manage.auth0.com/#/applications), and select the name of the application to view.
3. Select the **Addons** view.
4. Select **SAML2 Web App** to view its settings, and locate the **Settings** code block.
5. Locate the **"****`signingCert"`** key. Uncomment it (or add it, if required), then set its value to the certificate you downloaded from the service provider. The configuration should look like this:

   ```json lines
   {
     [...], // other settings
     "signingCert": "-----BEGIN CERTIFICATE-----\nMIIC8jCCAdqgAwIBAgIJObB6jmhG0QIEMA0GCSqGSIb3DQEBBQUAMCAxHjAcBgNV\n[..all the other lines..]-----END CERTIFICATE-----\n"
   }
   ```


   

   

### 証明書と公開鍵ファイルを取得したら、[それらを文字列に変換](/saml-configuration/saml-sso-integrations/work-with-certificates-and-keys-as-strings)してActionで使用する必要があります。Actionは次のようになります。

If Auth0 is the SAML identity provider, you can use [Actions](/docs/customize/actions) to encrypt the SAML assertions it sends.

アサーション暗号化には[AES256]()

`openssl x509 -in certificate.pem -pubkey -noout > public_key.pem`

Once you get the certificate and public key files, you must [turn them into strings](/docs/authenticate/protocols/saml/saml-sso-integrations/work-with-certificates-and-keys-as-strings) to use them in an Action. The Action will look like this:

```js lines
exports.onExecutePostLogin = async (event, api) => {

// this Action sets a specific public key to encrypt the SAML assertion generated from Auth0
  if (
    event.client.client_id ===
    "THE_CLIENT_ID_OF_THE_APP_WITH_THE_SAML_APP_ADDON"
  ) {
    const encryptionCert =
      "-----BEGIN CERTIFICATE-----\nnMIIC8jCCAdqgAwIBAgIJObB6jmhG0QIEMA0GCSqGSIb3DQEBBQUAMCAxHjAcBgNV[..all the other lines..]-----END CERTIFICATE-----\n";
    const encryptionPublicKey =
      "-----BEGIN PUBLIC KEY-----\nnMIIC8jCCAdqgAwIBAgIJObB6jmhG0QIEMA0GCSqGSIb3DQEBBQUAMCAxHjAcBgNV[..all the other lines..]-----END PUBLIC KEY-----\n";

    api.samlResponse.setEncryptionCert(encryptionCert);
    api.samlResponse.setEncryptionPublicKey(encryptionPublicKey);
  }
};
```






The following algorithms are used:

* [AES256](http://www.w3.org/2001/04/xmlenc#aes256-cbc) for assertion encryption
* [RSA-OAEP](http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p) (including MGF1 and SHA1) for key transport

## Learn more

* [Work with Certificates and Keys as Strings](/docs/authenticate/protocols/saml/saml-sso-integrations/work-with-certificates-and-keys-as-strings)