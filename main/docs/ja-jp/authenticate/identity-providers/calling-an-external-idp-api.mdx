---
og:description: Describes how to call an external Identity Provider API.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: IDプロバイダーAPIを呼び出す
og:url: https://auth0.com/docs/
permalink: calling-an-external-idp-api
title: IDプロバイダーAPIを呼び出す
twitter:description: Describes how to call an external Identity Provider API.
twitter:title: IDプロバイダーAPIを呼び出す
---

FacebookやGitHubなどの外部IDプロバイダー(IdP)でユーザーを正常に認証すると、多くの場合、IdPはAuth0に返すユーザープロファイルにアクセストークンを含めます。

このトークンを取得して使用し、IdPのAPIを呼び出すことができます。



これから説明する手順は、コードがバックエンドまたはフロントエンドのどちらで実行されるかによって異なります。

* コードがバックエンドで実行される場合、サーバーがシークレットを安全に保存できると想定できます(後でわかるように、バックエンドシナリオではシークレットを使用します)。その場合は、この記事の[［backend section（バックエンドのセクション）］](#from-the-backend)に進んでください。
* コードがフロントエンドで実行される場合(たとえば、SPA、ネイティブデスクトップ、モバイルアプリなど)、アプリは資格情報を安全に保持できないため、別のアプローチに従う必要があります。その場合は、この記事の[［frontend section（フロントエンド）］](#from-the-frontend)に進んでください。

## バックエンドから

ユーザーを認証すると、IdPは通常、Auth0に返すユーザープロファイルにアクセストークンを含めます。

セキュリティとコンプライアンス上の理由から、Auth0はこのトークンをユーザープロファイルの一部としてアプリに送信しません。これを取得するには、Auth0 Management APIにアクセスして、ユーザーの完全なプロファイルを取得する必要があります。

1. [［Auth0 Management API］](/api/management/v2)を呼び出すためのアクセストークンを取得します。
2. ステップ1で取得したアクセストークンを使用して、Auth0 Management APIの[［Get Users by ID endpoint（IDエンドポイントによるユーザー取得）］](/api/management/v2#!/Users/get_users_by_id)を呼び出します。このエンドポイントは、IdPアクセストークンを含む完全なユーザープロファイルを返します。
3. 応答からIdPアクセストークンを抽出し、それを使用してIdPのAPIを呼び出します。

### ステップ1:トークンを取得

[Management API](/api/management/v2)を呼び出すには、アクセストークンが必要です。

#### Management APIのテストアプリケーションを作成

[Management APIv2 Token](/api/management/v2/tokens)（Management APIv2トークン）を初めて要求する場合は、Management APIを呼び出すために使用できるアプリケーションを作成して構成する必要があります。

1. [［Auth0 Dashboard］>［Applications（アプリケーション）］>［API］](%24%7Bmanage_url%7D/#/apis)に移動して、[［Auth0 Management API］](%24%7Bmanage_url%7D/#/apis/management/authorized-clients)を選択します。
2. **［API Explorer（API エクスプローラー）］**ビューを選択し、**［Create & Authorize a Test Application（テストアプリケーションの作成と承認）］**をクリックします。

これにより、新しいアプリケーションが作成され、Management APIのすべてのスコープが付与されます。つまり、このアプリケーション用に生成されたトークンは、すべてのManagement APIエンドポイントにアクセスできるようになります。





[登録済みのAuth0 Management API](%24%7Bmanage_url%7D/#/apis/management/authorized-clients)からスコープを付与または削除するには、[**［Machine to Machine Applications（マシンツーマシンアプリケーション）］**ビュー](%24%7Bmanage_url%7D/#/apis/management/authorized-clients)を選択します。

#### Management APIトークンの取得

これで構成が完了し、Management APIトークンを取得する準備が整いました。

1. 登録済みの[Auth0 Management API](%24%7Bmanage_url%7D/#/apis/management/authorized-clients)から、[**［Test（テスト）］**ビュー](%24%7Bmanage_url%7D/#/apis/management/test)を選択します。
2. ドロップダウンから**［Application（アプリケーション）］**を選択し、カスタマイズされた変数を使用してすぐに使用できるスニペットを事前に設定します。
3. スニペットの優先言語を選択し、コピーして実行します。
4. 応答から`access_token`プロパティを抽出します。これは、Management APIにアクセスするために使用します。



#### トークンの有効期限

デフォルトでは、受け取ったトークンの有効期限は24時間（86,400秒）です。これを変更するには、

1. [［Auth0 Dashboard］>［Applications（アプリケーション）］>［API］](%24%7Bmanage_url%7D/#/apis)に移動して、[［Auth0 Management API］](%24%7Bmanage_url%7D/#/apis/management/authorized-clients)を選択します。
2. **［Settings（設定）］**ビューを選択し、**［Token Expiration (Seconds)（トークンの有効期限(秒)）］**フィールドを見つけて新しい値を入力し、**［Save（保存）］**をクリックします。設定できる最大値は2,592,000秒(30日)ですが、デフォルト値のままにしておくことをお勧めします。

次に生成するトークンでは、更新された有効期限が使用されます。



### ステップ2:完全なユーザープロファイルの取得

ユーザーのプロファイルを取得するには、前のセクションで抽出したアクセストークンを使用して、Management APIの[［Get a User endpoint（ユーザーエンドポイントの取得）］](/api/management/v2#!/Users/get_users_by_id)を呼び出します。



次の値を置き換えます:

* `{userId}`:IdPのAPIを呼び出すユーザーのID。
* `{yourAccessToken}`:前のセクションで抽出したアクセストークン。



### ステップ3:IdPアクセストークンの抽出

IdPのAPIを呼び出すために使用されるアクセストークンは、ユーザーの`ID`配列内にあります。`user.identities[0].access_token`.



ほとんどの場合、ユーザーのIDは1つだけですが、ユーザーが異なる接続を使用して複数回サインインしていて、[［account linking（アカウントのリンク）］](/users/user-account-linking/link-user-accounts)を使用している場合は、複数のIDが存在する可能性があります。

このサンプル応答では、ユーザーのIDが1つだけであることがわかります。`google-oauth2`。



これで、IdPのAPIを呼び出す準備ができました。その方法の詳細については、IdPのドキュメントを参照してください。





## フロントエンドから

パブリックアプリケーション(SPA、ネイティブデスクトップ、またはモバイルアプリケーション)を使用している場合は、ここを参照してください。

フロントエンドアプリを使用する場合、フロントエンドアプリは**資格情報を安全に保持できない**パブリックアプリケーションであるため、IdP APIを呼び出すプロセスはバックエンドプロセスとは異なります。SPAコードは表示および変更でき、ネイティブ/モバイルアプリは逆コンパイルおよび検査できるため、秘密鍵やパスワードなどの機密情報を保持することはできません。

具体的には、バックエンドプロセスの最初のステップで`/oauth/token`を呼び出すために使用するマシンツーマシンアプリケーションの**［Client Secret（クライアントシークレット）］**を安全に保持できません。

代わりに、バックエンドのプロキシを構築し、それをAPIとしてアプリケーションに公開する必要があります。

### プロキシの構築

まず、この記事の[backend section](#from-the-backend)（バックエンド）セクションに記載されている手順を実装するプロセスをバックエンドに構築し、それをAPIとしてアプリケーションに公開します。

IdPのAPIは同じバックエンドプロセスから呼び出すため、アクセストークンはパブリックアプリケーションに公開されません。

次に、[Authorization Code Flow with Proof Key for Code Exchange (PKCE)](/login/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce)（コード交換用の証明キー(PKCE)を使用した認可コードフロー）を使用して、パブリックアプリケーションからプロキシAPIを呼び出します。