---
og:description: Describes migration from Legacy namespaced claims to custom claims.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: カスタムクレームの移行
og:url: https://auth0.com/docs/
permalink: custom-claims-migration
title: カスタムクレームの移行
twitter:description: Describes migration from Legacy namespaced claims to custom claims.
twitter:title: カスタムクレームの移行
---

Auth0では、2022年7月28日より、名前空間のないプライベートのカスタムクレームをアクセストークンとIDトークンに追加できるようになりました。これらのクレームは、[`/userinfo`エンドポイント](https://auth0.com/docs/api/authentication#get-user-info)の応答にも追加されます。JWTクレームのタイプについては、「[JSON Web Tokenクレーム](/security/tokens/json-web-tokens/json-web-token-claims)」をお読みください。



#### 例

これまでAuth0では、名前空間のあるクレームしかアクセストークンとIDトークンに許可されていませんでした。カスタムクレームへの本移行により、今後は名前空間のないクレームをAuth0のAuthentication APIのアクセストークン、IDトークン、および`/userinfo`エンドポイントで使用できます。



## 影響を受けるフロー

Auth0がサポートするすべてのOpenID Connect（OIDC）フローがこの移行の影響を受けます。フローの一覧は、「[認証および認可のフロー](/login/flows)」でお読みください。

次の機能も影響を受けます。

* [ネイティブソーシャルログイン](/login/flows)
* [リフレッシュトークン](/security/tokens/refresh-tokens)

次の機能は、[Auth0 Rules](/rules)および属性マッピングと併用する場合にのみ影響を受けます。

* [Web Services Federation（WS-Fed）プロトコル](/protocols/ws-fed-protocol)
* [SAML2 Webアプリアドオン](/saml-configuration/saml-sso-integrations/enable-saml2-web-app-addon)

## 制限

### トークンサイズの上限

カスタムクレームのペイロードを最大100KBに制限します。認証トランザクションがエラーで失敗しないよう、ペイロードがこの上限を超えないようにすることが大切です。拡張コード（[Rules](/rules)、[Hooks](/hooks)または[Actions](/actions)）の使用を確認することを推奨します。特に、外部APIからの大きなペイロードを確認してください。

エラーを防ぐため、Auth0ではアプリケーションの操作に必要な最小限のトークンペイロードを使用することを推奨しています。カスタムクレーム値を設定する前に、重要でないプロパティをすべて削除しなければならない場合があります。



100KBの制限は、アクセストークンとIDトークンにそれぞれ個別に適用されます。たとえば、同じトランザクションで100KBのアクセストークンと100KBのIDトークンを返すことが可能です。

#### 例







### 予約済みのクレーム

Auth0は、OIDC標準やOAuth2標準で使用されるクレーム、または内部で使用するクレームのカスタマイズを制限します。そのため、これらのクレームを変更する試みはすべて無視されます。トランザクションは失敗しませんが、当該クレームがトークンに追加されることはありません。Auth0では、パブリックの、名前空間のあるクレームの使用を推奨しています。



#### 例



### トークンオーディエンスの制限

Auth0では、オーディエンスがAuth0 APIであるアクセストークンでの、プライベートで名前空間のないカスタムクレームの作成を制限します。オーディエンスがAuth0 APIであるアクセストークンでプライベートの名前空間のないカスタムクレームを設定する試みは、すべて無視されます。トランザクションは失敗しませんが、当該クレームがトークンに追加されることはありません。Auth0では、Auth0のAPIによって使用されるトークンにカスタムクレームを設定しないことを推奨しています。



次のオーディエンスは、プライベートで名前空間のないカスタムクレームの作成を制限します。

* `https://YOUR_TENANT.auth0.com/api`または`https://YOUR_TENANT.auth0app.com/api`
* `https://YOUR_TENANT.auth0.com/api/v2`または`https://YOUR_TENANT.auth0app.com/api/v2`
* `https://YOUR_TENANT.auth0.com/mfa`または`https://YOUR_TENANT.auth0app.com/mfa`

この制限の例外は、Auth0の`/userinfo`オーディエンスです。プライベートで名前空間のないカスタムクレームは、次のオーディエンスで許可されています。

* `https://YOUR_TENANT.auth0.com/userinfo`
* `https://YOUR_TENANT.auth0app.com/userinfo`

#### 例



以下の例は、オーディエンスがAuth0 APIでない場合に返されるカスタムクレーム付きの応答を示しています。





以下の例は、Auth0 APIオーディエンスで返される、カスタムクレームが追加されていない応答を示しています。





## Auth0とWebtaskの名前空間の制約

Auth0では、Auth0ドメインを名前空間識別子として使用した、名前空間ありのカスタムクレームの作成を制限します。Auth0ドメインは以下の通りです。

* auth0.com
* webtask.io
* webtask.run

上記のいずれかの識別子を使用してトークンに名前空間のあるカスタムクレームを設定しようとする試みは、すべて無視されます。トランザクションは失敗しませんが、当該クレームがトークンに追加されることはありません。





### OIDCユーザープロファイルクレーム

Auth0では、OIDCユーザープロファイルクレームをアクセストークンに追加できるようになりました。

この移行前は、OIDCユーザープロファイルクレームをアクセストークンに追加する試みは、サイレントに無視されていました。しかし、更新後の動作では、アクセストークンにこれらのOIDCユーザープロファイルクレームを含むことができます。



次のOIDCユーザープロファイルクレームをアクセストークンに追加できます。



#### 例



### Auth0 Rulesを使用したSAML2アドオンおよびWebサービスフェデレーション（WS-Fed）プロトコルの属性マッピング

Auth0 Rulesを使用してユーザーオブジェクトに変更を加える場合と同様に、`app_metadata`または`user_metadata`の移行前のクレームもまた、クレームが`context.idToken`オブジェクトに設定され、名前が衝突するときに、コンテンツを結合します。オブジェクトプロパティの詳細については、「[Rulesのユーザーオブジェクトプロパティ](https://auth0.com/docs/customize/rules/user-object-in-rules)」をお読みください。

ただし、カスタムクレームを使用する場合、Auth0は`context.idToken`オブジェクトに設定されたクレームを優先します。

この変更は、`context.id_token`経由で`app_metadata`および`user_metadata`を設定する（それらにオブジェクトを割り当てる）と同時に、SAMLアドオンまたはWebサービスフェデレーション（WS-Fed）プロトコルの属性マッピングでこれらのフィールドを使用するAuth0 Rulesに影響を与えます。

例1：Auth0は、`context.idToken.app_metadata`が空のオブジェクトで設定されている場合に属性マッピングを無視します。



この移行前のSAML応答：



アップグレード後の動作のSAML応答：



例2：`context.id_token`内の`app_metadata`のバージョンが優先されます。



この移行前のSAML応答：



アップグレード後の動作のSAML応答：



### プライベートで名前空間のないクレームをトークンに追加する



プライベートで名前空間のないカスタムクレームをアクセストークンおよびIDトークンのペイロードに追加できるようになりました。

#### 例



### /userinfoへのプライベートで名前空間のないクレーム

Auth0では、IDトークンに設定されている場合、/userinfo応答でプライベートの名前空間のないカスタムクレームを返すようになりました。

#### 例







## アクション

### テナントログを確認する

まず、テナントログで廃止の通知を確認して、テナントが移行の影響を受けるかどうかを判断します。

1. [［Auth0 Dashboard］>［Monitoring（モニタリング）］>［Logs（ログ）］](https://manage.auth0.com/#/logs)に移動します。
2. `type: depnote AND description:*Custom*claims*`のログを検索します。

### 例

以下は、拡張コードがトリガーされるたびに生成される廃止ログの例です。



### SAML2アドオンとWebサービスフェデレーション（WS-Fed）プロトコルのAuth0ルールを修正する

Auth0 Rulesと属性マッピングを使用したSAML2アドオンおよびWebサービスフェデレーション（WS-Fed）プロトコルを使って、`context.idToken`オブジェクトに`app_metadata`または`user_metadata`クレームを設定する場合、構成を更新して、Auth0がこれらのオブジェクト間の衝突するクレーム名を評価する方法を調整する必要があります。修正方法にはいくつかあります。

* Auth0ルールのコードが常に`context.id_token`に設定されたオブジェクトのコンテンツを優先するようにします。
* SAML2アドオンまたはWebサービスフェデレーション（WS-Fed）プロトコルの属性マッピングを使用する場合は、`app_metadata`または`user_metadata`クレームを`context.idToken`オブジェクトに設定しないようにします。可能な場合は、これらのクレームを名前空間のあるクレームに置き換えます。
* プロトコルが`samlp`または`wsfed`の場合、現在のプロトコルまたは現在のクライアントで条件を使用して、`app_metadata`または`user_metadata`を設定するステートメントを除外します。

### レガシーの動作を無効にする





1. [［Auth0 Dashboard］>［Tenant Settings（テナント設定）］>［Advanced（詳細設定）］](https://manage.auth0.com/dashboard/#/tenant/advanced)に移動して、**［Migrations（移行）］**を探します。
2. トグルで**［Custom claims must be namespaced（カスタムクレームは名前空間ありでなければならない）］**を無効にします。