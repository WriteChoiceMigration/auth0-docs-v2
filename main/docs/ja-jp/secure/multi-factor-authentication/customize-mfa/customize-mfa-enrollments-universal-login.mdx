---
og:description: Customize MFA flows using post-login Actions to prompt users to enroll
  in specific factors.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: ユニバーサルログインに対するMFA登録をカスタイズする
og:url: https://auth0.com/docs/
permalink: customize-mfa-enrollments-universal-login
title: ユニバーサルログインに対するMFA登録をカスタイズする
twitter:description: Customize MFA flows using post-login Actions to prompt users
  to enroll in specific factors.
twitter:title: ユニバーサルログインに対するMFA登録をカスタイズする
---

Auth0 supports a variety of factors for securing user access with [multi-factor authentication (MFA](/docs/secure/multi-factor-authentication/multi-factor-authentication-factors)). Using `post-login` Actions, you can customize your <Tooltip tip="Multi-factor authentication (MFA): User authentication process that uses a factor in addition to username and password such as a code via SMS." cta="View Glossary" href="/docs/glossary?term=MFA">MFA</Tooltip> flows to prompt users to enroll in specific factors. After a user enrolls in a factor, they can use that factor as a secondary method of authentication in future logins.

コンテキスト情報を使用して、MFA登録フローをさらにカスタマイズすることもできます。たとえば、あるアプリケーションではSMSに登録するようユーザーに促し、別のアプリケーションではプッシュ通知またはWebAuthNに登録するようユーザーに促すことができます。

This feature allows you to customize your MFA enrollment flows. If you want to customize MFA flows for users who are already enrolled, review [Customize MFA Selection for Universal Login](/docs/secure/multi-factor-authentication/customize-mfa/customize-mfa-selection-universal-login).

## 仕組み

You can use [Actions](/docs/customize/actions) to customize your MFA enrollment flows. Specifically, you can modify the `post-login` trigger of the [Login Flow](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger) with the following Authentication API methods:

* `enrollWithAny`：登録時にユーザーが選択できる要素のセットを指定します。デフォルトでは、このメソッドは、ユーザーが希望する要素を選択できる選択プロンプトを表示します。場合によっては、ユーザーエクスペリエンスが異なる場合があります。
* 複数の要素が指定された場合、選択プロンプトがユーザーに表示されます。

  + ユーザーが1つを除く他のすべての指定された要素で登録済みの場合は、選択プロンプトはスキップされ、ユーザーは残りのファクターで登録するように促されます。
  + ユーザーがすべての指定された要素で登録済みの場合は、コマンドは失敗し、ログインシーケンスは継続します。
  + これらのメソッドを組み合わせて、MFA登録フローをカスタマイズできます。ロールや最後にログインした日付などのユーザーメタデータを組み込んで、よりカスタマイズされたエクスペリエンスを作成することもできます。

カスタマイズされた登録フローは次の要素をサポートします。

`recovery-code`

* `recovery-code`
* `push-notification`
* `preferredMethod: voice`
* `preferredMethod: voice`

  + `preferredMethod: both`
  + `preferredMethod: both`
  + ユーザーが要素で登録した後、その値は`enrolledFactors`に追加されます。このプロパティは、ユーザーアカウントに関連したアクティブ要素のリストを示します。
* ユーザーが要素で登録した後、その値は`enrolledFactors`に追加されます。このプロパティは、ユーザーアカウントに関連したアクティブ要素のリストを示します。
* ユーザーが要素で登録した後、その値は`enrolledFactors`に追加されます。このプロパティは、ユーザーアカウントに関連したアクティブ要素のリストを示します。

メソッド名が`mfa`に設定されている場合、配列`event.authentication.methods`には`type`フィールドが含まれます。このフィールドには、`enrolledFactors`の`type`フィールドで使用されるものと一致する因子値（文字列）が含まれます。

MFA登録が発生すると、`methods `には`name:mfa`のオブジェクトが含まれ、 `type`がそのイベントに使用される要素に設定されます。`methods`と`enrolledFactors`はアクションが最初に開始されたときにのみ更新されます。フローの次のアクションで登録イベントの結果にアクセスできます。

詳しくは、以下のリソースをご確認ください:

[アクションのトリガー：ログイン後 - イベントオブジェクト](/signup-and-login-triggers/login-trigger/post-login-event-object)

* [Actions Triggers: post-login - Event Object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-event-object)
* [Actions Triggers: post-login - API Object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-api-object)

### `enrollWith`コマンドは、初期またはデフォルトの要素と代替のリストをサポートします。ユーザーはコマンドごとに1つの要素のみを登録できます。

`enrollWithAny`コマンドは要素のリストをサポートします。指定された要素の順序によって、リストがユーザーにどのように表示されるかが決まります。ユーザーはコマンドごとに1つの要素のみを登録できます。

* The `enrollWith` command supports an initial or default factor and a list of alternatives. Users can only enroll in one factor per command.
* **シーケンス化されたフロー**：ユーザーに対して、特定の順序に並べた、一連の要素で登録します。

**コンテキストに基づくフロー**：フロー内での以前のコマンドに基づいて、どの要素でユーザーに促すかを決定します。

* これらのフローを説明するために、次の例を考えてみましょう:
* これら2つのアクションを組み合わせると、管理者ロールを**持たない**ユーザーがワンタイムパスワード（OTP）またはセキュリティ キーのいずれかを使用して登録する必要があるシナリオが作成されます。逆に、管理者ロールを**持つ**ユーザーは、両方の要素に登録する必要があります。

アクション1は、`app_metadata`を確認してユーザーが管理者であるかどうかを判断し、特定の要素に登録するようユーザーに促します。管理者ユーザーがOTPのみに登録している場合は、最初にOTPを入力して認証を完了する必要があります。次に、セキュリティキー（`webauthn-roaming`）を使用して登録するように促されます。

```javascript lines expandable
// Action 1

exports.onExecutePostLogin = async (event, api) => {
  if (event.user.enrolledFactors.length) {
    // already enrolled, challenge
    api.authentication.challengeWithAny(event.user.enrolledFactors.map(m => ({type: m.type})));
    if (event.user.app_metadata.isAdmin &&
        !event.user.enrolledFactors.some(m => m.type === 'webauthn-roaming')) {
          // if is admin and doesn't have a security key, meaning a different factor was used, enroll now
          api.authentication.enrollWith({type: 'webauthn-roaming'})
        }
  }
  else {
    // not enrolled; choose a factor to enroll now
    api.authentication.enrollWithAny([{type: 'webauthn-roaming'}, {type: 'otp'}]);
    if (event.user.app_metadata.isAdmin) {
      // one more factor for admins
      api.authentication.enrollWithAny([{type: 'webauthn-roaming'}, {type: 'otp'}]);
    }
  }
};

// Action 2

exports.onExecutePostLogin = async (event, api) => {
  function performed(type) {
    return event.authentication.methods.some(m => m.name === 'mfa' &&
           m.type === type &&
           Date.now() - new Date(m.timestamp).getTime() < 5000)
  }
  if (event.user.app_metadata.isAdmin) {
      // enforce both factors are used by challenging the one that has not been used yet
      if (!performed('webauthn-roaming')) {
        api.authentication.challengeWith({type: 'webauthn-roaming'})
      }
      else if (!performed('otp')) {
        api.authentication.challengeWith({type: 'otp'})
      }
  }
};
```






アクション1の実行後、フローは一時停止し、アクション2の実行時に`event.user.enrolledFactors`と`event.authentication.methods`の両方が更新されます。これにより、ユーザーにさまざまな要素に異議を申し立てるか登録するかの選択肢が与えられたときに、アクションコードは実際のユーザーデータに基づいて決定を下すことができます。

**注意**：アクションを実行するこの方法は、`enrollWith`または`enrollWithAny`コマンドを含むものにしか適用されません。その他の目的を果たすアクションに影響はありません。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

To keep user accounts secure, users must complete an MFA challenge using one of their existing enrolledFactors before they can enroll in additional factors. This condition ensures you can safely implement a custom MFA enrollment policy after an application with different factors and configurations has already been used.

</Callout>

開始する前に

MFAフローをカスタマイズする前に、テナントでMFAをセットアップし、アクション設定を使用して、MFA要素のカスタマイズを有効にします。［Auth0 Dashboard（Auth0ダッシュボード）］の[［Security（セキュリティ）］>［Multi-factor Auth（多要素認証Auth）］]()から、1つ以上の要素を設定し、MFAポリシーを定義することができます。

## 設定プロセスについての詳細は、「[多要素認証を有効にする](/mfa/enable-mfa)」をご覧ください。

Before you can customize your MFA flows, you must set up MFA in your tenant and enable the Customize MFA Factors using Actions setting. You can enable one or more factors and define your MFA policies on your <Tooltip tip="Auth0 Dashboard: Auth0's main product to configure your services." cta="View Glossary" href="/docs/glossary?term=Auth0+Dashboard">Auth0 Dashboard</Tooltip> under [Security > Multi-factor Auth](https://manage.auth0.com/#/security/mfa).

* To learn more about the setup process, review [Enable Multi-Factor Authentication](/docs/secure/multi-factor-authentication/enable-mfa).
* For information about configuring specific factors, review [Multi-factor Authentication Factors](/docs/secure/multi-factor-authentication/multi-factor-authentication-factors).

MFA登録フローをカスタマイズする

<Frame>![Auth0 Dashboard > Security > Multi-factor Auth > Additional Settings](/images/cdy7uua7fh8z/2hv0ELTkkka3t230SXfxw/46def5395652b2451cfc9e0ad01a371a/MFA_actions.png)</Frame>

テナントにMFAを設定した跡、`ログイン後`のアクションを作成してMFA登録フローをカスタマイズできます。

## ポストログインアクションを作成する

アクションをAuth0 Dashboardで作成できます。

<Warning>

Actions (or series of Actions) in a tenant can only execute **four** of the following commands per user flow:

* `enrollWith`
* `enrollWithAny`
* `challengeWith`
* `challengeWithAny`

If this limit is exceeded (i.e., a fifth command of this type attempts to execute), an authentication error will occur.

</Warning>

### アクションの名前を入力します。

トリガーとして、 **ログイン/ポストログイン**を選択します。

1. Navigate to [Actions > Flows](https://manage.auth0.com/#/actions/flows) and select **Login**.
2. In the Add Action panel, select the **plus sign (+)** icon and choose **Build from scratch**.
3. On the Create Action popup:

   * ランタイムには、**Node 18（推奨）**を使用します。
   * **注意**：通知が閉じられている場合、コードエディターの上の**［Back to Flow（フローに戻る）］**を選択します。
   * 保存後に追加の変更を行う場合、[［Actions（アクション）］>［Library（ライブラリ）］>［Custom（カスタム）］]()に移動し、アクションを選択します。その後、必要な時にコードの更新と再導入ができます。
4. Review the popup to ensure accuracy. Then, select **Create**.
5. In the code editor, add your custom code to the `onPostExecute` command.
6. When your command is ready, select **Deploy**.
7. Select **Add to Flow** on the successful deployment notification.

   * ポストログインアクションをテストする
8. Drag and drop your new command from the Add Action panel into your Login flow. Then, select **Apply**.

To make additional changes after saving, navigate to [Actions > Library > Custom](https://manage.auth0.com/#/actions/library) and select your Action. You can then update and redeploy your code as needed.

### フローが成功したら、確認画面が表示されます。問題が生じたら,、Auth0 Dashboardの[［Actions（アクション）］>［Library（ライブラリ）］>［Custom（カスタム）］]()に移動し、コードを更新することができます。

ユースケースの例

1. Navigate to [Authentication > Authentication Profile](https://manage.auth0.com/#/authentication-profiles).
2. Select **Try** to open a sample login prompt in a new tab.
3. Enter your credentials and test your new MFA flow.

If the flow is successful, a confirmation screen displays. If you encounter any issues, you can update your code by navigating to [Actions > Library > Custom](https://manage.auth0.com/#/actions/library) in your Auth0 Dashboard.

## 登録に対してMFAオプションでユーザーを促す

次のサンプルでは、デフォルトで、OTPでユーザーにチャレンジを行います。必要であれば、ユーザーは「他の方法を試す」リンクにアクセスし、代わりにメールで認証することができます。

### トラブルシューティング

カスタマイズされたMFA登録でエラーや予期しない結果が発生した場合は、以下の情報を使用して問題を特定し解決するのに役立ててください。

## テナントログ

テナントログは、Auth0 Dashboardの[［Monitoring（モニタリング）］>［Logs（ログ）］]()から利用可能です。その他に、[Management API](/api/management/v2/introduction)を使用して、ログを取得します。

### 予期しない動作が発生した場合は、次のイベントコードのテナントログを確認して、詳細情報を得てください。

You can monitor your customized MFA enrollments through [tenant logs](/docs/deploy-monitor/logs).

Tenant logs are available in the Auth0 Dashboard under [Monitoring > Logs](https://manage.auth0.com/#/logs). Alternatively, you can retrieve logs using the [Management API](https://auth0.com/docs/api/management/v2/introduction).

[［Auth0 Dashboard（Auth0ダッシュボード）］>［Security（セキュリティ）］>［Multi-factor Auth（多要素認証）］]()に移動し、［追加設定］セクションのトグルが有効になっていることを確認してください。

<table class="table"><thead>
<tr>
<th>Scenario</th>
<th>Event</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>A user is prompted to enroll with a specific factor. However, the requested factor meets one of the following conditions:<br/><ul><li>The factor is not enabled in your tenant.</li><li>The factor is not supported by the user's browser.</li><li>The user has already enrolled in the requested factor.</li></ul>In this scenario, the user can complete the flow if alternative factors are available.</td>
<td>w</td>
<td>An MFA enrollment is used in a PostLogin action, but the requested factor ${factor.name} is not properly set up. Enable the requested factor and ensure the user is not already enrolled with it.</td>
</tr>
<tr>
<td>A user is prompted to enroll with one or more factors, but the supplied factors cannot be used for enrollment. In this case, the user cannot complete the flow.</td>
<td>mfar</td>
<td>An MFA enrollment is used in a PostLogin action but the requested factors are not properly set up. To perform MFA, enable the requested factors and ensure the user is not already enrolled with them.</td>
</tr>
<tr>
<td>A user attempts to enroll in a new factor without completing at least one challenge using an existing enrollment.</td>
<td>mfar</td>
<td>An MFA enrollment was requested but the user is already enrolled in MFA. Challenge with at least one existing factor before enrolling a new one.</td>
</tr>
</tbody>
</table>

### **コードを確認する**:[［Auth0 Dashboard（Auth0ダッシュボード）］>［Actions（アクション）］>［Library（ライブラリ）］>［Custom（カスタム）］]()に移動し、アクションコードを確認します。参照されたすべての要素が、ユースケースに適用可能であることを確認してください。

**要素を確認する**:[［Auth0 Dashboard（Auth0ダッシュボード）］>［Security（セキュリティ）］>［Multi-factor Auth（多要素認証）］]()に移動し、アクションで参照されたすべての要素が有効になっていることを確認してください。

1. The **Customize MFA factors with Actions** toggle must be enabled.

   * Navigate to [Auth0 Dashboard > Security > Multi-factor Auth](https://manage.auth0.com/#/security/mfa) and ensure the toggle in the Additional Settings section is enabled.
2. Factors referenced in your Actions must be enabled in your tenant.

   * **Review your code**: Navigate to [Auth0 Dashboard > Actions > Library > Custom](https://manage.auth0.com/#/actions/library) and review your Actions code. Ensure all factors referenced are applicable to your use cases.
   * **Review your factors**: Navigate to [Auth0 Dashboard > Security > Multi-factor Auth](https://manage.auth0.com/#/security/mfa) and ensure all factors referenced in your Actions are enabled.
3. Ensure your Actions have been deployed and saved in your Pipeline.

   1. Navigate to [Auth0 Dashboard > Actions > Library > Custom](https://manage.auth0.com/#/actions/library). Locate your Action in the list and ensure its status is **Deployed**. If a different status is listed, access your Action, review your code, and click **Deploy** to the top right.
   2. Navigate to [Auth0 Dashboard > Actions > Library > Flows](https://manage.auth0.com/#/actions/flows) and select **Login**. Ensure your Action is listed in the flow. If not, access the **Custom tab** of the Add Action panel and drag and drop your Action into your Login flow. Then, select **Apply**.
4. Ensure you've upgraded to the latest version of `post-login` Actions.

   * Navigate to [Auth0 Dashboard > Actions > Library > Custom](https://manage.auth0.com/#/actions/library) and select your Action. If your Action is out-of-date, you will see a yellow banner prompting you to update the Action. If the banner displays, select **Update**.
   * You can also specify the latest version of `post-login` Actions for deployment when using the Deploy CLI. For more information, review [Configure the Deploy CLI](/docs/deploy-monitor/deploy-cli-tool/configure-the-deploy-cli).