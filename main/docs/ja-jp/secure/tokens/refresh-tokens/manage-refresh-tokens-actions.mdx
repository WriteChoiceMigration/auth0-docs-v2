---
og:description: Learn about managing Refresh Tokens with Actions
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: アクションを使用したリフレッシュトークン
og:url: https://auth0.com/docs/
permalink: manage-refresh-tokens-actions
title: アクションを使用したリフレッシュトークン
twitter:description: Learn about managing Refresh Tokens with Actions
twitter:title: アクションを使用したリフレッシュトークン
---



リフレッシュトークンに[アクション](/actions)を使用すると、認証後のリスク検出と応答機能を構成して、アプリケーションとユーザーを侵害されたリフレッシュトークンから保護することができます。[リフレッシュトークンの有効期限](/security/tokens/refresh-tokens/configure-refresh-token-expiration)を動的にカスタマイズすることもできます。

* **event.refresh_token**：`creation`、`expiry dates`、`associated clients`、`resource servers`、`device`のコンテキストなどの関連情報と、ブラウザーベースのフローに`session_id`を提供します。
* **api.refreshToken**：セッションを取り消すか、有効期限日を変更することで、既存のリフレッシュトークンを管理することができます。

これを容易にするために、ログイン後のアクションには以下の2つの重要なオブジェクトがあります。

event.refresh_tokenとapi.refreshTokenオブジェクトは両方とも、[リフレッシュトークンの交換トランザクション](/security/tokens/refresh-tokens/use-refresh-token-rotation)に対応しています。

`event.refresh_token`オブジェクトを使用すると、`last_exchange_at`プロパティを確認し、現在のトランザクションに関してリスクを評価することができます。`event.refresh_token`オブジェクトを`event.authentication`など、他のイベントオブジェクトと組み合わせることもできます。

* [イベントオブジェクト](/signup-and-login-triggers/login-trigger/post-login-event-object)：フレッシュトークンのイベントオブジェクトとプロパティについて説明します。
* [APIオブジェクト](/signup-and-login-triggers/login-trigger/post-login-api-object)：フレッシュトークンのAPIオブジェクトとメソッドについて説明します。

## アクションでリフレッシュトークンを取り消す

`api.refreshToken`オブジェクトを使用して、既存のリフレッシュトークンの有効期限日をリセットするか、リフレッシュトークンを取り消すことができます。

これらのオブジェクトの詳細については、以下をご確認ください。

### イベントログの取り消しを監視する

ポストログインの**api.refreshToken.revoke(reason)**メソッドを使用すると、トランザクションに関したリスクに対処することができます。このメソッドでは以下を行うことができます。



取り消し操作を行うと、[テナントログ](/logs)に以下のログイベントが追加されます。

## アクションでリフレッシュトークンの有効期限日を変更する

リフレッシュトークンの取り消しを示す`srrt`イベントコード

* Auth0で現在のリフレッシュトークンのトランザクションを無効にする
* 403 HTTPステータスコードを返して、現在のトランザクションを拒否する

リフレッシュトークンが以前に認証されたセッションにバインドされている場合、ログには、`session_id`属性に認証済みセッションへの参照が含まれます。

* **api.refreshToken.setExpiresAt(Date)**は、特定のリフレッシュトークンに新しい絶対ライフタイムを定義できるようにします。
* **api.refreshToken.setIdleExpiresAt(Date)**は、特定のリフレッシュトークンに新しい非アクティブタイムアウトを設定できるようにします。
* 特定ユーザーのグループメンバーシップまたはプロファイル
* リスク評価
* アクションの実行中に使用できる他の動的条件

リフレッシュトークンの有効期限日を変更するには、以下のポストログインメソッドを使用します。

## 制限事項

これらのメソッドを使用すると、以下を基に、リフレッシュトークンのライフタイムと非アクティブポリシーを動的にカスタマイズすることができます。



2023年9月21日以降に発行されたリフレッシュトークン（US-3リ－ジョンのテナントの場合は2024年2月22日）には、適切な値を持つセッションID（`session_id`）プロパティが含まれます。この日付よりも前に発行されたリフレッシュトークンには、`null`値を持つこのプロパティが含まれます。

ポストログインAPIメソッドの`api.refreshToken.revoke(reason)`がリリースされる前に発行されたリフレッシュトークンには、`event.refresh_token.device`情報は含まれません。

## ユースケース：リフレッシュトークンを取り消す

無期限のリフレッシュトークンや未交換のリフレッシュトークンには、`event.refresh_token.last_exchanged_at`プロパティは含まれません。

### ImpossibleTravelによるトークンの取り消し

セキュリティ上の理由から、非アクティブタイムアウトと絶対タイムアウトを、[リフレッシュトークンの有効期限日](/security/tokens/refresh-tokens/configure-refresh-token-expiration)で定義されたアプリケーションのフレッシュトークンの設定を超えた値には設定できません。有効期限日を超えた日付を設定しようとすると、APIメソッドは[リフレッシュトークンの有効期限](/security/tokens/refresh-tokens/configure-refresh-token-expiration)まで更新し、テナントログに警告イベント（`w`）を記録します。

[アクション](/actions)を使用すると、リスク検出を構成して、リフレッシュトークンを`api.refreshToken.revoke(reason)`メソッドとイベントオブジェクトを使って取り消すことができます。

Adaptive MFAの[アセスメント](https://auth0.com/docs/secure/multi-factor-authentication/adaptive-mfa/customize-adaptive-mfa#assessments-object)オブジェクトを使用すると、ユーザーがImpossibleTravelを示す場所からログインしているか判定し、そのトランザクションに関連付けられた現在のリフレッシュトークンを取り消すことができます。

* ユーザーの組織
* ユーザーのAuth0接続
* 特定ユーザーのグループメンバーシップまたはプロファイル
* リスク評価

### IPバインディングによるリフレッシュトークンの取り消し



この例では、アクションの開始時点で`event.authentication.ImpossibleTravel.code`が`impossible_travel_from_last_login`プロパティに等しいか検証されます。`true`の場合、アクションは`api.refreshToken.revoke()`を呼び出し、以下を行います。

ポストログインオブジェクトプロパティの`event.refresh_token.device.initial_ip`と`event.request.ip`を使って、その期間、リフレッシュトークンのトランザクションに同じIPアドレスが維持されるようにします。このシナリオでは、IPの変更はすべて危険だとみなされ、新しいリフレッシュトークンが要求されます。

* ユーザーの組織
* ユーザーのAuth0接続
* 「403 access_denied」のエラー応答を返す
* 「Refresh token revoked due to impossible travel（impossible travelによりトークンが取り消されました）」というエラーを発行する



## ユースケース：リフレッシュトークンの有効期限日をカスタマイズする

この例では、アクションの開始時点で、`event.refresh_token.device.initial_ip`と`event.request.ip`のプロパティを使ってIPアドレスの追跡が確認されます。アクションは、トランザクションのIPアドレスが変更されたかを判定します。`true`の場合、アクションは`api.refreshToken.revoke()`を呼び出し、以下を行います。

### 組織を基にリフレッシュトークンの絶対有効期限日をカスタマイズする

または、制限の少ないアクションでは、`event.request.asn`プロパティと`event.refresh_token.device.initial_asn`プロパティを追跡し、IPの変更でなく、ASNの変更を監視することができます。

[アクション](/actions)を使用すると、リフレッシュトークンのライフタイムと非アクティブの日付をカスタマイズすることができます。具体的には、特定のトランザクションについて、リフレッシュトークンのアイドルTTLと絶対有効期限日を設定することができます。これには、ポストログインの`api.refreshToken.setExpiresAt(Date)`メソッドと`api.refreshToken.setIdleExpiresAt(Date)`メソッドを使用します。

以下のポストログインオブジェクトプロパティを使用すると、現在のトランザクションに関連付けられた組織について、リフレッシュトークンのライフタイムを定義することができます。

* トランザクションを拒否する
* リフレッシュトークンを取り消す

### メンバーシップロールを基にリフレッシュトークンの非アクティブタイムアウトをカスタマイズする



この例では、アクションの開始時点で、リフレッシュトークンのライフタイムが`organization_refresh_token_lifetime`よりも長いかが検証されます。リフレッシュトークンのライフタイムの方がが長い場合、アクションはリフレッシュトークンの有効期限が「リフレッシュトークンの`作成`日+`organization_refresh_token_lifetime`」と等しくなるように設定します。

ポストログインオブジェクトプロパティの`event.refresh_token.last_exchanged_at`と` event.refresh_token.idle_expires_at`を使用すると、ユーザーのメンバーシップロールを基に、リフレッシュトークンの非アクティブタイムアウトを定義することができます。