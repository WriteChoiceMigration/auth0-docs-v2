---
og:description: Learn about managing Refresh Tokens with Actions
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: アクションを使用したリフレッシュトークン
og:url: https://auth0.com/docs/
permalink: manage-refresh-tokens-actions
title: アクションを使用したリフレッシュトークン
twitter:description: Learn about managing Refresh Tokens with Actions
twitter:title: アクションを使用したリフレッシュトークン
---

Using <Tooltip tip="Refresh Token: Token used to obtain a renewed Access Token without forcing users to log in again." cta="View Glossary" href="/docs/glossary?term=Refresh+tokens">Refresh tokens</Tooltip> with [Actions](/docs/customize/actions) allows you to configure post-authentication risk detection and response capabilities to protect your applications and users against compromised refresh tokens. You can also dynamically customize the [refresh token expirations](/docs/secure/tokens/refresh-tokens/configure-refresh-token-expiration).

**event.refresh_token**：`creation`、`expiry dates`、`associated clients`、`resource servers`、`device`のコンテキストなどの関連情報と、ブラウザーベースのフローに`session_id`を提供します。

* **event.refresh_token**: Provides relevant information for existing refresh_tokens including `id`, `created_at`, `expires_at`, `idle_expires_at`, `clients_id`, `device` information, such as `ASN`, `IP`, and `User_agent`, and for browser-based flows, `session_id`. This object is populated by [refresh token exchange](/docs/secure/tokens/refresh-tokens/use-refresh-token-rotation) flows.
* これを容易にするために、ログイン後のアクションには以下の2つの重要なオブジェクトがあります。

event.refresh_tokenとapi.refreshTokenオブジェクトは両方とも、[リフレッシュトークンの交換トランザクション](/security/tokens/refresh-tokens/use-refresh-token-rotation)に対応しています。

[イベントオブジェクト](/signup-and-login-triggers/login-trigger/post-login-event-object)：フレッシュトークンのイベントオブジェクトとプロパティについて説明します。

[APIオブジェクト](/signup-and-login-triggers/login-trigger/post-login-api-object)：フレッシュトークンのAPIオブジェクトとメソッドについて説明します。

* [Event object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-event-object): Learn about the refresh token Event object and properties.
* [API object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-api-object): Learn about the refresh token API object and methods.

## イベントログの取り消しを監視する

The post-login **api.refreshToken.revoke(reason)** method allows you to react to risks associated with a transaction. Revoking the refresh token, invalidates the refresh token, returns a 403 HTTP status code to deny the current transaction, and logs a refresh token revoked event in the [tenant logs](/docs/deploy-monitor/logs/log-event-type-codes) (`srrt`).

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

If you want to use the `api.refreshToken.revoke(reason)` method, ensure that the event.refresh_token object exists.

</Callout>

### 取り消し操作を行うと、[テナントログ](/logs)に以下のログイベントが追加されます。

The revoke operation adds the following log event in your [tenant logs](/docs/deploy-monitor/logs):

リフレッシュトークンの取り消しを示す`srrt`イベントコード

Auth0で現在のリフレッシュトークンのトランザクションを無効にする

## 403 HTTPステータスコードを返して、現在のトランザクションを拒否する

リフレッシュトークンが以前に認証されたセッションにバインドされている場合、ログには、`session_id`属性に認証済みセッションへの参照が含まれます。

* **api.refreshToken.setExpiresAt(Date)**は、特定のリフレッシュトークンに新しい絶対ライフタイムを定義できるようにします。
* **api.refreshToken.setIdleExpiresAt(Date)**は、特定のリフレッシュトークンに新しい非アクティブタイムアウトを設定できるようにします。

特定ユーザーのグループメンバーシップまたはプロファイル

* リスク評価
* アクションの実行中に使用できる他の動的条件
* リフレッシュトークンの有効期限日を変更するには、以下のポストログインメソッドを使用します。
* 制限事項
* これらのメソッドを使用すると、以下を基に、リフレッシュトークンのライフタイムと非アクティブポリシーを動的にカスタマイズすることができます。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

The `api.refreshToken.setExpiresAt(absolute)` and `api.refreshToken.setIdleExpiresAt(idle)` methods allow to define the expiration of a refresh token, before its issuance, or modify an existing refresh token expiration during a [refresh token exchange](/docs/secure/tokens/refresh-tokens/use-refresh-tokens) flow.

The `api.refreshToken.setExpiresAt(absolute)` and the `api.refreshToken.setIdleExpiresAt(idle)` methods will convert non-expiring refresh tokens to expiring refresh tokens using the defaults [Refresh Token expirations](/docs/secure/tokens/refresh-tokens/configure-refresh-token-expiration) settings as maximum values.

The `api.refreshToken.setIdleExpiresAt(idle)` method sets the inactivity timeout for refresh tokens. If the method is not called in every successful exchange, the inactivity timeout will be overwritten using the refresh token lifetime application settings.

</Callout>

## ポストログインAPIメソッドの`api.refreshToken.revoke(reason)`がリリースされる前に発行されたリフレッシュトークンには、`event.refresh_token.device`情報は含まれません。

ユースケース：リフレッシュトークンを取り消す

Refresh tokens issued before the release of the post-login API method `api.refreshToken.revoke(reason)` will not contain `event.refresh_token.device` information.

ImpossibleTravelによるトークンの取り消し

For security reasons, inactivity and absolute timeouts cannot be set above the application refresh token settings defined in the [refresh token expirations](/docs/secure/tokens/refresh-tokens/configure-refresh-token-expiration). If you attempt to set a date above the expiration settings, the API methods will update up to the [refresh token expirations](/docs/secure/tokens/refresh-tokens/configure-refresh-token-expiration) and log a warning event (`w`) in the tenant logs.

## Adaptive MFAの[アセスメント]()オブジェクトを使用すると、ユーザーがImpossibleTravelを示す場所からログインしているか判定し、そのトランザクションに関連付けられた現在のリフレッシュトークンを取り消すことができます。

You can use [Actions](/docs/customize/actions) to configure risk detections and revoke refresh tokens with the `api.refreshToken.revoke(reason)` method and the event objects.

### ユーザーのAuth0接続

You can use the <Tooltip tip="Adaptive Multi-factor Authentication: Multi-factor authentication (MFA) that is only triggered for users when an attempted login is determined to be a low confidence login." cta="View Glossary" href="/docs/glossary?term=Adaptive+MFA">Adaptive MFA</Tooltip> [assessments](/docs/secure/multi-factor-authentication/adaptive-mfa/customize-adaptive-mfa#assessments-object) object to determine if a user is logging from a location that indicates ImpossibleTravel and revoke the current refresh token associated with the transaction.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  const { riskAssessment } = event.authentication ?? {};
  const ImpossibleTravel = riskAssessment?.assessments.ImpossibleTravel;

  // If this is an impossible travel and this is a refresh token exchange
  if (ImpossibleTravel?.code === "impossible_travel_from_last_login") {
    if (event.refresh_token) {
      api.refreshToken.revoke("Refresh token revoked due to impossible travel");
    }
  }
};
```






リスク評価

* ユースケース：リフレッシュトークンの有効期限日をカスタマイズする
* この例では、アクションの開始時点で、`event.refresh_token.device.initial_ip`と`event.request.ip`のプロパティを使ってIPアドレスの追跡が確認されます。アクションは、トランザクションのIPアドレスが変更されたかを判定します。`true`の場合、アクションは`api.refreshToken.revoke()`を呼び出し、以下を行います。
* ポストログインオブジェクトプロパティの`event.refresh_token.device.initial_ip`と`event.request.ip`を使って、その期間、リフレッシュトークンのトランザクションに同じIPアドレスが維持されるようにします。このシナリオでは、IPの変更はすべて危険だとみなされ、新しいリフレッシュトークンが要求されます。
* ユーザーの組織

### ユーザーのAuth0接続

If you use the post-login object properties `event.refresh_token.device.initial_ip` and `event.request.ip` to ensure a refresh token transaction stays with the same IP address for its duration. In this scenario, any IP change is considered a risk, and a new refresh token is required.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  const refreshTokenInitialIp = event.refresh_token?.device?.initial_ip;
  const requestCurrentIp = event.request.ip;

  // if there is a refresh token and the IP changes
  if (
    refreshTokenInitialIp &&
    requestCurrentIp &&
    refreshTokenInitialIp != requestCurrentIp
  ) {
    api.refreshToken.revoke("Invalid IP change");
  }
};
```






「Refresh token revoked due to impossible travel（impossible travelによりトークンが取り消されました）」というエラーを発行する

* ユースケース：リフレッシュトークンの有効期限日をカスタマイズする
* この例では、アクションの開始時点で、`event.refresh_token.device.initial_ip`と`event.request.ip`のプロパティを使ってIPアドレスの追跡が確認されます。アクションは、トランザクションのIPアドレスが変更されたかを判定します。`true`の場合、アクションは`api.refreshToken.revoke()`を呼び出し、以下を行います。
* 組織を基にリフレッシュトークンの絶対有効期限日をカスタマイズする
* または、制限の少ないアクションでは、`event.request.asn`プロパティと`event.refresh_token.device.initial_asn`プロパティを追跡し、IPの変更でなく、ASNの変更を監視することができます。

以下のポストログインオブジェクトプロパティを使用すると、現在のトランザクションに関連付けられた組織について、リフレッシュトークンのライフタイムを定義することができます。

## トランザクションを拒否する

You can use [Actions](/docs/customize/actions) to customize the refresh token lifetime and inactivity dates. Specifically, you can configure the refresh token idle and absolute expiration dates for a particular transaction using the post-login `api.refreshToken.setExpiresAt(absolute)` and `api.refreshToken.setIdleExpiresAt(idle)` methods.

### メンバーシップロールを基にリフレッシュトークンの非アクティブタイムアウトをカスタマイズする

この例では、アクションの開始時点で、リフレッシュトークンのライフタイムが`organization_refresh_token_lifetime`よりも長いかが検証されます。リフレッシュトークンのライフタイムの方がが長い場合、アクションはリフレッシュトークンの有効期限が「リフレッシュトークンの`作成`日+`organization_refresh_token_lifetime`」と等しくなるように設定します。

```js lines
exports.onExecutePostLogin = async (event, api) => {
  // Refresh token timeout (in miliseconds) metadata configured in the Organizations
  const organization_refresh_token_lifetime =
    event.organization?.metadata?.refresh_token_timeout;

  if (organization_refresh_token_lifetime) {
    // Refresh token already exists
    if (event.refresh_token) {
      const created = Date.parse(event.refresh_token.created_at);

      const new_expiration_time =
        created + Number(organization_refresh_token_lifetime);
      api.refreshToken.setExpiresAt(new_expiration_time);
    } else {
      // Refresh token doesn't exist yet (e.g., token is being issued)
      const current_time = new Date().getTime();

      const new_expiration_time =
        current_time + Number(organization_refresh_token_lifetime);
      api.refreshToken.setExpiresAt(new_expiration_time);
    }
  }
};
```






ポストログインオブジェクトプロパティの`event.refresh_token.last_exchanged_at`と` event.refresh_token.idle_expires_at`を使用すると、ユーザーのメンバーシップロールを基に、リフレッシュトークンの非アクティブタイムアウトを定義することができます。

* Newly issued tokens: `current_time` plus `organization_refresh_token_lifetime`
* Existing Tokens: `event.refresh_token.created_at` plus `organization_refresh_token_lifetime`

### Customize refresh token inactivity timeout based on membership role

You can use post login action to define a refresh token idle timeout using [application](/docs/get-started/applications/configure-application-metadata) and [user metadata](/docs/manage-users/user-accounts/metadata). The example below uses the user metadata roles to define the user membership role and Application metadata to define the expected refresh token idle timeout.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  // admins are configured with a shorter idle timeout for refresh tokens, in an application metadata
  const max_idle_lifetime =
    event.client.metadata?.admin_refresh_token_idle_timeout;

  // Check the user app metadata roles attribute to check if it is an admin user.
  const isAdmin = event.user?.app_metadata?.roles?.find(
    (role) => role === "admin",
  );

  // If the application has an specific idle timeout defined, set the timeout
  if (max_idle_lifetime && isAdmin) {
    const current_time = new Date().getTime();

    api.refreshToken.setIdleExpiresAt(current_time + Number(max_idle_lifetime));
  }
};
```






In this example, if there is a specific idle timeout defined for the Application and the user is an Admin, the Action sets the refresh token inactivity timeout to be equal to the `current_time` plus the `refresh_token_idle_timeout`. Note that we are changing the timeout for both newly issued tokens and existing ones during refresh token exchange.