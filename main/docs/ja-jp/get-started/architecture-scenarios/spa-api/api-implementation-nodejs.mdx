---
og:description: The Node.js implementation of the API for the SPA + API architecture
  scenario
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Node.js APIの実装 (SPA+API)
og:url: https://auth0.com/docs/
permalink: api-implementation-nodejs
title: Node.js APIの実装 (SPA+API)
twitter:description: The Node.js implementation of the API for the SPA + API architecture
  scenario
twitter:title: Node.js APIの実装 (SPA+API)
---

# Node.js API Implementation (SPAs + API)

本ドキュメントはSPA + APIアーキテクチャーシナリオの一部で、APIをNode.jsで実装する方法を説明します。実装したソリューションについての情報は、シナリオを参照してください。

The full source code for the Node.js API implementation can be found in [this GitHub repository](https://github.com/auth0-samples/auth0-pnp-exampleco-timesheets/tree/master/timesheets-api/node).

## Step 1.APIエンドポイントの定義

We will use the [Express web application framework](http://expressjs.com/) to build our Node.js API.

### API用のフォルダーを作成しそこに移動して`npm init`を実行します。これにより、`package.json`ファイルがセットアップされます。

デフォルト設定のままにするか、必要に応じて変更します。

サンプルの`package.json`は次のようになります。

依存関係をインストールします

```json lines
{
  "name": "timesheets-api",
  "version": "1.0.0",
  "description": "API used to add timesheet entries for employees and contractors",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/auth0-samples/auth0-pnp-timesheets.git"
  },
  "author": "Auth0",
  "license": "MIT",
  "bugs": {
    "url": "https://github.com/auth0-samples/auth0-pnp-timesheets/issues"
  },
  "homepage": "https://github.com/auth0-samples/auth0-pnp-timesheets#readme"
}
```






### 次に、依存関係を設定する必要があります。以下のモジュールを使用します。

**express**：このモジュールは[Express Webアプリケーションフレームワーク]()を追加します。

* **express**: This module adds the [Express web application framework](https://expressjs.com/).
* **cors**: This module adds support for enabling [CORS](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing) which is required since the API will be called from a Single-Page Application running on a different domain inside a web browser.
* **jwks-rsa**: This library retrieves RSA signing keys from a JWKS (JSON Web Key Set) endpoint. Using `expressJwtSecret` we can generate a secret provider that will provide the right signing key to `express-jwt` based on the `kid` in the <Tooltip tip="JSON Web Token (JWT): Standard ID Token format (and often Access Token format) used to represent claims securely between two parties." cta="View Glossary" href="/docs/glossary?term=JWT">JWT</Tooltip> header. For more information refer to the [node-jwks-rsa GitHub repository](https://github.com/auth0/node-jwks-rsa).
* **express-jwt**: This module lets you authenticate HTTP requests using JWT tokens in your Node.js applications. It provides several functions that make working with JWTs easier. For more information refer to the [express-jwt GitHub repository](https://github.com/auth0/express-jwt).
* これらの依存関係をインストールするには、次を実行します。

エンドポイントを実装する

```bash wrap lines
npm install express cors express-jwt jwks-rsa body-parser express-jwt-authz --save
```






### APIディレクトリに移動し、`server.js`ファイルを作成します。コードに必要なこと：

依存関係を取得する。

* エンドポイントを実装する。
* APIサーバーを起動する。
* 実装例を以下に示します。

これでエンドポイントが入手できましたが、それは誰でも呼び出すことができます。次の段落に進んで、この問題を解決する方法を確認します。

```javascript lines
const express = require('express');
const app = express();
const { expressjwt: jwt } = require('express-jwt');
const jwksRsa = require('jwks-rsa');
const cors = require('cors');
const bodyParser = require('body-parser');

// Enable CORS
app.use(cors());

// Enable the use of request body parsing middleware
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({
  extended: true
}));

// Create timesheets API endpoint
app.post('/timesheets', function(req, res){
  res.status(201).send({message: "This is the POST /timesheets endpoint"});
})

// Launch the API Server at localhost:8080
app.listen(8080);
```






2.APIエンドポイントを保護する

トークンを検証するには、[express-jwt]()ミドルウェアが提供する`jwt`関数と`jwks-rsa`を使用してシークレットを取得します。ライブラリーは以下を行います。

## Step コードでは次のステップに従います。

In order to validate our token we will use the `jwt` function, provided by the [express-jwt middleware](https://github.com/auth0/express-jwt#usage), and the `jwks-rsa` to retrieve our secret. The libraries do the following:

1. `express-jwt` will decode the token and pass the request, the header and the payload to `jwksRsa.expressJwtSecret`.
2. `jwks-rsa` will then download all signing keys from the JWKS endpoint and see if a one of the signing keys matches the `kid` in the header of the JWT. If none of the signing keys match the incoming `kid`, an error will be thrown. If we have a match, we will pass the right signing key to `express-jwt`.
3. `express-jwt` will the continue its own logic to validate the signature of the token, the expiration, `audience` and the `issuer`.

ルートでミドルウェアを使用できるようにする。

* Create the middleware function to validate the <Tooltip tip="Access Token: Authorization credential, in the form of an opaque string or JWT, used to access an API." cta="View Glossary" href="/docs/glossary?term=Access+Token">Access Token</Tooltip>.
* ここでサーバーを起動して`localhost:8080/timesheets`にHTTP POSTを実行すると、エラーメッセージ`Missing or invalid token`が表示されるはずです（要求でアクセストークンを送信しなかったためこれは正確です）。

また、作業シナリオをテストするためには、次を実行する必要があります。

```javascript lines expandable
// set dependencies - code omitted

// Enable CORS - code omitted

// Create middleware for checking the JWT
const checkJwt = jwt({
  // Dynamically provide a signing key based on the kid in the header and the signing keys provided by the JWKS endpoint
  secret: jwksRsa.expressJwtSecret({
    cache: true,
    rateLimit: true,
    jwksRequestsPerMinute: 5,
    jwksUri: `https://{yourDomain}/.well-known/jwks.json`
  }),

  // Validate the audience and the issuer
  audience: '{YOUR_API_IDENTIFIER}', //replace with your API's audience, available at Dashboard > APIs
  issuer: 'https://{yourDomain}/',
  algorithms: [ 'RS256' ]
});

// Enable the use of request body parsing middleware - code omitted

// create timesheets API endpoint - code omitted
app.post('/timesheets', checkJwt, function(req, res){
  var timesheet = req.body;

  // Save the timesheet to the database...

  //send the response
  res.status(201).send(timesheet);
});
// launch the API Server at localhost:8080 - code omitted
```






アクセストークンを取得します。詳しい取得方法については、「[アクセストークンを取得する](/architecture-scenarios/application/server-api#get-an-access-token)」を参照してください。

APIを呼び出し、`Bearer ACCESS_TOKEN`値を指定して`Authorization`ヘッダーを要求に追加します（`ACCESS_TOKEN`は最初のステップで取得したトークンの値）。

* Get an Access Token. For details on how to do so refer to: [Get an Access Token](/docs/get-started/architecture-scenarios/server-application-api#get-an-access-token).
* このステップでは、アプリケーションに権限（または`スコープ`）があるかを確認する機能を実装に追加して、タイムシートを作成するためにエンドポイントを使用します。特にトークンのスコープが正しく、`batch:upload`であることを確認することが目的です。

## Step そのためには、`express-jwt-authz` Node.jsパッケージを利用するので、それをプロジェクトに追加します。

ここで`jwtAuthz (...)`への呼び出しをミドルウェアに追加して、特定のエンドポイントを実行するために、特定のスコープがJWTに含まれていることを確認します。

追加の依存関係を追加します。**express-jwt-authz**ライブラリーはexpress-jwtと組み合わせて使用され、[JWT]()を検証し、目的のエンドポイントを呼び出すための正しい権限を持っていることを保証します。詳細については、[［express-jwt-authz GitHubリポジトリ］]()を参照してください。

```bash lines
npm install express-jwt-authz --save
```






以下はサンプル実装を示します（簡潔にするために一部のコードは省略しています）。

We will add an additional dependency. The **express-jwt-authz** library, which is used in conjunction with express-jwt, validates the [JWT](/docs/secure/tokens/json-web-tokens) and ensures it bears the correct permissions to call the desired endpoint. For more information refer to the [express-jwt-authz GitHub repository](https://github.com/auth0/express-jwt-authz).

4.ユーザーIDの決定

```javascript lines
// set dependencies - some code omitted
const jwtAuthz = require('express-jwt-authz');

// Enable CORS - code omitted

// Create middleware for checking the JWT - code omitted

// Enable the use of request body parsing middleware - code omitted

// create timesheets API endpoint
app.post('/timesheets', checkJwt, jwtAuthz(['create:timesheets'], { customUserKey: 'auth' }), function(req, res){
  var timesheet = req.body;

  // Save the timesheet to the database...

  //send the response
  res.status(201).send(timesheet);
})

// launch the API Server at localhost:8080 - code omitted
```






JWTの検証に使われる`express-jwt`ミドルウェアは、JWTに含まれる情報を`req.auth`に設定します。`sub`クレームを使用してユーザーを一意に識別したい場合は、`req.auth.sub`を使用するだけです。

## Step ただし、タイムシートアプリケーションの場合は、ユーザーの電子メールアドレスを一意の識別子として使用します。

最初に行う必要があるのは、ユーザーの電子メールアドレスをアクセストークンに追加するルールを作成することです。Dashboardの[［Rules section（ルールセクション）］]()に移動し、**［Create Rule（ルールの作成）］**ボタンをクリックします。

わかりやすい名前をルールに付けます。たとえば、`［Add email to Access Token（アクセストークンにメールアドレスを追加）］`など。次に、ルールのコードとして次のコードを使用します。

The first thing we need to do is to write a rule which will add the email address of the user to the Access Token. Go to the [Rules section](https://manage.auth0.com/#/rules%7D) of the Dashboard and click on the **Create Rule** button.

次に、API内で、`Req.Auth`からクレームの値を取得し、タイムシートエントリに関連付けることができる一意のユーザーIDとしてそれを使用できます。

```javascript lines
function (user, context, callback) {
  const namespace = 'https://api.exampleco.com/';
  context.accessToken[namespace + 'email'] = user.email;
  callback(null, user, context);
}
```






The `namespace` is used to ensure the claim has a unique name and does not clash with the names of any of the standard OIDC claims. However, Auth0 supports namespaced and non-namespaced custom claims. For more info on custom claims, see [Create Custom Claims](/docs/secure/tokens/json-web-tokens/create-custom-claims).

Next, inside your API, you can retrieve the value of the claim from `req.auth`, and use that as the unique user identity which you can associate with timesheet entries.

```js lines
app.get('/timesheets', checkJwt, jwtAuthz(['read:timesheets'], { customUserKey: 'auth' }), function(req, res) {
  var timesheet = req.body;

  // Associate the timesheet entry with the current user
  var userId = req.auth['https://api.exampleco.com/email'];
  timesheet.user_id = userId;

  // Save the timesheet to the database...

  //send the response
  res.status(201).send(timesheet);
});
```