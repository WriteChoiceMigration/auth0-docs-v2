---
og:description: The Android implementation of the API for the Mobile + API architecture
  scenario
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Android用モバイルアプリの実装方法（モバイルアプリとAPI）
og:url: https://auth0.com/docs/
permalink: mobile-implementation-android
title: Android用モバイルアプリの実装方法（モバイルアプリとAPI）
twitter:description: The Android implementation of the API for the Mobile + API architecture
  scenario
twitter:title: Android用モバイルアプリの実装方法（モバイルアプリとAPI）
---

この文書はモバイルおよびAPIアーキテクチャシナリオの一部であり、Androidでモバイルアプリケーションを実装する方法を説明します。実装したソリューションについての情報は、シナリオを参照してください。

## 1.アプリケーションのセットアップ方法



### 依存関係の設定

この実装ではアプリの`build.gradle`ファイル内で以下の依存関係を使用します。

* [Auth0.Android](https://github.com/auth0/Auth0.Android)：このパッケージは、ユーザーを認証するためにAuth0との統合を可能にします。
* [OkHttp](http://square.github.io/okhttp/)：このパッケージはNode.JS APIに要求を行うためのHTTPアプリケーションを提供します。
* [JWTDecode.Android](https://github.com/auth0/JWTDecode.Android)：このパッケージはJWTのデコードを支援します。
* AppCompat：このパッケージは、アクティビティ内でのナビゲーションにおいてツールバーウィジェットの使用を可能にします。



### マニフェストの更新

アプリケーションの`AndroidManifest.xml`を開き、インターネット権限を追加します。



アプリケーションの詳細も更新して、ツールバーウィジェットを活用するようにします。



### 規定値の設定

Auth0 Client ID, Auth0ドメイン、およびAPIのURLを `/res/values/strings.xml`にある`strings.xml`リソースに設定してください。



この実装ではアプリケーションパッケージ内にactivities、models、 utilsのディレクトリを作成します。

* `activities/`：このパッケージには `LoginActivity.java`, `TimeSheetActivity.java`、`FormActivity.java`および`UserActivity.java`が含まれます。
* `models/`このパッケージには`TimeSheet.java`および`User.java`データモデルが含まれます。
* `utils/`：このパッケージには`UserProfileManager.java`、`TimeSheetAdapter.java`および`ImageTask.java`が含まれます。

## 2.ユーザーの認可

### マニフェストの更新

アプリの`AndroidManifest.xml`を開き、`ログインアクティビティ`を追加します。



### ログインアクティビティの作成

`ログインアクティビティ`ログイン()メソッドを作成して、 WebAuthProviderを初期化し、認可を開始します。`WebAuthProvider`に必ず正確なスキーム、オーディエンス、およびスコープを提供してください。この実装では以下の識別子を使用します。

* **scheme**：`demo`：
* **audience**：`https://api.exampleco.com/timesheet`（Node.JS API）
* **response_type**：`code`
* **scope**：`timesheets read:timesheets openid profile email offline_accessを作成します。`これらのスコープにより、Node.js APIに対して`POST`および`GET` 要求を行うことができ、ユーザープロフィールやリフレッシュトークンを取得できます。



`ログイン()`メソッドで認証が成功すると、ユーザーを`TimeSheetActivity`にリダイレクトします。



### 資格情報の保存

ログイン後に受け取った資格情報を保存するためにAuth0.Androidライブラリの`CredentialsManager`と[SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences.html)を使用します。

`ログイン()`メソッドで`WebAuthProvider`を初期化する前に、`CredentialsManager`を作成できます。`CredentialsManager`に`AuthenticationAPIClient`を渡すことで、期限切れのアクセストークンをリフレッシュできます。



認証成功後に資格情報が`CredentialsManager`を通じて保存されるように`ログイン（）`メソッドを更新してください。



## 3.ユーザープロファイルの取得

### ユーザーモデルの作成

`UserProfileManager`と`UserActivity`で使用される簡単なユーザーモデルを作成します。



### ユーザープロファイルの保存

ユーザープロファイル情報の保存を管理するために`UserProfileManager`というマネージャークラスを作成します。`UserProfileManager`はデータを保存するために[SharedPreferences](https://developer.android.com/reference/android/content/SharedPreferences.html)を使用します。



続いて`ログインアクティビティ`の `ログイン()`メソッドを更新してIDトークンを取得し、JWTDecode.Androidライブラリを使用してトークンからユーザープロファイルを取得します。次に`UserProfileManager`を使用してユーザープロファイルを保存します。



## 4.スコープに基づいた条件付きUI要素の表示

ユーザーが特定の操作を実行する権限を持っているかどうかを判断するには、認証プロセス中にユーザーに付与された `scope`を確認します。`scope`にはユーザーに付与されたすべてのスコープを含む文字列が含まれているため、特定のスコープが付与されたかどうかを判断するには、単にそのスコープ文字列に特定のスコープの部分文字列が含まれているかどうかを確認するだけで済みます。

### スコープの保存

まず`User`クラスを更新して、付与されたスコープを保存し、その後、付与されたスコープに特定のスコープが含まれているかどうかを判断するためのヘルパーメソッドである`hasScope()`を提供できます。



また、`UserProfileManager`を更新して追加のフィールドを確実に保存してください。



次に`LoginActivity`を更新して、`scope`を渡せるようにして、それを`User`オブジェクトに保存できるようにしてください。



### スコープに基づいて承認メニューを表示する

これで、ユーザーに特定のスコープが付与されているかどうかの情報に基づいて、特定のUI要素を表示することができます。例えば、`approve:timesheets`スコープが付与されたユーザーにのみ表示される承認メニュー項目があります。

以下は、`BaseActivity`クラスのコードで、ユーザーが `approve:timesheets`スコープを持っているかどうかをチェックし、それに基づいて承認アクティビティを表示するメニュー項目の可視性の状態を設定します。



## 5.APIの呼び出し

### マニフェストの更新

アプリの`AndroidManifest.xml`を開き、 `TimeSheetActivity`を追加します。



### TimeSheetActivityのレイアウトを構成する

次に`TimeSheetsActivity`のレイアウトである`timesheet_activity.xml`を作成します。



`ListView`ウィジェットには`item_entry.xml`レイアウトで表される個々のエントリが含まれます。



`TimeSheetActivity`のツールバーナビゲーションのために`timesheet_action_menu.xml`メニューリソースを作成します（`/res/menu/`）。



### タイムシートモデルを作成する

タイムシートデータをビューで扱うためのモデルを作成します。



### タイムシートアダプターを作成する

`TimeSheetAdapter`はタイムシートエントリの配列を受け取り、それを`TimeSheetActivity`の`ListView`に適用するユーティリティクラスです。



### タイムシートアクティビティの作成

`TimeSheetActivity`はログインしているユーザーのタイムシートエントリをサーバーから取得して表示します。

* `@string/api_url`は`http://10.0.2.2:8080/timesheets`に設定されており、Androidエミュレーターが `http://localhost:8080`で実行されている Node.JS APIに接続できるようになっています。
* `callAPI()`メソッドは、Node.JS APIからタイムシートを取得します。
* `processResults()`メソッドは`callAPI()`からのJSON応答を受け取り、それを`TimeSheet`オブジェクトに変換します。
* `onCreateOptionsMenu(`)と`onOptionsItemSelected(`)メソッドはツールバーウィジェットのナビゲーション機能を処理します。



## 6.ユーザープロファイルを表示する

ログインしているユーザーのプロファイルを表示するには、`UserActivity`を作成し、それに対応する`user_activity.xml`レイアウトと、ツールバーナビゲーション用の`user_action_menu.xml`を作成します。ビューは、ユーザーの名前、メールアドレス、およびプロファイル写真を表示します。

### マニフェストの更新

アプリの`AndroidManifest.xml`を開き、`UserActivity`を追加します。



#### ユーザーアクティビティレイアウトを作成する

次に、`UserActivity`のレイアウトである`user_activity.xml`を作成します。これには,ユーザーのプロファイル写真用の`ImageView`と、ユーザーの名前とメールアドレス用の`TextViews`が含まれます。



続いて `UserActivity`ツールバー用に`user_actions_menu.xml`を作成します。



### URLからプロファイル写真を読み込む

URLからプロファイル写真を取り込むには、`AsyncTask`を拡張したタスクを作成し、バックグラウンドで実行します。



### ユーザーアクティビティを作成する

`onCreate()`メソッドで、`UserProfileManager`からユーザー情報を取得し、ビューに値を設定します。前と同様に、`onCreateOptionsMenu()`と`onOptionsItemSelected()`メソッドは、ツールバーウィジェットのナビゲーション機能を処理します。



## 7.新しいタイムシートのためのフォーム

次に、新しいタイムシートエントリを作成するための`FormActivity`とレイアウトを作成します。

### マニフェストの更新

アプリの`AndroidManifest.xml`を開き、`FormActivity`を追加します。



### フォームアクティビティのレイアウトの作成

`form_activity.xml`レイアウトを作成します。これにはプロジェクト名と作業時間の入力用の `EditText` および作業日用の`DatePicker`が含まれます。



また、`FormActivity`のツールバー用に`form_actions_menu.xml`を作成します。



### Form Activityの作成

* `@string/api_url`は`http://10.0.2.2:8080/timesheets`に設定されており、Androidエミュレーターが `http://localhost:8080`で実行されている Node.JS APIに接続できるようになっています。
* `onCreate()`メソッドはフォームを初期化し、送信ボタンが押されたときに`postAPI()`メソッド用の入力情報を収集します。
* `postAPI()`メソッドはフォームから取得したユーザー入力情報をJSON形式でNode.js APIに送信します。
* `clearForm()`メソッドは入力フォームをクリアします。
* `onCreateOptionsMenu()`と`onOptionsItemSelected()`メソッドはツールバーウィジェットのナビゲーション機能を処理します。



## アプリのテスト

続行する前に、 [Node.js APIを実装している](https://auth0.com/docs/architecture-scenarios/application/mobile-api/api-implementation-nodejs)ことを確認してください。

1. APIのディレクトリにターミナルで移動し、`node server`コマンドを入力してAPIを起動します。
2. 次に、Android Studioでモバイルアプリを開き、**［Run（実行）］**ボタンを押します。
3. Nexus 5X API 23の仮想デバイスを選択します。
4. エミュレーターがモバイルアプリを読み込んだら、ユーザーにログインし、その後、実行中のNode.js APIからタイムシートエントリを作成および表示できます。

これで作業完了です。完了です。