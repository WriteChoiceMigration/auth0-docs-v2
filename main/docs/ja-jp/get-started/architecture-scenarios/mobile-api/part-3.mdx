---
og:description: API and Mobile Configuration for the Mobile + API architecture scenario
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: APIとモバイルの構成（モバイルアプリ + API）
og:url: https://auth0.com/docs/
permalink: part-3
title: APIとモバイルの構成（モバイルアプリ + API）
twitter:description: API and Mobile Configuration for the Mobile + API architecture
  scenario
twitter:title: APIとモバイルの構成（モバイルアプリ + API）
---

このセクションでは、当社シナリオでAPIを実装する方法を説明します。



## APIエンドポイントの定義

まず、APIのエンドポイントを定義する必要があります。



この実装では、2つのエンドポイントのみ定義します。1つは従業員の全タイムシートのリストを取得するため、もう1つは従業員がタイムシートエントリーを新規作成できるようにするためのものです。

`/timesheets`エンドポイントへの`HTTP GET`要求は、ユーザーがタイムシートを取得できるようにし、`/timesheets`への`HTTP POST`要求は、ユーザーが新たなタイムシートを追加できるようにします。

[Node.js](https://auth0.com/docs/architecture-scenarios/application/mobile-api/api-implementation-nodejs#1-define-the-api-endpoints)

### エンドポイントのセキュリティ確保

APIがヘッダーの一部にBearerアクセストークンのある要求を受け取った場合、最初にすべきことはトークンの検証です。これは複数の手順で構成され、そのうち1つでも失敗した場合、要求は、`Missing or invalid token`という呼び出し元アプリへのエラーメッセージとともに拒否されなければなりません。

APIは以下の検証を実行すべきです。

* JWTが整形式であることを確認する
* 署名を確認する
* 標準クレームを検証する



検証プロセスにはクライアント権限（スコープ）の確認も含まれますが、これに関しては次の段落で別に説明します。

アクセストークン検証の詳細については、[「アクセストークンを検証する」](https://auth0.com/docs/tokens/guides/validate-access-tokens)を参照してください。

[Node.js](https://auth0.com/docs/architecture-scenarios/application/mobile-api/api-implementation-nodejs#2-secure-the-api-endpoints)

### クライアントの権限の確認

この段階ではJWTの有効性が検証されています。最後の手順は、クライアントが保護されたリソースにアクセスするために必要な権限を持っているかどうかを検証することです。

そのためには、APIがデコードされたJWTの[スコープ](https://auth0.com/docs/scopes)を確認する必要があります。このクレームはペイロードの一部で、スペースで区切られた文字列のリストです。

[Node.js](https://auth0.com/docs/architecture-scenarios/application/mobile-api/api-implementation-nodejs#3-check-the-client-permissions)

### ユーザーIDの判断

どちらのエンドポイント（タイムシートのリスト取得用と新規タイムシート追加用）でも、ユーザーのIDを判断する必要があります。

これは、タイムシートのリスト取得に関しては、要求元のユーザーのタイムシートのみを返すようにするためです。一方の新規タイムシートの追加に関しては、タイムシートがその要求元のユーザーと関連付けられていることを確認するためです。

標準JWTクレームの1つは、クレームの対象である本人を識別する`sub`クレームです。暗黙的付与フローの場合、このクレームにはAuth0ユーザーの一意の識別子であるIDが含まれます。これを使って、外部システムのいかなる情報でも、特定ユーザーに関連付けることができます。

また、カスタムクレームを使って、メールアドレスなど別のユーザー属性をアクセストークンに追加し、ユーザーを一意に識別することもできます。

[Node.js](https://auth0.com/docs/architecture-scenarios/application/mobile-api/api-implementation-nodejs#4-determine-the-user-identity)

## モバイルアプリの実装

このセクションでは、当社シナリオでモバイルアプリケーションを実装する方法を説明します。

[Androidでの実装を参照してください。](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#1-set-up-the-application)

### ユーザーの認可

ユーザーを認可するには、[Proof Key for Code Exchange（PKCE）での認可コードフロー](https://auth0.com/docs/flows/guides/auth-code-pkce/call-api-auth-code-pkce)を実装します。モバイルアプリケーションは最初に、`code_challenge`および生成するために使用するメソッドと一緒に、ユーザーを[認可URL](https://auth0.com/docs/api/authentication#authorization-code-grant-pkce-)に送信する必要があります。



認可URLへの`GET`要求は、以下の値を含める必要があります。



[Androidでの実装を参照してください。](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#2-authorize-the-user)

### 資格情報の取得

認可URLへの要求が成功したら、以下の応答を受け取ります。



次に、応答の`認可コード`をAPIを呼び出すのに使用するアクセストークンと交換します。以下のデータを含めて、[トークン URL](/api/authentication#authorization-code-pkce-)への`POST`要求を実行します。





トークンURLからの応答は、以下を含みます。



* **access_token**:`audience`で指定されたAPIのアクセストークン
* **refresh_token**:[リフレッシュトークン](/tokens/concepts/refresh-tokens)は、`offline_access`スコープを含め、DashboardでAPIの**［Allow Offline Access（オフラインアクセスの許可）］**を有効にした場合にのみ表示されます。
* **id_token**:ユーザープロファイル情報が入ったIDトークンJWT
* **token_type**:トークンのタイプを含む文字列で、常にベアラートークンです。
* **expires_in**:アクセストークンの有効期限が切れるまでの秒数。

APIの呼び出しとユーザープロファイルの取得に使用するために、上記の資格情報をローカルストレージに保存しておく必要があります。

[Androidでの実装を参照してください。](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#store-credentials)

### ユーザープロファイルの取得

[ユーザープロファイル](https://auth0.com/docs/api/authentication?http#user-profile)を取得するために、モバイルアプリケーションは[JWTライブラリー](https://jwt.io/#libraries-io)の１つを使用して、[IDトークン](https://auth0.com/docs/tokens/concepts/id-tokens)をデコードすることができます。これは、[署名を検証](https://auth0.com/docs/tokens/guides/validate-id-token#verify-the-signature)して、トークンの[クレームを検証](https://auth0.com/docs/tokens/guides/validate-id-token#verify-the-claims)することで行えます。IDトークンを検証したら、ユーザー情報を含んだペイロードにアクセスできます。



[Androidでの実装を参照してください。](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#3-get-the-user-profile)

### スコープに基づいた条件付きUI要素の表示

ユーザーの`scope`に基づいて、特定のUI要素を表示または非表示にしたい場合があります。ユーザーに発行されたスコープを特定するには、ユーザーが認証されたときに付与された`scope`を調べる必要があります。これは、すべてのスコープを含んでいる文字列であるため、この文字列を調べて必要な`scope`が含まれているかどうかを調べる必要があります。そしてそれに基づいて、特定のUI要素を表示するかどうかを決定できます。

[Androidでの実装を参照してください](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#4-display-ui-elements-conditionally-based-on-scope)

### APIの呼び出し

APIから安全なリソースにアクセスするには、認証されたユーザーのアクセストークンを、送信される要求に入れる必要があります。これには、`Bearer`スキームを使用して、`Authorization`ヘッダー内でアクセストークンを送る必要があります。

[Androidでの実装を参照してください。](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#5-call-the-api)

### トークンの更新



アクセストークンをリフレッシュするには、認可結果のリフレッシュトークンを使用して、`/oauth/token`エンドポイントへの`POST`要求を実行します。

[リフレッシュトークン](https://auth0.com/docs/tokens/concepts/refresh-tokens)は、`offline_access`スコープを先行の認可要求に含め、DashboardでAPIの**［Allow Offline Access（オフラインアクセスの許可）］**を有効にした場合にのみ表示されます。

要求には以下を含める必要があります。





応答には、新しいアクセストークンが含まれます。



[Androidでの実装を参照してください。](https://auth0.com/docs/architecture-scenarios/application/mobile-api/mobile-implementation-android#store-the-credentials)