---
og:description: Learn how to execute the Hybrid Flow so your app can use an ID token
  to access information about the user while obtaining an authorization code that
  can be exchanged for an Access Token.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: ハイブリッドフローを使用してAPIを呼び出す
og:url: https://auth0.com/docs/
permalink: call-api-hybrid-flow
title: ハイブリッドフローを使用してAPIを呼び出す
twitter:description: Learn how to execute the Hybrid Flow so your app can use an ID
  token to access information about the user while obtaining an authorization code
  that can be exchanged for an Access Token.
twitter:title: ハイブリッドフローを使用してAPIを呼び出す
---



Auth0では、以下を使用することでアプリは簡単に認可コードフローを実装できるようになります。

* [Authentication API](/api/authentication)：独自のソリューションを構築したい場合は、このまま読み続けて、APIを直接呼び出す方法を学習してください。

## 前提条件

**このチュートリアルを始める前に：**

* [Auth0にアプリケーションを登録します](/get-started/create-apps/regular-web-apps)。

* 適切な**［Application Type（アプリケーションタイプ）］**を選択します。
* `**${account.callback}**`の**［Allowed Callback URL（許可されているコールバックURL）］**を追加します。
* アプリケーションの**［Grant Types（付与タイプ）］**に**［Implicit（暗黙的）］**と**［Authorization Code（認可コード）］**が必ず含まれていることを確認してください。詳細については、「[付与タイプを更新する](/applications/update-grant-types)」をお読みください。
* アプリケーションでリフレッシュトークンを使用できるようにするには、アプリケーションの**［Grant Types（付与タイプ）］**に**［Refresh Token（リフレッシュトークン）］**が含まれていることを確認してください。詳細については、「[付与タイプを更新する](/applications/update-grant-types)」をお読みください。リフレッシュトークンの詳細については、「[リフレッシュトークン](/security/tokens/refresh-tokens)」をお読みください。
* [APIをAuth0に登録する](/get-started/set-up-apis)

* APIがリフレッシュトークンを受信して、以前のトークンの有効期限が切れたときに新しいトークンを取得できるようにする場合は、**［Allow Offline Access（オフラインアクセスの許可）］**を有効にします。

## ステップ

1. [ユーザーを認可する](#authorize-user)： 
ユーザーの認可を要求し、認可コードと一緒にアプリにリダイレクトします。
2. [トークンを要求する](#request-tokens)： 
認可コードをトークンと交換します。
3. [APIを呼び出す](#call-api)：
取得したアクセストークンを使ってAPIを呼び出します。
4. [リフレッシュトークン](#refresh-tokens)：
既存のトークンが期限切れになったら、リフレッシュトークンを使用して新しいトークンを要求します。

任意：[サンプルユースケースを参考にしてください](#sample-use-cases)。

### ユーザーを認可する



ユーザーを認可するには、アプリがユーザーを[認可URL](/api/authentication#authorization-code-grant)に送信する必要があります。

#### 認可URLの例



##### パラメーター





たとえば、アプリにログインを追加する際の認可URLのHTMLスニペットは、以下のようになります。



#### 応答

すべてが成功すると`、HTTP 302`応答を受け取ります。要求された資格情報は本文にエンコードされます。



返される値は、`response_type`として何を要求したかによって異なります。



Auth0は、認可URLへの呼び出しに含めた状態値も返します。





IDトークンをデコードして解析すると、`c_hash`という追加のクレームが含まれていることがわかります。これには`code`のハッシュが含まれています。このクレームは、IDトークンが`code`と同時に発行される場合に必須であり、検証する必要があります。

1. IDトークンのヘッダー内の`alg`クレームで指定されたハッシュアルゴリズムを使用して、`code`のASCII表現のオクテットをハッシュ化します。
2. ハッシュの左半分をBase64urlエンコードします。
3. 結果が`c_hash`の値と一致することを確認します。

### トークンを要求する



このステップで受け取るアクセス トークンは、APIを呼び出す際に使用します。このトークンは、チュートリアルの前のステップで受け取ったアクセストークンとは別に保管するようにしてください。

#### トークンURLへのPOSTの例



##### パラメーター



#### 応答

すべてが成功すると、`access_token`、`fresh_token`、`id_token`、および`token_type`の値を含むペイロードとともに`HTTP 200`応答を受信します。









### APIを呼び出す

通常のWebアプリケーション（または同様のケースで、アプリケーションの資格情報を安全に保存できる場合）からAPIを呼び出すには、アプリケーションは、取得したアクセストークンをベアラートークンとしてHTTP要求の認可ヘッダーで渡さなければなりません。



### リフレッシュトークン



#### トークンURLへのPOSTの例



##### パラメーター



#### 応答







### サンプルユースケース

#### トークンをカスタマイズする

ルールを使用して、アクセストークンで返されたスコープを変更し、クレームをアクセスとIDトークンに追加することができます。（ルールの詳細については、「[Auth0ルール](/rules)」をお読みください。）これを行うには、ユーザーの認証後に実行される次のルールを追加します。



すべてのルールが実行された後、トークンでスコープが使用可能になります。