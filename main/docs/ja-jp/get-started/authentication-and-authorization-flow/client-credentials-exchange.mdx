---
og:description: Learn how Hooks can be used with the Client Credentials Exchange extensibility
  point, which is available for database connections and passwordless connections.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Client Credentials Exchange
og:url: https://auth0.com/docs/
permalink: client-credentials-exchange
title: Client Credentials Exchange
twitter:description: Learn how Hooks can be used with the Client Credentials Exchange
  extensibility point, which is available for database connections and passwordless
  connections.
twitter:title: Client Credentials Exchange
---

<Warning>

The End of Life (EOL) date of Rules and Hooks will be **November 18, 2026**, and they are no longer available to new tenants created as of **October 16, 2023**. Existing tenants with active Hooks will retain Hooks product access through end of life.

We highly recommend that you use Actions to extend Auth0. With Actions, you have access to rich type information, inline documentation, and public `npm` packages, and can connect external integrations that enhance your overall extensibility experience. To learn more about what Actions offer, read [Understand How Auth0 Actions Work](/docs/customize/actions/actions-overview).

To help with your migration, we offer guides that will help you [migrate from Rules to Actions](/docs/customize/actions/migrate/migrate-from-rules-to-actions) and [migrate from Hooks to Actions](/docs/customize/actions/migrate/migrate-from-hooks-to-actions). We also have a dedicated [Move to Actions](https://auth0.com/extensibility/movetoactions) page that highlights feature comparisons, [an Actions demo](https://www.youtube.com/watch?v=UesFSY1klrI), and other resources to help you on your migration journey.

To read more about the Rules and Hooks deprecation, read our blog post: [Preparing for Rules and Hooks End of Life](https://auth0.com/blog/preparing-for-rules-and-hooks-end-of-life/).

</Warning>

At the Client Credentials Exchange extensibility point, Hooks let you execute custom actions when an <Tooltip tip="Access Token: Authorization credential, in the form of an opaque string or JWT, used to access an API." cta="View Glossary" href="/docs/glossary?term=Access+Token">Access Token</Tooltip> is issued through the Authentication API [`POST /oauth/token` endpoint](https://auth0.com/docs/api/authentication#client-credentials-flow) using the Client Credentials Flow. For example, you may deny the token from being issued, add custom claims to the access token, or modify its scopes. To learn more, read [Client Credentials Flow](/docs/get-started/authentication-and-authorization-flow/client-credentials-flow).

この拡張ポイントでのフックはブロッキング（同期的）であり、トリガーのプロセスの一部として実行されます。そのため、フックが完了するまでAuth0パイプラインの他の部分の実行が停止されます。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

The `triggerId` for the Client Credentials Exchange extensibility point is `credentials-exchange`. To learn how to create hooks for this extensibility point, read [Create Hooks](/docs/customize/hooks/create-hooks).

</Callout>

To learn about other extensibility points, read Extensibility Points.

## スターターコードとパラメーター

Client Credentials Exchange（クライアント資格情報交換）拡張ポイントで実行されるフックを作成する際、以下のスターターコードが役立つかもしれません。Hook関数に渡され、使用されることができるパラメーターは、コード例の最上部にリストされています。

```javascript lines expandable
/**
@param {object} client - client information
@param {string} client.name - client name
@param {string} client.id - client ID
@param {string} client.tenant - Auth0 tenant name
@param {object} client.metadata - client metadata
@param {array|undefined} scope - either an array of strings representing the token's scope claim, or undefined
@param {string} audience - token's audience claim
@param {object} context - Auth0 context info
@param {object} context.webtask - Hook (webtask) context
@param {function} cb - function (error, accessTokenClaims)
*/

module.exports = function(client, scope, audience, context, cb) {
  var access_token = {};
  access_token.scope = scope; // do not remove this line

  // Modify scopes or add extra claims
  // access_token['https://example.com/claim'] = 'bar';
  // access_token.scope.push('extra');

  // Deny the token and respond with an OAuth2 error response
  // if (denyExchange) {
  //   // To return an HTTP 400 with { "error": "invalid_scope", "error_description": "Not authorized for this scope." }
  //   return cb(new InvalidScopeError('Not authorized for this scope.'));
  //
  //   // To return an HTTP 400 with { "error": "invalid_request", "error_description": "Not a valid request." }
  //   return cb(new InvalidRequestError('Not a valid request.'));
  //
  //   // To return an HTTP 500 with { "error": "server_error", "error_description": "A server error occurred." }
  //   return cb(new ServerError('A server error occurred.'));
  // }

  cb(null, access_token);
};
```






以下の点にご注意ください。

* サンプルコードの終わりにあるコールバック関数（`cb`）は、完了を知らせるもので、必ず含まれなければなりません。

* `access_token.scope = scope`という行は、すべての付与されたスコープがアクセストークンに存在するようにします。それを取り除くとすべてのスコープをリセットすることになり、トークンにはスクリプトで追加したスコープのみ含まれます。

### デフォルトの応答

Client Credentials Exchange（クライアント資格情報交換）拡張ポイントでフックを実行すると、デフォルトの応答オブジェクトは次のようになります。

```json lines
{
  "scope": "array of strings"
}
```






### スターターコードの応答

スコープと追加クレームを使用してスターターコードをカスタマイズしたら、Hookエディタに埋め込まれたランナーを使用してフックをテストできます。ランナーは、Client Credentials Exchange（クライアント資格情報交換）で得られるものと同じ要求ボディと応答を使ってフックへの呼び出しをシミュレートします。

<Warning>

Executing the code using the runner requires a save, which means that the original code will be overwritten.

</Warning>

スターターコードに基づいたフックを実行する場合、応答オブジェクトは以下の通りになります。

```json lines
{
  "audience": "https://my-tenant.auth0.com/api/v2/",
  "client": {
    "id": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "name": "client-name",
    "tenant": "my-tenant",
    "metadata": {
      "plan": "full"
    }
  },
  "scope": [
    "read:connections"
  ]
}
```






## スクリプト例：アクセストークンに追加スコープを追加する

この例では、既存のスコープに加えてアクセストークンに追加のスコープを付与するためにフックを使用します。

```js lines
module.exports = function(client, scope, audience, context, cb) {
    // Scopes to be added
    var access_token = {};

    // Get the scope that's currently on the Access Token
    // and add it to the object we're working with
    // Do not remove this line!
    access_token.scope = scope;

    // Append the `read:resource` scope
    access_token.scope.push('read:resource');

    // Callback to indicate completion and to return new
    // array of scopes
    cb(null, access_token);
};
```






To learn more, read [Scopes](/docs/get-started/apis/scopes).

### 応答

このフックを実行すると、応答オブジェクトは次のようになります。

```json lines
{
  "scope": [
    "read:connections",
    "read:resource"
  ]
}
```






## スクリプト例：アクセストークンにクレームを追加する

In this example, we add a namespaced custom claim and its value to the access token. To learn more, read [Create Namespaced Custom Claims](/docs/secure/tokens/json-web-tokens/create-custom-claims).

以下をクレームとして発行済みトークンに追加できます。

* 応答オブジェクトの`scope`プロパティ
* 名前空間プロパティ名のあるすべてのプロパティ

拡張ポイントは、その他すべての応答オブジェクトプロパティを無視します。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

To access a configured Hook Secret from within a hook, use `context.webtask.secrets.SECRET_NAME`.

</Callout>

```js lines
module.exports = function(client, scope, audience, context, cb) {
    // Claims to be added
    var access_token = {};

    // New claim to add to the token
    access_token['https://example.com/foo'] = 'bar';

    // Callback to indicate completion and to return new claim
    cb(null, access_token);
  };
```






### 応答

このフックを実行すると、応答オブジェクトは次のようになります。

```json lines
{
  "https://example.com/foo": "bar"
}
```






## スクリプト例：エラーを発生させる、またはアクセストークンを拒否する

In this example, we use custom Error objects to generate OAuth2 Error Responses. (To learn more, see [OAuth2 RFC - Section 5.2 in the IETF Datatracker](https://tools.ietf.org/html/rfc6749#section-5.2).)

コールバック内で次のような単純なJavaScriptエラーが返された場合に、

```js lines
module.exports = function(client, scope, audience, context, cb) {
    // Callback to indicate completion and to return new claim
    cb(new Error("Unknown error occurred.");
  };
```






そして、`/oauth/token`エンドポイントから`client_credentials`の付与を要求すると、Auth0は次のように応答します。

```json lines
HTTP 500
{ "error": "server_error", "error_description": "Unknown error occurred." }
```






そして、`/oauth/token`エンドポイントから`client_credentials`の付与を要求すると、Auth0は次のように応答します。

### そして、`/oauth/token`エンドポイントから`client_credentials`の付与を要求すると、Auth0は次のように応答します。

```js lines
module.exports = function(client, scope, audience, context, cb) {
    const invalidScope = ...; // determine if scope is valid

    if(invalidScope) {
      cb(new InvalidScopeError("Scope is not permitted."));
    }
  };
```






Then when you request a `client_credentials` grant is from the `/oauth/token` endpoint, Auth0 responds with:

```json lines
HTTP 400
{ "error": "invalid_scope", "error_description": "Scope is not permitted." }
```






### ServerError

```js lines
module.exports = function(client, scope, audience, context, cb) {
    const invalidRequest = ...; // determine if request is valid

    if(invalidRequest) {
      cb(new InvalidRequestError("Bad request."));
    }
  };
```






そして、`/oauth/token`エンドポイントから`client_credentials`の付与を要求すると、Auth0は次のように応答します。

```json lines
HTTP 400
{ "error": "invalid_request", "error_description": "Bad request." }
```






### ServerError

```js lines
module.exports = function(client, scope, audience, context, cb) {
    callOtherService(function(err, response) {
      if(err) {
        return cb(new ServerError("Error calling remote system: " + err.message));
      }
    });
  };
```






Then when you request a `client_credentials` grant from the `/oauth/token` endpoint, Auth0 responds with:

```json lines
HTTP 400
{ "error": "server_error", "error_description": "Error calling remote system: ..." }
```






<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

Currently, the behavior of the built-in JavaScript `Error` class and `ServerError` is identical, but the `ServerError` class allows you to be explicit about the OAuth2 error that will be returned.

</Callout>

## Learn more