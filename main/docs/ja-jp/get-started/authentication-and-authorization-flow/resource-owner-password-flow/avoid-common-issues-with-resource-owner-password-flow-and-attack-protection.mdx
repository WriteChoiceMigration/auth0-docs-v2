---
og:description: Learn how to avoid common issues encountered when using the Resource
  Owner Password Flow to call server-side APIs with attack protection enabled.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: リソース所有者のパスワードフローと攻撃防御のよくある不具合を回避する
og:url: https://auth0.com/docs/
permalink: avoid-common-issues-with-resource-owner-password-flow-and-attack-protection
title: リソース所有者のパスワードフローと攻撃防御のよくある不具合を回避する
twitter:description: Learn how to avoid common issues encountered when using the Resource
  Owner Password Flow to call server-side APIs with attack protection enabled.
twitter:title: リソース所有者のパスワードフローと攻撃防御のよくある不具合を回避する
---



推奨はされませんが、信頼性の高いアプリケーションでは、[リソース所有者のパスワードフロー](/login/flows/resource-owner-password-flow)（リソース所有者のパスワード付与（ROPG）とも呼ばれる）を使ってサーバー側APIを呼び出すことができます。このフローは、ユーザーに資格情報（ユーザー名とパスワード）の提供を要求するもので、通常は対話型フォームを使用します。Auth0でこの資格情報を検証中に[総当たり攻撃防御が有効](/attack-protection/brute-force-protection)になっている場合、[攻撃の有無も確認](/attack-protection)され、攻撃が検出されたら適切な措置が講じられます。

残念ながら、このフローと総当たり攻撃防御を併用する場合には、一部の攻撃防御が機能しない可能性があります。ただし、いくつかの問題は回避することができます。

## 攻撃防御とサーバー側API

総当たり攻撃防御と不審なIPのスロットリングは、ユーザーのIPアドレスに応じて行われます。サーバーからAPIを呼び出す場合、Auth0はサーバーのIPアドレスをユーザーのIPアドレスとして扱い、総当たり攻撃防御と不審なIPのスロットリング機能への入力として報告します。これにより、誤検出が発生する可能性があり、攻撃防御がユーザーをブロックしたり、正当な要求にもかかわらず警告が表示される恐れがあります。

これを回避するには、ユーザーのIPアドレスを資格情報とともにAuth0に送り、IPアドレスを信頼するようにアプリケーションを構成します。



## IPアドレスを信頼するようにアプリケーションを構成する

[通常のWebアプリケーション](/get-started/create-apps/regular-web-apps)または[マシンツーマシンアプリケーション](/get-started/create-apps/machine-to-machine-apps)を登録します。アプリケーションの構成中に、以下の操作を行います。

1. **［Settings（設定）］**で、`None`以外の**［Token Endpoint Authentication Method（トークンエンドポイント認証方法）］**を選択します。
2. **［Advanced Settings（高度な設定）］**の**［OAuth］**タブで、**［Trust Token Endpoint IP Header（トークンエンドポイントのIヘッダーを信頼する）］**を有効にします。これにより、総当たり攻撃防御に対して、`auth0-forwarded-for`ヘッダーがユーザーのIPアドレスの信頼できるソースとして設定されます。この設定は、非認証アプリケーションでは利用できません。

## サーバーからユーザーのIPアドレスを送信する

1. [リソース所有者のパスワードフロー](/login/flows/call-your-api-using-resource-owner-password-flow)を使用してトークンを要求する場合には、ユーザーのIPアドレスの値が入った`auth0-forwarded-for`ヘッダーを含めてください。入力したIPアドレスがユーザーのもので間違いないことを確認します。
2. 総当たり攻撃防御と不審なIPのスロットリングをトリガーするときに、IP許可リストを無視するように指定します。



### 例



## 侵害されたパスワードの検出応答の処理

テナントの[［Breached Password Detection（侵害されたパスワードの検出）］](/attack-protection/breached-password-detection)が有効な場合は、[Auth0 Authentication API](/docs/api/authentication)からの応答に適宜対処するようアプリケーションを構成する必要があります。

たとえば、ROPフローを使ってパスワードを送信してAuth0で侵害が検出された場合、Authentication APIはHTTP `401 Unauthorized`ステータスコードと次の本文が記述された応答を返します。



アプリケーションはこのエラーを処理し、メッセージをユーザーに表示し、[インタラクティブなパスワードリセットフローをトリガー](/docs/authenticate/database-connections/password-change#authentication-api)します。

## ログで検証する

設定が正しく機能している場合は、ログに以下のように表示されます。