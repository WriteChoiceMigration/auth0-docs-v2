---
og:description: Describes how to use information from the Authorization Extension
  in rules.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: 認可拡張でルールを使用する
og:url: https://auth0.com/docs/
permalink: use-rules-with-the-authorization-extension
title: 認可拡張でルールを使用する
twitter:description: Describes how to use information from the Authorization Extension
  in rules.
twitter:title: 認可拡張でルールを使用する
---

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

Auth0 provides two ways to implement role-based access control (RBAC), which you can use in place of or in combination with your API's own internal access control system:

* [Authorization Core](/docs/manage-users/access-control/rbac)
* [Authorization Extension](/docs/customize/extensions/authorization-extension)

The Authorization Core feature set matches the functionality of the Authorization Extension, improves performance and scalability, and provides a more flexible RBAC system than the Authorization Extension.

Currently, both implement the key features of RBAC and allow you to restrict the custom scopes defined for an API to those that have been assigned to the user as permissions.

</Callout>

Auth0ルールを認可拡張と併用すると、次のようなことが可能になります：

* 発行されたトークンにカスタムクレームを追加します。
* ユーザーのグループメンバーシップ、ロール、および権限を決定します。
* ユーザーのグループ、ロール、および権限情報を`app_metadata`の一部として保存します。
* 送信トークンにユーザーのグループ、ロール、および権限を追加します（これは、`openid groups permissions roles`スコープを介して要求できます）。

上記のロジックはルールの一部であるため、ログインのコンテキストでのみ実行されます。ユーザーがグループに追加またはグループから削除された場合、この変更はユーザーの次回ログイン後にのみAuth0に反映されます。

To learn more, read [Auth0 Rules](/docs/customize/rules).

## 発行されたトークンにカスタムクレームを追加する

トークンにカスタムクレームを追加するには、認可拡張がそれを行うことを許可する追加のルールを作成します。カスタムクレームは、名前空間付きまたは名前空間なしでもかまいません。

To learn more, read [Create Custom Claims.](/docs/secure/tokens/json-web-tokens/create-custom-claims)

トークンに追加するクレームの数を制限する必要があります。

```javascript lines
function (user, context, callback) {
  var namespace = 'http://yourdomain/claims/'; // You can set your own namespace, but do not use an Auth0 domain

  // Add the namespaced tokens. Remove any which is not necessary for your scenario
  context.idToken[namespace + "permissions"] = user.permissions;
  context.idToken[namespace + "groups"] = user.groups;
  context.idToken[namespace + "roles"] = user.roles;
  
  callback(null, user, context);
}
```






このルールは、認可拡張ルールの**［after（後）］**に実行する必要があります。これを確実に行うには、認可拡張ルールの下に配置してください。

アプリのアクセスを制御する

## また、アプリケーションへのアクセスを制御するなどの操作を行うために、認可拡張ルールの後に実行されるルールを記述することもできます。これを行う1つの方法は、アプリケーションメタデータを使用して、各アプリケーションに必要なロールを指定することです。

詳細については、[ルールを使用したメタデータの管理](/users/metadata/manage-metadata-rules)をお読みください。

For more details, review [Manage Metadata with Rules](/docs/manage-users/user-accounts/metadata/manage-metadata-rules).

### ロールを使用してアプリのメタデータを設定できます。ロールとは、特定の機能セットを作成するためにグループ化された権限のグループです。この手順は、セットアップしたルールがどのアプリに対してアクションを実行するかを認識できるように、アプリに「タグ付け」することと考えることができます。

ルールを適用するアプリロールを作成する

1. ⁠⁠⁠⁠To set the `context.clientMetadata` field with `required_roles`, select the application you want to work at [Auth0 Dashboard > Applications > Applications](https://manage.auth0.com/#/applications).
   各アプリにロールが関連付けられたので、コンテキスト内でこのアプリ情報を使用してルール実行を作成できます。
2. Under **Application Metadata** add an item setting the **Key** to `required_roles` and in **Value** field list your roles in comma separated style. Select **+ Add** to add the field.
3. When finished, select **Save Changes**. Now, when you log in from this application, in `context.clientMetadata`, you will have the `required_roles` with the roles value string you entered.

### Create rule enforcing app roles

Now that each app has a role associated with it, you can create the rule executes with this piece of app information in context.

1. Before creating this rule, enable **Roles** under the **Token Contents** and publish the Authorization Extension rule.
2. Add this rule and make sure it is listed after the generated "auth0-authorization-extension" rule.
3. After setting `required_roles`, create a new [rule](https://manage.auth0.com/#/rules) with the following body:

   ```javascript lines
   function (user, context, callback) {
     context.clientMetadata = context.clientMetadata || {};
     if (context.clientMetadata.required_roles && context.clientMetadata.required_roles.length){
       if (user.roles) {
         var _ = require('lodash');
         var roles = context.clientMetadata.required_roles.split(',');
         var matchingRoles =_.filter(user.roles, function(roleName) {
           return _.includes(roles, roleName);
         });

         if (matchingRoles && matchingRoles.length) {
           return callback(null, user, context);
         }
       }

       return callback(new UnauthorizedError('You do not have the required role to access ' + context.clientName));
     }

    callback(null, user, context);
   }
   ```


   

   

## Learn more

* [Import and Export Authorization Extension Data](/docs/customize/extensions/authorization-extension/import-and-export-authorization-extension-data)
* [Enable API Access to Authorization Extension](/docs/customize/extensions/authorization-extension/enable-api-access-to-authorization-extension)
* [Troubleshoot Authorization Extension](/docs/troubleshoot/authentication-issues/troubleshoot-authorization-extension)