---
og:description: Troubleshooting invalid state errors in the Login by Auth0 WordPress
  plugin
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: WordPressプラグインの無効な状態エラーのトラブルシューティング
og:url: https://auth0.com/docs/
permalink: troubleshoot-wordpress-plugin-invalid-state-errors
title: WordPressプラグインの無効な状態エラーのトラブルシューティング
twitter:description: Troubleshooting invalid state errors in the Login by Auth0 WordPress
  plugin
twitter:title: WordPressプラグインの無効な状態エラーのトラブルシューティング
---

We added state validation to WordPress plugin version 3.6.0, which you can find in the [wp-auth0 GitHub repository](https://github.com/auth0/wp-auth0/releases/tag/3.6.0). This security measure helps mitigate CSRF attacks by ensuring that the response belongs to a request initiated by the same user To learn more, read [Prevent Attacks and Redirect Users with OAuth 2.0 State Parameter](/docs/secure/attack-protection/state-parameters).

## 状態検証の仕組み

プラグインは以下のようにして状態検証を行います。

1. Setting an `auth0_state` cookie in the browser via Javascript when the Lock login form is shown (on `wp-login.php` or any other page when using a shortcode or widget).
2. Passing that value to the Lock embedded login form so it can be sent with the authentication request.
3. Receiving that value back from Auth0 unchanged in a `state` URL parameter if the Auth0 login was successful.
4. Validating the that value received matches the value sent and stored in the `auth0_state` cookie. If it's valid, then the login process continues. If not, the process stops and an "Invalid state" error message is shown.
5. Deleting the cookie, regardless of validity.
6. Using values in the base64 decoded object to redirect or perform other login actions, if valid.

この処理は、ログインしているユーザーとサイト管理者には完全に不透明でなくてはなりません。Auth0サーバーは状態値の検証や要求はしません。受け取った値をそのまま変えずに、コールバックURLへ返します。「無効な状態」メッセージが表示されたら、上記1～4のいずれかの手順が実行されません。

## 無効な状態エラーによくある原因

以下では、無効な状態エラーの一般的な原因と問題を解決する手順について説明します。

### キャッシュされているコールバックURL

無効な状態エラーの最もよくある原因は、コールバックURLがサーバーでキャッシュされている場合です。

Exclude caching on your server for all the URLs listed in the **Allowed Callback URLs** field in [Auth0 Dashboard > Applications > Applications > Settings](https://manage.auth0.com/#/applications/{yourClientId}/settings) and test again. In addition, exclude caching the site URL (`/index.php` on a regular install) if it has an Auth0 URL parameter.

それでも問題が解決されない場合には、以下のトラブルシューティングを試してみてください。

キャッシュされたCookieとURLパラメーター

### WP-Engineなど、管理対象ホストの場合には、担当のサポートチームに追加のサポートを依頼してください。コールバックURLで必要なCookieを使用できない問題や、ログイン後のユーザーに表示される最終ページで認証を確認できない問題が報告されています。具体的に、以下をキャッシュ対象から除外してもらってください。

**Cookie：**`auth0_state`

* **Cookie：**`auth0_nonce`
* **Arg/URLパラメーター：**`auth0`
* **Arg/URLパラメーター：**`code`
* **Arg/URLパラメーター：**`state`
* **Arg/URLパラメーター：**`id_token`
* エラーメッセージ後のページ更新

### 他のエラーメッセージ（メール検証など）が表示された後でページを更新すると、すでに使用済みの値を検証し直そうとするため、無効な状態メッセージが表示されます。これは正常な動作です。

Cookie名に関する要件

### Pantheonなど、ホストによっては、特定のCookie名の使用を要求するところもあります。テーマまたはカスタムプラグインで`auth0_state_cookie_name`フィルターを使用して、Cookie名を変更できます。`auth0_state_cookie_name`フィルターの詳細については、[Auth0 Wordpressプラグインのログイン時間を延長する](/cms/wordpress-plugin/extend-login-by-auth0)をお読みください。その他の情報については、[関連するGitHubの問題を参照し]()、[その修正方法を確認して]()ください。

Some hosts, like Pantheon, require specific cookie names to be used. You can alter the cookie name using the `auth0_state_cookie_name` filter in your theme or a custom plugin. To learn more about the `auth0_state_cookie_name` filter, read [Extend Login by Auth0 WordPress Plugin](/docs/customize/integrations/cms/wordpress-plugin/extend-login-by-auth0). For additional information, [see the related GitHub issue](https://github.com/auth0/wp-auth0/issues/494) and [explore its fix](https://github.com/auth0/wp-auth0/pull/495).

### サイトがユニバーサルログインを使用していて、テーマやプラグインで独自にリンクを作成している場合には以下を行います。

If your site is using the <Tooltip tip="Universal Login: Your application redirects to Universal Login, hosted on Auth0's Authorization Server, to verify a user's identity." cta="View Glossary" href="/docs/glossary?term=Universal+Login">Universal Login</Tooltip> Page and you're building the link yourself in a theme or plugin, you need to:

* その値を`state` URLパラメーターで送信します。
* または、［Settings（設定）］ > ［Features（機能）］タブ > ［Universal Login Page（ユニバーサルログインページ）］に移動し、ログイン要求を`wp-login.php`ページにリダイレクトすれば、そのCookieとURLパラメーターが自動的に設定されます。カスタムで作成した`/authorize` URLを引き続き使用する場合は、[GitHubリポジトリでこの処理を実行するコードを確認]()できます。

Alternatively, you can go to Settings > Features tab > Universal Login Page and redirect login requests to the `wp-login.php` page where that cookie and URL parameter will be set automatically. If you want to continue to use a custom-built `/authorize` URL, you can [see the code that runs this process in the GitHub repository](https://github.com/auth0/wp-auth0/blob/master/lib/WP_Auth0_LoginManager.php#L90).

### コールバックURL（通常は`yourdomain.com/index.php?auth0=1`）を直接、または認可コードの交換後の二度目に開く場合には、無効な状態エラーが表示されることがあります。これは、状態がすでに確認され、削除されていることを示しています。

無効な状態エラーのトラブルシューティング

## 以下にある一部の手順には、ログイン処理の中断（注記あり）が必要になります。

この値が設定されていない場合には、JavaScript Consoleでエラーを探して、使用しているブラウザーがCookieを許可できることを確認します（Cookieを使用しないとログインは動作しません）。これは`/assets/js/lock-init.js`で設定されています。[このコードはGitHubで表示]()できます。

1. While logged out of WordPress and Auth0, visit the login page being tested.
2. Check if the `auth0_state` cookie is being set (in Chrome, View > Developer > JavaScript Console > Application tab > Storage on the left > Cookies > domain being tested, look for an `auth0_state` cookie with a non-empty value).

   * If this value is not set, check for errors in the JS console and make sure that your browser can accept cookies (login will not work without cookies). This is set in `/assets/js/lock-init.js`. You can [view this code on GitHub](https://github.com/auth0/wp-auth0/blob/master/assets/js/lock-init.js#L22).
   * If the value is set, copy the value and view the source code of the page (in Chrome, **View** > **Developer** > **View Source**). Search for the value, and it should appear as the value associated with parameter `wpAuth0LockGlobal.settings.auth.params.state` ([view sample JSON](https://gist.github.com/joshcanhelp/1b8bb990048325eb7214e2b3d7136b78)). Make a note of this value (you'll need it in a following step).
3. If the value appears there and the Lock form is loading normally then steps 1 and 2 from the first list above are functioning properly.
4. Before logging in, [add this code snippet to the top of your `wp-config.php`](https://gist.github.com/joshcanhelp/ba98f748747c7fd2ecdf54e73c6110f3), so you can do a test install. **WARNING**: This will break login for the WordPress site being tested, so use it only on a non-production install.
5. Log in normally.
6. After you're redirected back to your site's callback URL, the process will stop. You should see an output like what's shown in the linked Gist in step #4 above. If you see something like `Array()` with no additional values, then one of two things could be happening:

   * サーバーがAuth0 Cookieを読み取らない。実行できる解決策については、[関連するGitHubの問題を参照し]()、[その修正方法を確認して]()ください。
   * The server is not reading the Auth0 cookie. For a possible solution, [see the related GitHub issue](https://github.com/auth0/wp-auth0/issues/494) and [explore its fix](https://github.com/auth0/wp-auth0/pull/495).
7. If the values are present, check the response headers for the callback URL being loaded (in Chrome, View > Developer > JavaScript Console > Network tab, click the first "document" listed with a 500 status and look for "Response Headers"). Look for any evidence of caching here, like a `Cache-Control` with a non-zero `max-age`, an `x-cache` of something other than `MISS`, or any other clue that this page is being served from a cache.
8. Also in the response headers, check that `set-cookie` includes a directive like `auth0_state=deleted` to confirm the validation process is happening.
9. Make sure that the `state` parameter in the URL matches the one recorded from the cookie being set in step #3 above.
10. If there is no evidence of caching, remove the debugging snippet from `wp-config.php` and refresh the callback URL. You should see the "Invalid state" message again. If any caching changes were made, attempt the login process all the way through (make sure to clear your cookies and browser cache for the site before testing).

異なる場合には、上記の手順3で記録された元の値と一致しているはずです。これは、`$_COOKIE`の状態値が処理中のどこかで変わったということになります。

11. Next, we need to check why the state is coming in but does not match the stored value.

12. In `lib/WP_Auth0_LoginManager.php`, output the values of the stored and returned state and stop the process after. Just before [line 148](https://github.com/auth0/wp-auth0/blob/master/lib/WP_Auth0_LoginManager.php#L148), add:

```bash wrap lines
echo '<h1>$_REQUEST</h1>'; var_dump($_REQUEST); echo '<h1>$_COOKIE</h1>'; var_dump($_COOKIE); die('<h1>Done</h1>');
```






13. Once again, make sure you're logged out and complete the login process.

14. You should see values output when redirected back to the WordPress callback URL.

15. Check if the `state` value in `$_REQUEST` exists and matches the `auth0_state` value in `$_COOKIE`.

* 上記の手順でこの問題が解決されない場合には、上記の手順の結果を集めて、[サポートにお問い合わせいただく]()か、`wordpress`のタグを付けて[コミュニティに投稿して]()ください。また、以下を記載してください。

If none of the steps above resolve the issue, please collect the results of the steps above and [contact support](https://support.auth0.com/) or [post on Community](https://community.auth0.com/tags/wordpress) with the tag `wordpress`. Also include:

* WordPressのバージョン
* Auth0プラグインのバージョン
* テストに使用したブラウザーとOS
* ログインフォームを使ってページを読み込むところから、「無効な状態」メッセージを受け取るところまで、処理の全体を記録したHARファイルHARファイルの詳細については、[HARファイルの生成と分析](/troubleshoot/tools/generate-and-analyze-har-files)をお読みください。
* A HAR file recording the entire process from loading the page with the login form all the way through the "Invalid state" message. To learn more about HAR files, read [Generate and Analyze HAR Files](/docs/troubleshoot/troubleshooting-tools/generate-and-analyze-har-files).

  <Warning>

  Before sharing a HAR file with anyone (including Auth0), ensure that you remove or obfuscate all sensitive data, such as:

  + Confidential user information
  + Personal identifiable information (PII)
  + Confidential application information

  To learn more, read the following articles on [Auth0 Community](https://community.auth0.com):

  + [Sanitizing HTTP Traces](https://community.auth0.com/t/sanitizing-http-traces/119488)
  + [How to Sanitize an HTTP Trace File Automatically](https://community.auth0.com/t/how-to-sanitize-a-http-trace-file-automatically/120583)
  + [How to Manually Redact Sensitive Information](https://community.auth0.com/t/how-to-manually-redact-sensitive-information/122554)
  + [HAR File is Too Large to Upload to the Support Case](https://community.auth0.com/t/har-file-is-too-large-to-upload-to-the-support-case/122488)
  </Warning>

## Auth0コミュニティの[Auth0 WordPressのリダイレクト中の「無効な状態」エラー]()

* ["Invalid state" error during Auth0 WordPress redirect](https://community.auth0.com/t/invalid-state-error-during-auth0-wordpress-redirect/12552/16) in Auth0 Community
* [Invalid state when visiting the callback URL directly](https://wordpress.org/support/topic/unable-to-resolve-troubleshooting-with-a-client-grant-for-already-exists/) on wordpress.org