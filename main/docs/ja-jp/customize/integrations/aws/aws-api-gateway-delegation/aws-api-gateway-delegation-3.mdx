---
og:description: Step 3 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: AWS API Gatewayチュートリアルの手順3
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-3
title: AWS API Gatewayチュートリアルの手順3
twitter:description: Step 3 of Amazon API Gateway Tutorial
twitter:title: AWS API Gatewayチュートリアルの手順3
---



## 手順3：アプリケーションの構築

この手順では、AngularJS frameworkおよび静的Webサイトとして機能するように構成されたAWS S3バケットを使用して、シングルページのサーバーレスアプリケーションを構築します。

### 1.サンプルアプリケーションのセットアップ

シンプルなスターターアプリについては、このチュートリアル固有の[サンプルプロジェクトをダウンロード](https://github.com/auth0/auth0-aws/tree/master/examples/api-gateway/client)して始めてください。Auth0資格情報を事前構成するためにログインします。

このシードプロジェクトのコンテンツを`pets`という名前のローカルフォルダーにコピーします。これは、チュートリアルのリマインダーとして使用します。このフォルダー内で、`auth0-variables.js`をAuth0アプリケーション`AUTH0_CLIENT_ID`および`AUTH0_CLIENT_ID`（この情報はアプリケーションの[Management Dashboard](%24%7Bmanage_url%7D/#/applications)で利用可能）で更新します。

#### AWS S3バケット

[静的Webサイトとして機能するように構成してAWS S3バケットを作成](http://docs.aws.amazon.com/gettingstarted/latest/swh/website-hosting-intro.html)してください。セットアッププロセス中に、Webサイトにコンテンツを提供するために、`pets`フォルダーのコンテンツをS3バケットにコピーします。

既存のバケットを使用する場合は、以下のコマンドを使用して、AWS CLIのファイルを移動できます。



進める前に、ユーザー名-パスワード-認証（または使用しているアプリケーションと関連するデータベース接続）接続と関連するユーザーが少なくとも1名いることを確認してください。サンプルアプリの機能性およびAWSとの統合を完全に利用するには、認証をテストしてアクセスを得るために、そのユーザーが必要になります。

最後になりますが、アプリケーションの［Settings（設定）］ページの**［Allowed Origins（許可されたオリジン）］**フィールドにURLを提供することで、Auth0がWebサイトからの認証を許可することを確認してください。WebサイトのURLはこのようになっているはずです。

`http://your-bucket.s3-website-us-east-1.amazonaws.com`

URLが分からない場合は、S3バケットの**［Properties（プロパティ）］**タブのリストで確認できます。

先に進める前に、アプリケーションへのログインをテストします。ブラウザーで`http://your-bucket-domain/index.html`を開きます。ログインしたら、「getPets not implemented（getPetsが実装されていません）」という警告ボックスが表示されます。

また、ペットを確認するためのページが表示されます。

### AWSトークンを取得するために委任を使用する

この時点で、Auth0の認証をセットアップし、OpenID JWTが手元にあります。生成されたコードのディレクトリ構造は以下です。

Auth0の委任機能を使用して、Auth0 IDトークンに基づいたAWSアクセストークンを取得できます。バックエンドでは、Auth0がIDトークンを認証し、その後構成したアドオンに基づいてSAMLを使用します。

`auth.signin`でサインイン後にIDトークンからAWS委任トークンを取得するために、以下のように`pets/login/login.js`を更新します。ソーシャル接続を使用してログインしていないユーザーを管理者として取り扱っていることにご注意ください。後で、2つ目のロールをコーディングし、ロール選択を強制する、より良い方法をご紹介します。



#### `role`および`principal`文字列の変更

`role`および`principal`文字列（提供された関数に含まれる`if`ステートメントの最後の2列） を変更するには、[Rules](%24%7Bmanage_url%7D/#/rules)を介して適切な値を指定してください。



`role`および`[principal]` ARN値を統合するために更新してください。

更新済みのファイルを、WebサイトのS3バケットにコピーします。

オプションとして、ブラウザーのブレークポイントを`store.set('awstoken', delegation.Credentials);`に設定できます。ログアウトして再びログインした時に、ブレークポイントに到達したときの`delegation.Credentials`を調べます。AccessKeyIdやSecretAccessKeyなどの馴染みのある値が表示されます。



これらの値が表示されない場合は、Amazon Web ServicesのアドオンがAuth0アプリケーションのAddonsタブで有効になっていることを確認してください。

### AWS APIサービスでペットを表示

まず最初に行うことは、エンドユーザーにペットを表示することです。

#### APIコードを追加してAPIを呼び出す

サービスへのコールを追加するためにAPIコードを追加するには、前にダウンロードしたapiGateway-js-sdk.zipのコンテンツを`pets`ディレクトリにコピーします。コンテンツには以下が含まれます。

* `apiClient.js`;
* `lib`フォルダー
* `README.md`.

ダウンロードを確認するには、[AWS API Gatewayチュートリアルの手順2](/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#deploy-the-api)を参照してください。

`pets`ディレクトリにはすでに`README.md`があるため、ディレクトリ内の両方のファイルを維持するために、ファイルの１つの名前を変更する必要があります。APIゲートウェイの`README.md`は、Auth0アプリケーションのAPIアプリケーションの使用方法について説明しています。

`pets`フォルダーのルートにある`index.html`ファイルを開き、API readmeの上部にリスト表示されているスクリプトすべてを`index.html`に追加します。



`apigClient.js`を開くと、ダウンロード済みのライブラリーが、APIメソッドに`petsPost`および`petsGet`などのラッパーを作成していることを確認できます。これらの生成されたコードを変更する必要はありません。

#### `getPets`メソッドを構成する

`home`フォルダーの`home.js`を開き、`getPets`のコンテンツをペットデータを取得するメソッドで更新します（`us-east-1`で実行していない場合は、地域を更新してください）。



更新済みのコードを、S3バケットにコピーします。ページをリフレッシュして、2つの動物が表示されていることを確認します（前に説明したテストをAPIで実行した場合、これらのペットが作成されました）。

### AWS APIサービスでペットを更新

現在、APIゲートウェイでAuth0アプリケーションが機能しているので、`pets`テーブルを更新するためのメソッドを追加します。

`putPets`メソッドロジックを変更して、API関数を使用してペットを更新します。この関数は、ペットの追加と削除の両方に使用されます。



更新済みのコードを、S3バケットにコピーします。メソッドをテストします。

1. ログアウトし、ログインし直します
2. `Pet Type`および`Pet Price`の値に入力します。
3. **［Save（保存）］**をクリックしてデータをポストします。

「We have a `<Pet Type>` for sale for `<Pet Price>`（`<Pet Price>`で販売されている`<Pet Type>`がいます）」のメッセージと、左側に赤色の**［REMOVE（削除）］**ボタンが表示されます。

セキュリティを追加するために、`putPets`メソッドの始めに`getSecureApiClient`関数を追加します。



コードを、S3バケットにコピーします。

提供された`getSecureApiClient`関数は、APIへの委任を使用して取得したローカルストレージからAWSトークンを取得し、アクセスキー、シークレット、セッショントークンを使用します。