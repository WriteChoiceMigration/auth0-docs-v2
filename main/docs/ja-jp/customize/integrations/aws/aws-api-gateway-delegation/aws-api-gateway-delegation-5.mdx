---
og:description: Step 5 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: AWS API Gatewayチュートリアルの手順5
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-5
title: AWS API Gatewayチュートリアルの手順5
twitter:description: Step 5 of Amazon API Gateway Tutorial
twitter:title: AWS API Gatewayチュートリアルの手順5
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## 手順5 - IDフローにIDトークンを使用する

この最後の手順では以下を行います。

* Flow identity to the service by passing your <Tooltip tip="OpenID: Open standard for authentication that allows applications to verify users' identities without collecting and storing login information." cta="View Glossary" href="/docs/glossary?term=OpenID">OpenID</Tooltip> <Tooltip tip="OpenID: Open standard for authentication that allows applications to verify users' identities without collecting and storing login information." cta="View Glossary" href="/docs/glossary?term=JSON+Web+Token">JSON Web Token</Tooltip> (JWT);
* トークンを検証する
* プロファイル情報を抽出して、ペットの購入者を割り当てる

## IDトークンを使用する

You can use your Lambda function to process and obtain information about the user. For example, during a purchasing transaction, you retrieved the username from the profile returned with the <Tooltip tip="ID Token: Credential meant for the client itself, rather than for accessing a resource." cta="View Glossary" href="/docs/glossary?term=identity+token">identity token</Tooltip>. However, you can also choose to have the user's information embedded with the identity itself, which is a JSON Web Token (JWT).

JWTの使用する利点は、以下を行えることです。

1. Verify the authenticity of the JWT;
2. Be sure that the calling user is authenticated (instead of relying on a plain-text parameter that could have been tampered with).

その他にも、認可にJWTを使用して、Amazon API GatewayとのIAM統合を迂回することができます。認可にAPI Gatewayを使用すると、Lambda関数を呼び出す前にAPIの呼び出しを止められることに注意してください。

### JWTに情報を追加する

JWTにユーザー情報を追加するには、いくつかの方法があります。以下の例では、ユーザーのメールアドレスをJWTに追加していますが、概念は他のユーザーのデータポイントについても同じです。

#### ルールを使用する

One way to add a user's email address to the JWT is to use a [rule](/docs/customize/rules). This is a good approach if you want to make sure that this value is always available in the JWT for an authenticating user.

JWTにはユーザーのプロファイル全体を含めることもできますが、JWTは通常すべての要求で渡されるため、必要なものだけを含めるようにします。

```js lines
$scope.login = function() {
    var params = {
        authParams: {
          scope: 'openid email'
        }
      };

    auth.signin(params, function(profile, token) {
      ...
    }
  }
```






JWTトークンを検証する

## AWS Lambdaコンソールは、ブラウザーコンソールでNode.jsコードを入力する際に、限られた数のノードモジュールにのみアクセスするため、IDトークンを処理するパッケージとして追加でモジュールをインクルードして、Lambda関数をアップロードする必要があります。

詳細については、「[Node.jsを使って導入パッケージを作成する]()」と「[導入パッケージをアップロードしてテストする]()」をご覧ください。

For additional details, see [Creating Deployment Packages using Node.js](http://docs.aws.amazon.com/lambda/latest/dg/nodejs-create-deployment-pkg.html) and [Uploading Deployment Packages and Testing](http://docs.aws.amazon.com/lambda/latest/dg/walkthrough-s3-events-adminuser-create-test-function-upload-zip-test.html).

シードプロジェクト内には、以下の2つのカスタムJavaScriptファイルがあります。

```js wrap lines
<%= include('../../../_includes/_package', { org: 'auth0', repo: 'auth0-aws', path: 'examples/api-gateway/lambda' }) %>
```

`index.js`：メインコードが含まれています。

* `auth0-variables`：更新する必要のあるコードが含まれています。
* カスタムファイルに加えて、Node.jsに標準の`package.json`ファイルがあります。

コードは、JWTから情報を抽出して、JWTを検証するために機能性を追加します。Auth0はデフォルトで対称キーを使用しますが、非対称キーの使用を選ぶこともできます（サードパーティがトークンを検証可能にする必要がある場合には、非対称キーを使用して、公開鍵だけを共有します）。

トークン検証の詳細については、「[Auth0が対応しているIDプロトコル](/protocols)」をご覧ください。

For more information about token verification, see [Identity Protocols Supported by Auth0](/docs/authenticate/protocols).

Update `auth0-variables.js` with your secret key, which can be found on the Settings tab of your Application in the <Tooltip tip="Auth0 Dashboard: Auth0's main product to configure your services." cta="View Glossary" href="/docs/glossary?term=Auth0+Dashboard">Auth0 Dashboard</Tooltip>:

```javascript lines
var env={};
env.AUTH0_SECRET='{yourAuth0Secret}';
module.exports = env;
```


プロファイル情報を抽出して購入者を割り当てる

最後の手順では、JWTをブラウザーのクライアントが使用するメソッドに渡します。

```js lines
if(event.authToken) {
     jwt.verify(event.authToken, secret, function(err, decoded) {
         if(err) {
           console.log('failed jwt verify: ', err, 'auth: ', event.authToken);
           context.done('authorization failure', null);
         } else if(!decoded.email)
         {
           console.log('err, email missing in jwt', 'jwt: ', decoded);
           context.done('authorization failure', null);
         } else {
           userEmail = decoded.email;
           console.log('authorized, petId', petId, 'userEmail:', userEmail);
           dynamo.getItem({TableName:"Pets", Key:{username:"default"}}, readcb);
         }
     });
  } else {
     console.log('invalid authorization token', event.authToken);
     context.done('authorization failure', null);
  }
    ...
```






### 標準のメソッドには`Authorization`ヘッダーがBearerトークンとして含まれており、このメソッドを使用するには、IAM認証を無効にして、認証にOpenIDのトークンだけを使用する必要があります（AWS Lambda関数に渡すイベントデータにAuthorizationヘッダーをマッピングすることも必要です）。

ところが、IAMを使用している場合、AWS API Gatewayは`Authorization`ヘッダーにメッセージの署名を含んでいるため、このヘッダーにJWTを書き込むと認証が破壊されます。これは以下のいずれかの方法で対処します。

JWTのためにカスタムヘッダーを追加する

メッセージの本文にカスタムヘッダーを入れる

* カスタムヘッダーの使用を選んだ場合には、`pets/purchase`のPOSTメソッドの統合要求に何らかのマッピングを行う必要があります。
* 検証プロセスを続けるために、AWS Lambda関数へのPOSTの本文でJWTを渡します。これを行うには、以下のように、本文から`userName`を削除して、`authToken`を追加することで、`home.js`で`buyPet`メソッドを更新します。

S3のバケットにコードをアップロードして、ペットを購入しようとしてみてください。出力のメッセージに購入者のメールアドレスが表示されているはずです。

エラーがあった場合には、秘密鍵を正しく設定したことを確認してください。トークンのデコードの問題を確認する便利なツールの1つが、[jwt.io]()です。

```javascript lines
function buyPet(user, id) {
    var apigClient = getSecureApiClient();
    var body = {
      petId:id,
      authToken: store.get('token')
    };

    apigClient.petsPurchasePost({}, body)
      .then(function(response) {
        console.log(response);
        $scope.pets = response.data;
        $scope.$apply();
      }).catch(function (response) {
        alert('buy pets failed');
        showError(response);
    });
}
```


Summary（概要）

If you have any errors, double check that you have properly set your secret key. One useful tool for checking issues with your token decoding is [jwt.io](http://jwt.io/).

## AWS Lamdba関数を用いたメソッドなど、AWS API Gatewayを使ってAPIを作成する

IAMロールを使ってAPIへのアクセスを保護する

* APIへのアクセスをユーザーベースと結び付けて、SAML IDプロバイダーとIAMを統合する
* ユーザーがデータベース接続か、ソーシャル接続かを基にして、異なるレベルのアクセスを提供する
* Integrated a <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=SAML">SAML</Tooltip> <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=identity+provider">identity provider</Tooltip> with IAM to tie access to the API to your user base;
* JWTを使ってより細かな認証コンテキストを提供し、ID情報を適切なLambda関数に渡す
* Used an Auth0 rule to enforce role assignment;
* Used a JWT to provide further authorization context and pass identity information into the appropriate Lambda function.