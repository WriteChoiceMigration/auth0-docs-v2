---
og:description: Step 2 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: AWS API Gatewayチュートリアルの手順2
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-2
title: AWS API Gatewayチュートリアルの手順2
twitter:description: Step 2 of Amazon API Gateway Tutorial
twitter:title: AWS API Gatewayチュートリアルの手順2
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## 手順2 - Amazon API Gatewayのセキュリティ保護とデプロイ

APIが動き出したところで、セキュリティを追加する必要があります。この手順では以下を行います。

* アップデートAPIをセキュリティ保護し、特定のAWS IAMロールを持つ認証されたユーザーのみにアクセスを制限する。
* Auth0の委任を設定して、AWS IAMのフェデレーション機能が利用できるようにする。
* Obtain an AWS <Tooltip tip="Access Token: Authorization credential, in the form of an opaque string or JWT, used to access an API." cta="View Glossary" href="/docs/glossary?term=Access+Token">Access Token</Tooltip> that uses the AWS IAM role.

Once your API is secure, you'll build a serverless, single-page application (SPA). The SPA will rely on federating identity to determine which users are allowed access. By combining AWS IAM Integration for AWS Gateway API, AWS IAM Identity Federation for <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=SAML">SAML</Tooltip>, and Auth0 Delegation for AWS, you can enable users from many different sources, including Social Providers or enterprise connections, to access your APIs. The following diagram illustrates a sample flow using a SAML-based <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=Identity+Provider">Identity Provider</Tooltip> and Auth0 SAML Federation and Delegation for AWS.

このフローを実装する方法は2つあります。

1. Using Auth0 Delegation with AWS IAM;
2. Adding an identity token to flow identity to the Lambda function.

委任を使用すると、アプリケーション内でAWSサービスにアクセスするためのトークンをAWSから簡単に取得できます。

### Amazon API Gatewayをセキュリティ保護する方法

AWS API Gatewayには、APIをセキュリティ保護するためのいくつかの異なる方法があります。

1. API keys;
2. IAM;
3. [Amazon Cognito](/docs/customize/integrations/aws/aws-api-gateway-cognito).

APIキーの使用は、通常、以下に示されているようなサービス間でのやり取りに適しています。ただし、このアプローチには、いくつかの欠点があります。

* アプリケーションにライフタイムの長いシークレットを置くことはリスクが高い（アプリケーションが侵害されやすくなる）
* APIキーを発行および管理するためのフレームワークを作成するには、セキュリティ保護された実装が必要だが、この開発が難しい場合がある

This section of the tutorial will utilize IAM roles and policies to secure your API in API Gateway, but you can also choose to do so using user pools in Amazon Cognito. To review detailed instructions on securing your AWS API, read [Secure AWS API Gateway Using Cognito](/docs/customize/integrations/aws/aws-api-gateway-cognito). For more information on using IAM roles and policies, read the Amazon article, [Control access to an API with IAM permissions](http://docs.aws.amazon.com/apigateway/latest/developerguide/permissions.html). To read more about user pools in Cognito, visit [Amazon Cognit user pool](http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html).

### Step 1.API GatewayとのSAML統合のためにIAMとAuth0を構成する

AWSトークンと交換するSAMLトークンに対して、AWS IAMロールを指定することができます。そのIAMロールに付与された権限（IDプロバイダーを使用して設定）に応じて、受け取ったトークンも同じ許可を持つことになります。異なるSAMLトークンを発行し、それぞれに独自のAWS IAMロールを割り当てることで、ユーザーのアクセスレベルを制御することができます。

たとえば、IDPはグループメンバーシップ（例：Active Directoryの管理者）や認証ソース（例：データベース接続やFacebookなどのソーシャルプロバイダー）に基づいて、IAMロールを指定することができます。このアプローチを使用すると、AWS IAMを使用してセキュリティ保護されている場合に、Amazon API Gatewayのメソッドに対するユーザーアクセスを区別することができます。

#### Auth0の設定

Auth0アカウントにログインします。Management Dashboardが表示されます。ページの右上隅にある**［+ New Application（+新しいアプリケーション）］**をクリックします。

新しいアプリケーションに「AWS API Gateway」と名前を付け、このアプリケーションがシングルページアプリケーションであることを指定します。**［Create（作成）］**をクリックします。

新しく作成したアプリケーションの［Addons（アドオン）］タブに移動します。適切なスライドを使用して、Amazon Web Servicesを有効にします。これで、AWSの委任が有効になります。

#### AWSを構成する

Follow the [How to Set Up AWS for Delegated Authentication](/docs/customize/integrations/aws/how-to-set-up-aws-for-delegated-authentication) tutorial to configure AWS for delegated access, which uses SAML. Some caveats:

* リンク先のチュートリアルの権限ポリシーではなく、ロールに権限ポリシーを割り当てるには、[以下の指示](#setting-the-permissions-policy-on-your-iws-iam-role)に従ってください。
* 作成するSAMLプロバイダーに`auth0`と名前を付けます。
* AWS IAMロールに`auth0-api-role`と名前を付けます。

##### IWS IAMロールの権限ポリシーを設定する

Once you have configured the AWS IAM role, you will add a policy to `auth0-api-role` that lets you execute your API Gateway methods. For more information on this process, please see [User Access Permissions for Amazon API Gateway](http://docs.aws.amazon.com/apigateway/latest/developerguide/permissions.html).

#### Gateway API ARNを取得する

始める前に、Gateway APIのARNが必要です。

1. Navigate to [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway) and log in.
2. Select the appropriate API.
3. Click on any of the Methods associated with the API to bring up the Method Execution page.
4. On the Method Execution page, the Method Request box in the top left corner displays the **ARN** for the API, though it includes the Method name:

`arn:aws:execute-api:us-east-2:484857107747:97i1dwv0j4/*/POST/`

メソッド名を削除して、APIのベースのARNを取得します。

`arn:aws:execute-api:us-east-2:484857107747:97i1dwv0j4/*`

上記のARNにあるワイルドカード（`*`）を使うと、すべての段階でAPIの権限が有効になりますが、開発、テスト、運用など、異なる段階を個別にデプロイすることもできます。

先ほど作成した`auth0-api-role`ロールを選択して、その［Summary（サマリー）］ページを開きます。

**［Inline Policies（インラインポリシー）］**を展開し、**［click here（ここをクリック）］**をクリックします。

**［Custom Policy（カスタムポリシー）］**を選択し、**［Select（選択）］**をクリックします。

ポリシードキュメントを編集します。**［Policy Name（ポリシー名）］**は任意の名前に設定できますが、`api-gateway-policy`のような名前をお勧めします。このロールに対してAPIメソッドへのアクセスを有効にするために、API用にARNを更新した後、以下のポリシーを適用します。

```json lines
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "execute-api:*"
            ],
            "Resource": [
                "arn:[{yourArn}]"
            ]
        }
    ]
}
```






**［Apply policy（ポリシーを適用）］**をクリックします。

API Gatewayがユーザーに代わってこのロールを引き受けるため、信頼ポリシーはこのアクションを許可する必要があります。そのため、ロールの［Summary（サマリー）］ページのこのタブに移動して、ロールの信頼関係を編集します。

最終的な信頼関係は以下のようになるはずです。

```json lines expandable
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "auth0",
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::012345670:saml-provider/auth0-api"
      },
      "Action": "sts:AssumeRoleWithSAML",
      "Condition": {
        "StringEquals": {
          "SAML:iss": "urn:{yourDomain}"
        }
      }
    },
    {
      "Sid": "gateway",
      "Effect": "Allow",
      "Principal": {
        "Service": "apigateway.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```






At this point, you will need to set the Authorization Settings on the [API Gateway](https://console.aws.amazon.com/apigateway).

**［Resources（リソース）］**ビューで、`/pets`の下にあるPOSTメソッドを選択します。

**［Method Request（メソッドの要求）］**リンクをクリックします。

**［Authorization Type（認可タイプ）］**の横にある編集アイコンをクリックし、「AWS_IAM」を選択します。フィールドの横にある**チェックボタン**をクリックして、設定を保存します。

### Step 2.CORSをセットアップし、APIをデプロイする

シングルページアプリケーション（SPA）は、ページとは異なるドメインからWeb APIメソッドにアクセスします。Cross-Originリソース共有設定では、ブラウザーがAWS API Gatewayへのアクセスを許可できるようにするために、このアクションを明示的に許可する必要があります。通常、ブラウザーは最初に`OPTIONS`要求を発行して、サイトがどのアクションを許可するかを確認します。

［Resources（リソース）］の下にある`/pets`を選択し、**［Create Method（メソッドの作成）］**をクリックします。ドロップダウンで、**OPTIONS**を選択し、**チェックマーク**をクリックして設定を保存します。

Optionsメソッドは、ブラウザーが必要なHTTPヘッダーを取得するために使用しますが、この関数には、何をすべきかについてさらに指示を出す必要があります。`OPTIONS`セットアップ画面で、以下の変数/パラメーターを設定します。

* **［Integration type（統合タイプ）］**：Lambda関数
* **［Use Lambda Proxy Integration（Lambdaプロキシ統合を使用する）］**：チェックなしのまま
* **［Lambda Region（Lambdaリージョン）］**：ご自身のリージョンを選択
* **［Lambda Function（Lambda関数）］**：NoOp.

**［Save（保存）］**をクリックします。次のポップアップ画面で、Lambda関数に必要な権限を付与します。

すると、`OPTIONS`の［Method Execution（メソッドの実行）］ページが自動的に表示されます。［Method Respose（メソッドの応答）］ページを開きます。

HTTPステータスバーの下にある**200**セクションを展開し、以下の応答ヘッダーを追加します。

* Access-Control-Allow-Headers
* Access-Control-Allow-Methods
* Access-Control-Allow-Origin

次に、各応答ヘッダーに適切な値をマッピングします。［Method Execution（メソッドの実行）］ページに戻ったら、**［Integration Response（統合応答）］**をクリックします。**200**メソッド応答ステータスに関連付けられた行を展開した後、**［Header Mappings（ヘッダーのマッピング）］**を展開し、以下のマッピングを適用します。

* Access-Control-Allow-Headers：`'Content-Type,X-Amz-Date,Authorization,x-api-key,x-amz-security-token'`;
* Access-Control-Allow-Origin：`'*'`
* Access-Control-Allow-Methods：`'POST, GET, OPTIONS'`

最後に、上記の手順を繰り返して、POSTメソッドとGETメソッドのCORSを有効にします。ただし、これらの2つのメソッドに対しては、1つのヘッダー「Access-Control-Allow-Origin」を追加し、その値を`'*'`に設定する必要があります。

### APIをデプロイする

APIの**［Resources（リソース）］**ビューに戻ります。**［Actions］**をクリックし、**［DEPLOY API（APIのデプロイ）］**を選択します。

デプロイ状態に**［New Stage（新しい段階）］**を選択し、この段階に`Test`と名前を付けます。**［Deploy（デプロイ）］**ボタンをクリックします。

結果のページで、**［SDK Generation（SDK生成）］**に移動します。**プラットフォーム**にJavaScriptを選択します。**［Generate SDK（SDKの生成）］**ボタンをクリックします。

ダウンロードしたzipファイルは、後で使用するために保存しておきます。