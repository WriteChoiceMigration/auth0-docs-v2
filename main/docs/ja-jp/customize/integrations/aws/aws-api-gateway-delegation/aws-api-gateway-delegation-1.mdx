---
og:description: Step 1 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: AWS API Gatewayチュートリアルの手順1
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-1
title: AWS API Gatewayチュートリアルの手順1
twitter:description: Step 1 of Amazon API Gateway Tutorial
twitter:title: AWS API Gatewayチュートリアルの手順1
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## 手順 1 - Amazon API Gatewayのセットアップ

この手順を終えると、以下が完了した状態となります。

* Amazon DynamoDBテーブルからペットを取得して保管しているサービスロジックを実行するために、AWS Lambda関数を使用してAmazon API Gatewayがセットアップされる。
* ペットのリストの取得および更新のための認証されていない2つのRESTサービスメソッドが作成されている。

Prior to beginning, please have [Node.js](https://nodejs.org/) installed.

### Step 1.Amazon DynamoDBテーブルを作成する

In the [Amazon DynamoDB Console](https://console.aws.amazon.com/dynamodb), click on **Create Table**.

<Frame>![DynamoDB Console - Create Table](/images/cdy7uua7fh8z/2ZPhi7Ddx4TznSXEEhUSDK/52a06412f7c5e6d0ef0d13c6ffe17611/dynamodb-create-table.png)</Frame>

**［Table name（テーブル名）］**：Pets

* **［Primary key（プライマリキー）］**：ユーザー名
* **［Primary key type（プライマリキーの種類）］**：String（文字列）
* **［Use default settings（デフォルト設定を使用）］**：チェックなし
* **Read capacity units（読み込みキャパシティユニット）］**：3
* **Write capacity units（書き込みキャパシティユニット）］**：3
* **［Create（作成）］**をクリックして、指定した設定でテーブルを作成します。

<Frame>![DynamoDB Console - Configure Newly Created Table](/images/cdy7uua7fh8z/6MYJV97Xa3DxajG8DYj2dx/e428ab2ce137176d7771c61a9c528f7c/configure-newly-created-table.png)</Frame>

テーブルが作成されている間、［Table details（テーブル詳細）］セクションにあるAmazon Resource Name (ARN)をメモしておきます。次の手順で、このテーブルのARNが必要になります。

2.DynamoDB PetsテーブルへのアクセスをAWS Lambda関数に付与するポリシーを作成する

<Frame>![DynamoDB Console - Table Details - Amazon Resource Name](/images/cdy7uua7fh8z/4ZFemddtUD8tRi0NUvzXJ2/38abd951974cad385ef7417f48adf359/table-arn.png)</Frame>

### Step 左側のメニューの **［Roles（ロール）］**をクリックし、**［Create New Role（新しいロールを作成）］**ボタンをクリックします。

Navigate to the [AWS IAM Console](https://console.aws.amazon.com/iam).

［Role（ロール］タイプを選択します。［AWS Service Roles］の下の［AWS Lambda］を選択します。

<Frame>![IAM Console - Roles - Create New Roles](/images/cdy7uua7fh8z/4mgCTXLpycHLA8RbYoEFim/5d9eb81be979355aa9cd10d476ead515/roles.png)</Frame>

［Attach Policy（ポリシーのアタッチ）］の画面で、**［Next Step（次の手順）］**をクリックしてこの手順をスキップします。この時点で、ご自身が提供した情報を確認します。すべて正しい場合は、**［Create Role（ロールの作成）］**をクリックします。終了したら、IAMホームページにロールが記載されていることが確認できます。

作成したロール「**APIGatewayLambdaExecRole**」を選択します。［Inline Policies（インラインポリシー）］の下矢印をクリックして、 **［Click Here（ここをクリック）］**リンクをクリックします。

<Frame>![IAM Console - Select the Role Type - Service Roles - AWS Lambda](/images/cdy7uua7fh8z/326kKGbahlvIwVFTi61Gfw/026d1fc0c8c6e3a489ec4fb840f551da/select-role-type.png)</Frame>

［Custom Policy（カスタムポリシー）］を選択し、**［Select（選択）］**をクリックします。ポリシーに「`LogAndDynamoDBAccess`」という名前を付け、ポリシードキュメントとして以下のコードを追加します（必ずDynamoDBテーブルのAmazon Resource Name (ARN)を最初に更新してください）。**［Apply policy（ポリシーを適用）］**をクリックします。

2.AWS Lambda関数を作成する

次の3つの手順で、DynamoDBテーブルのペット情報を取得および更新するためのAWS Lambda関数を作成します。

```json lines
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AccessCloudwatchLogs",
      "Action": ["logs:*"],
      "Effect": "Allow",
      "Resource": "arn:aws:logs:*:*:*"
    },
    {
      "Sid": "PetsDynamoDBReadWrite",
                  "Effect": "Allow",
      "Action": [
                  "dynamodb:DeleteItem",
                  "dynamodb:GetItem",
                  "dynamodb:PutItem",
                  "dynamodb:UpdateItem"
                  ],
      "Resource": ["DYNAMODB_TABLE_ARN_VALUE_FROM_PREVIOUS_STEP"]
    }
   ]
}
```






### Step `GetPetInfo`のLambda関数を作成する

［Select blueprint（ブループリントの選択）］画面で、 **［Blank Function（ブランク関数）］**を選択します。

#### Create the Lambda Function for GetPetInfo

In the [AWS Lambda Console](https://console.aws.amazon.com/lambda), select **Create a Lambda Function** (if you have not created an AWS Lambda function before, you will click **Get Started Now**).

以下の情報を使用して、該当するフィールドに入力します。

**［Name（名前）］**：`GetPetInfo`

**［Runtime（ランタイム）］**：Node.js 6.10

DynamoDBテーブルからペット情報を読み込むために**［Lambda function code（Lambda関数コード）］**エリアに貼り付けます。

* ロールについては、**［Choose an existing role（既存のロールを選択）］**を選びます。次に、既存のロールとして**APIGatewayLambdaExecRole**を選択します。その他の設定はすべてデフォルト値のままにします。
* **［Next（次へ）］**をクリックして、ご自身が提供した情報を確認します。すべて正しい場合は、**［Create function（関数の作成）］**をクリックします。

**[Test（テスト）］**をクリックし、インプットテストイベントを（Hello Worldテンプレートを使用する）デフォルトのままにします。テストが完了したら、［Execution Result（実行結果）］セクションに空のアウトプット(`{}`)が表示されます。テーブルは空です。

```javascript lines
var AWS = require('aws-sdk');
var DOC = require('dynamodb-doc');
var dynamo = new DOC.DynamoDB();

exports.handler = function(event, context) {
   var cb = function(err, data) {
      if(err) {
         console.log('error on GetPetsInfo: ',err);
         context.done('Unable to retrieve pet information', null);
      } else {
         if(data.Item && data.Item.pets) {
             context.done(null, data.Item.pets);
         } else {
              context.done(null, {});
         }
      }
   };

   dynamo.getItem({TableName:"Pets", Key:{username:"default"}}, cb);
};
```






`UpdatePetInfo`のLambda関数を作成する

関数をテストするために、［Actions（アクション）］ドロップダウンをクリックし、**［Configure sample event（サンプルイベントの構成）］**を選択します。サンプルデータとして以下を入力し、**［Submit（送信）］**をクリックします。

空の結果(`{}`)が返されます。

#### Create the Lambda Function for UpdatePetInfo

もう一つLambda関数を作成します。この関数は何もしませんが、後のセクションで説明するように、CORSのOPTIONSメソッドで必要です。

```javascript lines
var AWS = require('aws-sdk');
var DOC = require('dynamodb-doc');
var dynamo = new DOC.DynamoDB();
exports.handler = function(event, context) {
    var item = { username:"default",
                 pets: event.pets || {}
            };

    var cb = function(err, data) {
        if(err) {
            console.log(err);
            context.fail('unable to update pets at this time');
        } else {
            console.log(data);
                context.done(null, data);
        }
    };
    dynamo.putItem({TableName:"Pets", Item:item}, cb);
};
```






上述の手順を使用して、`NoOp`という名前のLambda関数を作成します。この関数コードは以下の通りです。

```json lines
{
  "pets": [{
    "id": 1,
    "type": "dog",
    "price": 249.99
  }]
}
```






この3つ目のLambda関数を作成する代わりに、 API Gatewayで[OPTIONSメソッドの作成](#method-options)を選択することもできます。

3.Amazon API Gateway APIを作成する

#### 方式：ペット情報を`GET`

APIを作成するのが初めての場合は、［Example API（サンプルAPI）］を作成するよう求められます。**［OK］**をクリックしてポップアップ通知を閉じ、**［Example API（サンプルAPI）］**ボタンの代わりに、**［New API（新規API）］**ラジオボタンを選択します。

APIを「`SecurePets`」と名づけ、**［Create API（APIの作成）］**をクリックします。

```js lines
exports.handler = function(event, context) {
    context.succeed('');
}
```






リソースに「`Pets`」の名前を付け、 **［Create Resource（リソースの作成）］**を再びクリックします。

### Step 左ペインで`/pets`を選択し、 **［CreateMethod（メソッドの作成］**ボタンをクリックします。

ドロップダウンで、［GET］を選択し、チェックマークボタンをクリックします。`GET`メソッドのために、以下の構成値を提供します。

#### Method: GET Pet Information

Go to the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), and click **Create API**. If this is the first time you are creating an API, you will see a screen prompting you to **Get Started** instead.

**［Lambda Function（Lambda関数）］**：GetPetInfo

**［Save（保存）］**をクリックし、Lambda関数に権限を付与することをポップアップで求められたら**［OK］** をクリックします。

次に表示される［Method Execution（メソッドの実行）］ウィンドウで**［Test（テスト）］**をクリックします。

応答本文で1つペットが返されたことを確認できます。

方式：ペット情報を`POSＴ`

ペット情報を`POST` に使用するAPIの作成は、ペット情報を`GET`に使用したAPIの作成方法と似ています。

* 左ペインで`/pets`を選択し、 **［CreateMethod（メソッドの作成］**をクリックします。
* ドロップダウンで、［POST］を選択し、チェックマークボタンをクリックします。
* ［Integration type（統合タイプ）］にLambda関数を選択し、あなたがいる地域を選択し、［Lambda Function（Lambda関数）］に「UpdatePetInfo」を選択します。

この時点で、AWS Lambda関数とAmazon API Gatewayメソッドは、セキュリティなしで定義されています。

**［Test（テスト）］**をクリックし、以下を要求本文に貼り付けます。

空の結果(`{}`)が返されます。

#### Method: POST Pet Information

方式：`OPTIONS`

アクションを起こさないlambda関数を作成する代わりに、API Gatewayで`OPTIONS`メソッドを作成することができます。

左ペインで`/pets`を選択し、 **［CreateMethod（メソッドの作成］**をクリックします。ドロップダウンで、［OPTIONS]を選択し、チェックマークボタンをクリックします。［Integration type（統合タイプ）］に［Mock］を選択します。**［Save（保存）］**をクリックします。

応答本文は空欄のまま、**［Test（テスト）］**をクリックします。`no data`と示す応答本文を受け取るはずです。

この時点で、AWS Lambda関数とAmazon API Gatewayメソッドは、セキュリティなしで定義されています。

**Test**, and paste the following for the request body:

```json lines
{"pets": [
    {"id": 1, "type": "dog", "price": 249.99},
    {"id": 2, "type": "cat", "price": 124.99}
  ]
}
```






この3つ目のLambda関数を作成する代わりに、 API Gatewayで[OPTIONSメソッドの作成](#method-options)を選択することもできます。

Return to the GET method, and click **Test** again to see that the response body indicates there are two pets listed in the table:

```json lines
[
  {
    "id": 1,
    "price": 249.99,
    "type": "dog"
  },
  {
    "id": 2,
    "price": 124.99,
    "type": "cat"
  }
]
```






#### Method: OPTIONS

Instead of creating a lambda function that performs no action, you can create an `OPTIONS` method on the API Gateway.

アクションを起こさないlambda関数を作成する代わりに、API Gatewayで`OPTIONS`メソッドを作成することができます。 In the drop down, select OPTIONS, and click the checkmark button. Select Mock for Integration Type. Click **Save**.

Leaving the Response Body blank, click **Test**. You should receive a Response Body indicating `no data`.

At this point, the AWS Lambda functions and the Amazon API Gateway methods are defined with no security.