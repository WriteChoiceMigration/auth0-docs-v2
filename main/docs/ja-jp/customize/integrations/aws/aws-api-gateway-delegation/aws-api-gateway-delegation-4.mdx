---
og:description: Step 4 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: AWS API Gatewayチュートリアルの手順4
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-4
title: AWS API Gatewayチュートリアルの手順4
twitter:description: Step 4 of Amazon API Gateway Tutorial
twitter:title: AWS API Gatewayチュートリアルの手順4
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## 手順4 - Amazon API Gatewayで複数のロールを使用する

この手順では、認証情報に基づいて、ユーザーに異なるAWS IAMロールを割り当てます。

* ソーシャル接続で認証するユーザーは、購入者として扱われます。
* データベース接続で認証するユーザーは、管理者として扱われます。

このロール割り当てロジックは、2つの方法で実行します。

* JavaScript
* Auth0ルール

多くのAuth0アプリケーションでは、異なるユーザーに対して異なるレベルのアクセスを付与する必要があり、サービスロジックで使用するために、指定されたIDに関する追加情報が必要になります。APIレベルでアクセスをロックするだけで十分な場合は、異なるAWS IAMロールを使用できます（たとえば、管理者は更新機能を使ってペットを追加・削除できるのに対し、ソーシャルユーザーはペットを購入することしかできない）。

以下の図では、ソーシャル接続経由で認証されたユーザーと、データベース接続で認証されたユーザーの2種類のユーザークラスについて、AWS IAMロールの割り当てを示しています。また、AWS IAMロールは、その他のエンティティ（たとえば、AWS Lamdba関数）に割り当てることができ、それらのエンティティが割り当てられているアカウントへのアクセス許可を制御できることも示しています。つまり、IAMロールは、1つ以上のポリシーで定義され、エンティティに割り当てられる、AWS機能へのアクセス許可の集合と言えます。

For cases where you want to make decisions within your code (for example, you might want a credit check of a user buying a pet), you will want to flow identity as well. This will be demonstrated below in [Step 5 - Using Identity Tokens to Flow Identity](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-5).

### Step 1.PetPurchase APIリソースを作成する

Using the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), select your Pets API. You will be taken to its Resources page.

以前、`pets`用に[「手順2：CORSをセットアップしてAPIを導入する」の「Amazon API Gatewayの保護と導入」](/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api)で説明した方法で、OPTIONSメソッドを`purchase`リソースに追加します。

Add an OPTIONS method for the `purchase` resource as outlined previously for `pets` in the [Set Up Cors and ログインコントローラーロジックは、`getOptionsForRole`を使用して、異なるユーザーに異なるロールを選択します。委任トークンを取得したら、使用するロール（すなわち、ユーザーが管理者か否か）をAuth0に伝えることができます。 section of Step 2 - Securing and Deploying the Amazon API Gateway](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api).

Lambda関数を定義し終えたら、[POSTメソッドを`purchase`リソースに追加](/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-1#method-post-pet-information)します。これは、`PetPurchase` Lambdaと呼ばれます。値が`*`の`Access-Control-Allow-Origin`ヘッダーも忘れずにPOSTメソッドに追加します。これには、「[手順2：CORSをセットアップしてAPIを導入する」の「Amazon API Gatewayの保護と導入」](/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api)で説明されている、メソッド応答/統合応答の構成を使用します。

```javascript lines expandable
var AWS = require('aws-sdk');
var DOC = require('dynamodb-doc');
var dynamo = new DOC.DynamoDB();

exports.handler = function(event, context) {
   var petId = event.petId;
   var user = event.userName;
   var pets = {};
   console.log('start PetsPurchase, petId', petId, ' userName', user);

   var writecb = function(err, data) {
      if(!err) {
          context.done(null, pets);
      } else {
          console.log('error on GetPetsInfo: ',err);
          context.done('failed on update', null);
      }
   };

   var readcb = function(err, data) {
      if(err) {
          console.log('error on GetPetsInfo: ',err);
          context.done('failed to retrieve pet information', null);
      } else {
          // make sure we have pets
          if(data.Item && data.Item.pets) {
              pets = data.Item.pets;
              var found = false;

              for(var i = 0; i < pets.length && !found; i++) {
                  if(pets[i].id === petId) {
                     if(!pets[i].isSold) {
                        pets[i].isSold = true;
                        pets[i].soldTo = user;
                        var item = { username:"default",pets: pets};
                        dynamo.putItem({TableName:"Pets", Item:item}, writecb);
                        found = true;
                     }
                  }
               }
               if(!found) {
                 console.log('pet not found');
                 context.done('That pet is not available.', null);
               }
           } else {
              console.log('pet already sold');
              context.done('That pet is not available.', null);
           }
       }
   };

   dynamo.getItem({TableName:"Pets", Key:{username:"default"}}, readcb);
};
```






Once you have defined the Lambda function, [add a POST method to the `purchase` resource](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-1#method-post-pet-information) that calls the `PetPurchase` Lambda. Be sure to also add the `Access-Control-Allow-Origin` header with a value of `*` to the POST method using the method response/integration response configuration found in [Set Up Cors and ログインコントローラーロジックは、`getOptionsForRole`を使用して、異なるユーザーに異なるロールを選択します。委任トークンを取得したら、使用するロール（すなわち、ユーザーが管理者か否か）をAuth0に伝えることができます。 section of Step 2 - Securing and Deploying the Amazon API Gateway](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api).

テスト応答で、ID「1」のペットが、「Fred Flintstone」に販売されたことがわかります。

```json lines
{
    "petId": 1,
    "userName": "fred flintstone"
 }
```






2.IAMを使ってPurchasePet APIを保護する

```json lines
[
  {
    "id": 1,
    "price": 249.99,
    "type": "dog",
    "isSold": true,
    "soldTo": "fred flintstone"
  },

  ...
```






### Step IAMを更新する

#### APIを保護するため、本チュートリアルの[パート2で実行](/integrations/aws-api-gateway-delegation-2)した、新しいロールの追加プロセスを繰り返してください。新しいロールは`auth0-api-social-role`とします。

To secure your API, follow the same process for adding a new role that you [performed in Part 2](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2) of this tutorial. Call the new role `auth0-api-social-role`.

信頼ポリシーも必ず更新してください。

```bash wrap lines
arn:aws:execute-api:us-east-1:your-accountid:your-api-id/*/pets/purchase
```






この時点で2つのロールの定義が終わり、API Gatewayに使用できるようになりました。

Go to the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), and select the POST method for the `/pets/purchase` resource. Select **Method Request** and change **Authorization Type** to AWS_IAM. Click the check to save the setting.

`auth0-api-social-role`：ペットの購入を許可

* Login with Amazonを構成して、Auth0を更新する
* Login with Amazon（LWA）を使用してソーシャルロールを作成することができます。

#### このチュートリアルではLogin with Amazonの使い方をご説明しますが、他のソーシャルプロバイダーも利用できます。

適切な情報を入力したら、**［Try Connection（接続を試す）］**を選択して間違いがないかを確認します。

Amazonコンソールを使用してLWAを構成する際には、［Allowed Return URLs（許可されているリターンURL）］に、`

1. Navigate to [Auth0 Dashboard > Authentication > Social](https://manage.auth0.com/#/connections/social), and select **Create Connection**.
2. Choose the connection you want to set up, and consent.
3. Copy and paste the `Client ID` and `Client Secret` from your social identity provider, select the **Attributes** (and **Permissions**, where applicable), and click **Save**.
4. Select the **Applications** view, enable the switch for each of your Auth0 applications that should be able to use this connection, and select **Save**.

APIを導入して、シングルページアプリケーションを更新する

When you configure LWA using the Amazon console, be sure to enter into Allowed Return URLs the callback URL to your Auth0 Application, which should look something like `https://johndoe.auth0.com/login/callback`. The Auth0 help page will show you specifically what to enter.

Navigate to [Auth0 Dashboard > Applications > Applications](https://manage.auth0.com/#/applications), and select your Application to view its settings. Select the **Connections** view, locate the **Social** section, and ensure that **Amazon** is enabled.

#### ログインコントローラーロジックを更新して、異なるタイプのユーザーに異なるロールを選択する

##### ログインコントローラーロジックは、`getOptionsForRole`を使用して、異なるユーザーに異なるロールを選択します。委任トークンを取得したら、使用するロール（すなわち、ユーザーが管理者か否か）をAuth0に伝えることができます。

Using the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), you will again [deploy the API and generate a new JavaScript SDK](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api).

この機能性をテストするには、`/pets/home/home.html`の`ng-show="isAdmin"`を削除することで、UIの削除ボタンを一時的に非表示にできます。

##### この変更をS3バケットにコピーしたら、ソーシャルユーザーとしてログインしている状態でペットの削除を試みます。

ホームコントローラーロジックを更新して、ソーシャルユーザーにペット購入を許可する

コードをS3バケットにコピーして、ログアウトし、LockのログインダイアログにあるAmazonアイコンをクリックする方法で、再びソーシャルユーザーとしてログインし直します。Lockペインに以前のログインが残っている場合は、**［SHOW ALL（すべて表示）］**をクリックする必要があります。

Amazonユーザーとしては、ペットを購入することはできても、ペットを追加・削除することはできません。一方、データベース接続に紐づけられたユーザーとしてログインした場合は、ペットを追加・削除することはできても、ペットを購入することはできません。

Auth0ルールでロール割り当てを適用する

```html wrap lines
<button ng-show="isAdmin" class="btn delete-btn" ng-click="removePet(pet.id)">remove</button>
```






場合によっては、アプリケーションを使用して適切なロールを決定しているけれど（こちらを参照）、セキュリティ上の理由で（ユーザーが必要以上に権限のあるロールにつくのを防ぎたい場合）、ユーザー権限をサーバー側で決定しなければならないことがあります。

##### Auth0では、この設定をルールを使って行えます。ルールは、自分で定義するサービスロジックのステートメントで、Auth0認証のプロセス中に実行されます。たとえば、以下を行うルールを作成できます。

ブラウザーからアプリケーションにロール情報が渡されないようにする

```javascript lines
function buyPet(user, id) {
    var apigClient = getSecureApiClient();

    apigClient.petsPurchasePost({},{userName:user, petId:id})
      .then(function(response) {
        console.log(response);
        $scope.pets = response.data;
        $scope.$apply();
      }).catch(function (response) {
        alert('buy pets failed');
        showError(response);
    });
}
…
```






認証ソースに基づいて、委任要求にロール情報を挿入する

ロール割り当てを適用する

### ユーザーによって要求されたロールが許可されたものかを確認するルールを追加します。これは、紐づけられているのがソーシャル接続なのか、データベース接続なのかに応じて異なります。

上記のコードは、必ず、実際の統合に合わせて正しい値に調整してください。フィールドは、**［Princial ARN（プリンシパルARN）］**、**［Role ARN（ロールARN）］**、および**［Client Secret（クライアントシークレット）］**となります。

注意事項

* ルールは、すべての認証のグローバルスコープで実行されます。特定のアプリケーションに紐づけられた認証要求に対してのみ、ロジックを実行する必要があります（これが、使用されているスクリプトがclientIDを求める理由です）。この情報がなければ、Auth0アカウントに紐づけられたすべての認証要求に対してロジックが実行されてしまいます。
* 情報は、コンテキストとユーザーと併せてルールに渡されます。

#### ルールに渡されたオブジェクトは拡張できます。上記のコードでは、ルールが要求の本文でロール情報を確認します。ロールは、許可されたロールのaddonConfigurationコンテキストに設定され、常に要求本文の設定に優先されます。

ルールをデバッグする

1. Navigate to [Auth0 Dashboard > Auth Pipeline > Rules](https://manage.auth0.com/#/rules), and select **Create Rule**.
2. Choose the **Empty rule** template
3. Name the rule **AWS Pets** (or something similar), then populate the body of the rule with the following JavaScript code:

   ```javascript lines expandable
   function (user, context, callback) {
     if(context.clientID === '{yourClientId}') {
       var socialRoleInfo = {
         role:"arn:aws:iam::<your account>:role/auth0-api-social-role",
         principal: "arn:aws:iam::your account>:saml-provider/auth0"
       };

       var adminRoleInfo = {
         role:"arn:aws:iam::<your account>:role/auth0-api-role",
         principal: "arn:aws:iam::<your account>:saml-provider/auth0"
       };

       var requestRole = context.request.body.role;
       var requestPrincipal = context.request.body.principal;
       var allowedRole = null;

       if(user.identities[0].isSocial === false) {
         allowedRole = adminRoleInfo;
       } else {
         allowedRole = socialRoleInfo;
       }

       if((requestRole && requestRole !== allowedRole.role) ||
          (requestPrincipal && requestPrincipal !== allowedRole.principal)) {
           console.log('mismatch in requested role:',requestRole, ':', requestPrincipal);
           console.log('overridding');
       } else {
         console.log('valid or no role requested for delegation');
       }

       context.addonConfiguration = context.addonConfiguration || {};
       context.addonConfiguration.aws = context.addonConfiguration.aws || {};
       context.addonConfiguration.aws.role = allowedRole.role;
       context.addonConfiguration.aws.principal = allowedRole.principal;
       callback(null, user, context);

     } else {
       callback(null, user, context);
     }
   }
   ```


   

   

   ルールをデバッグする準備ができました。**［Try this Rule（このルールを試す）］**を選択すると、ルールのロジックを試行するスクリプトが表示されます。**［Try（試す）］**を選択します。
4. **Save** your changes.

#### ルールを実行した結果が表示されます。

* Rules run at a global scope for every authentication. You should only run the logic on authentication requests associated with a given application (which is why the script used asks for the clientID. Without this information, the logic runs for every authentication request associated with your Auth0 account.
* Information is passed into the rule with the context and the user.
* You can extend the objects passed in to the rule. In the code above, the rule checks the body of the request for the role information. The role is set into the context addonConfiguration of the allowed role, which always overrides settings in the request body.

#### Debug Your Rule

You are ready to debug your rule(s). Select **Try this Rule**, and you will be presented with a script that tries the rule's logic. Select **Try**.

You will then be presented with the output of running your rule.