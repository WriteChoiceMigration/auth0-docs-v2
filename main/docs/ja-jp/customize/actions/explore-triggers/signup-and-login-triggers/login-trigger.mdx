---
og:description: Learn about the Actions Login Flow and the post-login Action trigger,
  which is executed after a user logs in and when a Refresh Token is requested.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: ログイントリガー
og:url: https://auth0.com/docs/
permalink: login-trigger
sidebarTitle: ログイントリガー
title: ログイントリガー
twitter:description: Learn about the Actions Login Flow and the post-login Action
  trigger, which is executed after a user logs in and when a Refresh Token is requested.
twitter:title: ログイントリガー
---

ログイントリガーは、ユーザーがAuth0テナント上のアプリケーションに対して正常に認証された場合に実行されます。これにはサインアップ後の認証も含まれます。

<Frame>![Diagram showing the Actions Login Flow.](/images/cdy7uua7fh8z/2SkfIOm4fFOJ8N0GNJwam8/77230cdb4411b2383751b037fb56fe29/2024-09-30_10-01-42.png)</Frame>

このトリガー内のアクションはブロッキング（同期的）であり、トリガーのプロセスの一部として実行されます。そのため、アクションが完了するまでAuth0パイプラインの他の部分の実行が停止されます。

## トリガー

### ログイン/ログイン後

The `post-login` trigger is a function executed after a user logs in and when a <Tooltip tip="Refresh Token: Token used to obtain a renewed Access Token without forcing users to log in again." cta="View Glossary" href="/docs/glossary?term=Refresh+Token">Refresh Token</Tooltip> is requested.

#### [イベントオブジェクト](/signup-and-login-triggers/login-trigger/post-login-event-object)：Auth0を通してログインする1人のユーザーについてのコンテキスト情報を提供します。

* [Event object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-event-object): Provides contextual information about a single user logging in via Auth0.
* [API object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-api-object): Provides methods for changing the behavior of the flow.

## アクセス制御

### ログイン後のアクションを使用すると、アプリケーションにアクセスしようとしているユーザーへのアクセスを拒否するためのカスタムロジックを提供できます。

特定のアプリケーションに平日のみのアクセスを許可する

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  if (event.user.email && event.user.email.endsWith("@example.com") && event.client.name === "My SPA") {
    api.access.deny(`Access to ${event.client.name} is not allowed.`);
  }
};
```






### アクセスを平日のみに限定したいアプリケーションがある場合は、次のアクションを作成できます。

APIを呼び出すユーザーのすべてにアクセスを拒否する

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
 exports.onExecutePostLogin = async (event, api) => {
  if (event.client.name === "APP_NAME") {
    const d = new Date().getDay();

    if (d === 0 || d === 6) {
      api.access.deny("This app is only available during the week.");
    }
  }
}
```






### たとえば、APIを呼び出すユーザーのすべてに対して、アクセスを拒否したいとします。この場合は、[［Dashboard］>［Applications（アプリケーション）］>［APIs］]()の**［API Audience（APIオーディエンス）］**フィールドにあるAPIのオーディエンスの値に基づいてアクセスを拒否する必要があります。これを行うには、以下のアクションを作成します。

Let's say you want to deny access to all users who are calling an API. This means that you need to deny access depending on the <Tooltip tip="Audience: Unique identifier of the audience for an issued token. Named aud in a token, its value contains the ID of either an application (Client ID) for an ID Token or an API (API Identifier) for an Access Token." cta="View Glossary" href="/docs/glossary?term=audience">audience</Tooltip> value for your API, which you can find in the **API Audience** field of your API in [Dashboard > Applications > APIs](https://manage.auth0.com/#/apis). To do this, you would create the following Action:

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
 exports.onExecutePostLogin = async (event, api) => {
  // In Actions, an API will be referred to as a Resource Server.
  if (event.resource_server && event.resource_server.identifier === "http://todoapi2.api") {
    api.access.deny("end_users_not_allowed");
  }
}
```






### Auth0が発行したトークンにユーザーロールを追加するには、`event.authorization`オブジェクトと`api.idToken.setCustomClaim`および`api.accessToken.setCustomClaim`メソッドを使用します。

カスタムクレームには特定の用語を含めることができないため、URI形式の名前空間クレームの使用を強くお勧めします。詳細については、[カスタムクレームに関する当社のドキュメント](/security/tokens/json-web-tokens/create-custom-claims)を参照してください。

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  const namespace = 'https://my-app.example.com';
  if (event.authorization) {
    api.idToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
    api.accessToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
  }
}
```






* A custom claim cannot include certain terms, and we strongly recommend using namespaced claim that takes the form of a URI. See [our documentation on custom claims](/docs/secure/tokens/json-web-tokens/create-custom-claims) for more information.
* The <Tooltip tip="JSON Web Token (JWT): Standard ID Token format (and often Access Token format) used to represent claims securely between two parties." cta="View Glossary" href="/docs/glossary?term=JWT">JWT</Tooltip> returned to the requesting application is built and signed at the end of the trigger processing. The final, signed JWT is not accessible in an Action.

### Auth0には[ユーザープロファイル](/users/user-profiles/normalized-user-profiles)にメタデータを保存するためのシステムがあります。ログイン中にユーザープロファイルの`user_metadata`または`app_metadata`を設定するには、`api.user.setUserMetadata`または`api.user.setAppMetadata`関数を使用します。

Auth0 provides a system for storing metadata on a [User Profile](/docs/manage-users/user-accounts/user-profiles/normalized-user-profiles). In order to set `user_metadata` or `app_metadata` on a user’s profile during their login, use the `api.user.setUserMetadata` or `api.user.setAppMetadata` functions.

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  api.user.setUserMetadata("favorite_color", "blue");
};
```






Once all post-login actions have been executed, Actions will update the user profile in a single operation. This operation is subject to the "Write Users" [rate limit](/docs/troubleshoot/customer-support/operational-policies/rate-limit-policy/management-api-endpoint-rate-limits).

### ログイン後のアクションを使用すると、アプリケーションのニーズに応じて、ユーザーのMFAを動的に要求できます。

A post-login Action can be used to dynamically require <Tooltip tip="Multi-factor authentication (MFA): User authentication process that uses a factor in addition to username and password such as a code via SMS." cta="View Glossary" href="/docs/glossary?term=MFA">MFA</Tooltip> for a user according to your application’s needs.

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  // Require MFA for anyone logging in from North America.
  if (event.request.geoip.continentCode === "NA") {
    api.multifactor.enable("any");
  };
};
```






An MFA Provider must be configured in order to enable MFA during a login. To learn more, read [Multi-Factor Authentication](/docs/secure/multi-factor-authentication).

### ログイン後のアクションを使用すると、パスキーで認証したユーザーのMFAを動的にスキップすることで、煩わしさを軽減できます。

接続にパスキーとMFAが有効化されている必要があります。詳細については、「[パスキー](/passkeys)」と「[多要素認証](/mfa)」をお読みください。

```javascript lines
/**
* Handler that will be called during the execution of a PostLogin flow.
*
* @param {Event} event - Details about the user and the context in which they are logging in.
* @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
*/
exports.onExecutePostLogin = async (event, api) => {
 // Check if a passkey was used to authenticate
 const skipMFA = event.authentication?.methods.some(
   (method) => method.name === "passkey"
 );

 // If a passkey was used skip MFA
 if (skipMFA) {
   api.multifactor.enable("none");
 }
};
```






The connection must have passkeys and MFA enabled. To learn more, read [Passkeys](/docs/authenticate/database-connections/passkeys) and [Multi-Factor Authentication](/docs/secure/multi-factor-authentication).

### ユーザーがリダイレクトされている間、アクションパイプラインは停止されます。ユーザーがAuth0のログインプロセスを続行すると、アクションパイプラインは中断された場所から再開されます。リダイレクト前に実行されたアクションは再度実行されません。

Similar to [Redirect Rules](/docs/customize/rules/redirect-users), a post-login Action can be used to send the user to an external site. When completed, the user can be redirected back to Auth0 to continue their login flow. In the example below, a Redirect Action is used to prompt the user to provide their favorite color.

```javascript lines expandable
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  // Skip the redirect if the user has already chosen a favorite color.
  if (event.user.user_metadata.favorite_color) {
    return;
  }

  const token = api.redirect.encodeToken({
    secret: event.secrets.MY_SHARED_SECRET,
    payload: {
      email: event.user.email,
    },
  });

  // Send the user to https://my-app.example.com along
  // with a `session_token` query string param.
  api.redirect.sendUserTo("https://my-app.example.com", { 
    query: { session_token: token }
  });
};

/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onContinuePostLogin = async (event, api) => {
  // Once the /continue endpoint has been called, unpack the signed token
  // and store the favorite color as user metadata.

  const payload = api.redirect.validateToken({
    secret: event.secrets.MY_SHARED_SECRET,
  });

  api.user.setUserMetadata("favorite_color", payload.favorite_color);
};
```






アクセストークンのスコープを変更する

To learn more about Redirect Actions, read [Redirect with Actions](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/redirect-with-actions).

### スコープを追加する前に、必ず予期されているオーディエンスを確認してください。

When modifying the scopes associated with an <Tooltip tip="Access Token: Authorization credential, in the form of an opaque string or JWT, used to access an API." cta="View Glossary" href="/docs/glossary?term=access+token">access token</Tooltip>, ensure you adhere to the best practices surrounding audience specification.

* Always check for expected audience before adding scopes.
* Prevent using untrusted input when adding scopes.

```javascript lines
/**
 * @param {Event} event - Details about the user and the context in which they are logging in.
 * @param {PostLoginAPI} api - Interface whose methods can be used to change the behavior of the login.
 */
exports.onExecutePostLogin = async (event, api) => {
  if (event.request.query.audience === 'https://example.com/api') {
    api.accessToken.addScope("read:xyz");
  }
};
```






### Deny access to specific JA3/JA4 fingerprints

The `event.security_context` object contains the JA3/JA4 fingerprint values for the current transaction.

```js lines
exports.onExecutePreUserRegistration = async (event, api) => {
  const clientJa4 = event?.security_context?.ja4;
  console.log('[ACTION]', {clientJa4});
  const badFingerprints = ['t13d1517h2_8daaf6152771_b6f405a00624','t13d1516h2_8daaf6152771_d8a2da3f94cd'];
  if (clientJa4 && badFingerprints.includes(clientJa4)){
    api.access.deny('suspicious_tls_fingerprint', 'Your TLS fingerprint has been flagged as suspicious');
  }
};
```






## Learn more

* [Manage User Metadata with the post-login Action Trigger](/docs/manage-users/user-accounts/metadata/manage-user-metadata)
* [Redirect with Actions](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/redirect-with-actions)
* [Understand How Metadata Works in User Profiles](/docs/manage-users/user-accounts/metadata)