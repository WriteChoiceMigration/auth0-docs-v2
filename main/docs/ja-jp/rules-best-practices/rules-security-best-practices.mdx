---
og:description: Learn about best practices for Auth0 rules security.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: ルールセキュリティのベストプラクティス
og:url: https://auth0.com/docs/
permalink: rules-security-best-practices
title: ルールセキュリティのベストプラクティス
twitter:description: Learn about best practices for Auth0 rules security.
twitter:title: ルールセキュリティのベストプラクティス
---

<Warning>

The End of Life (EOL) date of Rules and Hooks will be **November 18, 2026**, and they are no longer available to new tenants created as of **October 16, 2023**. Existing tenants with active Hooks will retain Hooks product access through end of life.

We highly recommend that you use Actions to extend Auth0. With Actions, you have access to rich type information, inline documentation, and public `npm` packages, and can connect external integrations that enhance your overall extensibility experience. To learn more about what Actions offer, read [Understand How Auth0 Actions Work](/docs/customize/actions/actions-overview).

To help with your migration, we offer guides that will help you [migrate from Rules to Actions](/docs/customize/actions/migrate/migrate-from-rules-to-actions) and [migrate from Hooks to Actions](/docs/customize/actions/migrate/migrate-from-hooks-to-actions). We also have a dedicated [Move to Actions](https://auth0.com/extensibility/movetoactions) page that highlights feature comparisons, [an Actions demo](https://www.youtube.com/watch?v=UesFSY1klrI), and other resources to help you on your migration journey.

To read more about the Rules and Hooks deprecation, read our blog post: [Preparing for Rules and Hooks End of Life](https://auth0.com/blog/preparing-for-rules-and-hooks-end-of-life/).

</Warning>

### HTTPSを常に使用する

外部サービスへの呼び出しを行ったり、ルール実装の一部としてリダイレクトを実行したりする場合は、HTTPでなく、HTTPSを必ず使用します。

### セキュリティ上重要な値をルール設定に保存する

資格情報やAPIキーなどセキュリティ上重要な情報はルール設定に保存します。ルール設定では、情報は難読化や暗号化され、`configuration`オブジェクトを介して利用することができます。これらの値をリテラルの値としてルールコードに保存しないでください。たとえば、以下のようなコードは書き込まないでください。

`const myApiKey = 'abc123';`

代わりに、`configuration`オブジェクトを介してアクセスできるよう、（シークレット）情報を保存することを推奨します。

`const myApiKey = configuration.myApiKey;`

### Do not send entire context object to external services

外部サービスに情報を送信するルールでは、contextオブジェクト全体を送信しないようにしてください。このオブジェクトにはトークンやその他の機微データが含まれているためです。外部サービスに情報を送信するルールでは、`context`オブジェクトから機微度が低い属性のサブセットのみを必要な時間に必要な場所に送ります。

同様に、`auth0`オブジェクトの側面をルール外に渡すことは避けます。

### メールが確認済みかどうかチェックする

ユーザーのメールアドレスがルールで確認済みであるかどうかチェックすることができます。

```javascript lines
function (user, context, callback) {
      // Access should only be granted to verified users.
      if (!user.email || !user.email_verified) {
    return callback(new UnauthorizedError('Access denied.'));
      }
    	  .
    	  .
    }
```






However, if you want to execute different code depending on the company the user belongs to, you should not rely on the email domain, but instead, on data that can link the user to the <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=identity+provider">identity provider</Tooltip> that they authenticated with (the connection or identity-provider-specific fields such as Azure’s `tenant id`).

### 文字列の完全一致を確認する

メールドメインなど特定の文字列に基づいてアクセス制御を決定するルールでは、サブ文字列の一致でなく文字列の完全一致を確認します。サブ文字列のみを確認する場合、ルールが意図したように機能しないことがあります。以下に例を示します。

`if( _.findIndex(connection.options.domain_aliases, function(d){ return user.email.indexOf(d) >= 0;`

上のコードは、次のようなメールが与えられている場合、`true`を返します。

* `user.domain.com@not-domain.com`
* "`user@domain.com`"`@not-domain.com`（引用符を含む）

上のメールは好ましくない例です。代わりに、次のようなコードを使って完全一致を実行してください。

`const emailSplit = user.email.split('@');
const userEmailDomain = emailSplit[emailSplit.length - 1].toLowerCase();`

To learn more, [see the **Check if user email domain matches configured domain rule template** on GitHub](https://github.com/auth0/rules/blob/master/src/rules/check-domains-against-connection-aliases.js), or navigate to [Auth0 Dashboard > Auth Pipeline > Rules](https://manage.auth0.com/#/rules/new), and select **Create**.

### 多要素認証のコンテキストに基づいたバイパス

<Tooltip tip="Multi-factor authentication (MFA): User authentication process that uses a factor in addition to username and password such as a code via SMS." cta="View Glossary" href="/docs/glossary?term=Multi-Factor+Authentication">Multi-Factor Authentication</Tooltip> (MFA) provides an additional layer of security in order to guard against unauthorized access. From a user experience perspective, this typically requires additional user interaction to provide a second authentication factor—i.e., typically presenting some additional credential(s) or authorizing some form of access request.

それでも、状況によっては、多要素認証が必要であると判断されたユーザーがMFAをバイパスしたほうが望ましいケースもあります。たとえば、ユーザーが現在のブラウザーコンテキストで認証の一部としてプライマリとセカンダリの両方の要素をすでに提出している場合は、MFAをバイパスしてもよいでしょう。このようにコンテキストに基づいて確認することで、ユーザーエクスペリエンスの向上に役立ちます。しかし、適切に行わないと、セキュリティ上の重大な抜け道が生じ、MFAがスキップされたことで、この後セキュリティ侵害が発生する可能性があります。このため、コンテキストに基づいてMFAをバイパスするかどうかを判断する上で、以下のガイドラインを守られることを推奨します。

推奨されるベストプラクティスとして、用意されているMFAを使用するときにコンテキストに基づいてバイパスを検討する場合、使用するべきオプションは`allowRememberBrowser`または`context.authentication`のみです。`allowRememberBrowser`を`true`に設定すると、MFAが定期的にしか求められないように、ボックスにチェックマークを入れることができます、その一方で、`context.authentication`を安全かつ正確に使用し、MFAが現在のブラウザーコンテキストで最後にいつ実行されたのかを特定することができます。用意されている指定されたルール（Require MFA once per session）で`context.authentication`のサンプルユースをいくつか閲覧することができます。

* **Do not perform MFA bypass**：サイレント認証に関連する条件ロジックに基づく（`context.request.query.prompt === 'none'`など）
* **Do not perform MFA bypass** based on conditional logic using some form of device fingerprinting (e.g., where `user.app_metadata.lastLoginDeviceFingerPrint === deviceFingerPrint`)
* **Do not perform MFA bypass**：地理的場所を使った条件ロジックに基づく（ここでは、`user.app_metadata.last_location === context.request.geoip.country_code`）

#### カスタムMFAプロバイダー使用時のコンテキストに基づいた確認

すでに説明したのと同じように、ユーザーをカスタム多要素認証プロバイダーにリダイレクトするルールに対して、上記の項目で示したガイダンスに従うことを推奨します。たとえば、カスタムプロバイダーの場合、サイレント認証中はMFAを効果的にバイパスする安全な方法はありません。これは、リダイレクト（カスタムMFAで必須）はサイレント認証時に必ず失敗するからです。

## Learn more

* [Rules Anatomy Best Practices](/docs/rules-best-practices/rules-anatomy-best-practices)
* [Rules Environment Best Practices](/docs/rules-best-practices/rules-environment-best-practices)
* [Rules Execution Best Practices](/docs/rules-best-practices/rules-execution-best-practices)
* [Rules Testing Best Practices](/docs/rules-best-practices/rules-testing-best-practices)
* [Secure](/docs/secure)