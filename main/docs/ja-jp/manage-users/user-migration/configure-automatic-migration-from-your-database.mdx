---
og:description: Learn how to enable automatic user migration with your custom database.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: データベースからの自動移行を構成する
og:url: https://auth0.com/docs/
permalink: configure-automatic-migration-from-your-database
title: データベースからの自動移行を構成する
twitter:description: Learn how to enable automatic user migration with your custom
  database.
twitter:title: データベースからの自動移行を構成する
---

Configure your Database connection to automatically migrate your users from an external user store to Auth0 with [custom database action scripts](/docs/authenticate/database-connections/custom-db/templates).

<Warning>

If you try to use more than one migration method (for example, automatic migration then bulk user import), you may encounter a `DUPLICATED_USER` error. This error indicates that the user exists in Auth0's internal user store but not in your tenant. To correct this error, delete the user with the Auth0 Management API [Delete a Connection User](https://auth0.com/docs/api/management/v2#!/Connections/delete_users_by_email) endpoint and then re-attempt the import.

</Warning>

## データベース接続をカスタムとして構成する

データベース接続を作成し、カスタムに設定します。

1. Go to [Auth0 Dashboard > Authentication > Database](https://manage.auth0.com/#/connections/database) and select the database to view.
2. Select the **Custom Database** view, and toggle on **Use my own database**.

   <Frame>![Auth0 Dashboard Authentication Database Connection Custom Database Settings Use Own Database Enabled](/images/cdy7uua7fh8z/11HPAdVwJMmnWbzMVjHCJ8/f75ff47f613a41778f266643f29ab2b1/2025-02-27_17-25-36.png)</Frame>
3. Select the **Settings** view, toggle on **Import Users to Auth0**, and select **Save**.

## データベースのアクションスクリプトの構成

**［Custom Database（カスタムデータベース）］**ビューを選択し、**［Database Action Scripts（データベースのアクションスクリプト）］**を見つけます。

<Frame>![Dashboard Authentication Database Connection Custom Database tab Database Action Scripts](/images/cdy7uua7fh8z/4LBIvvjaABo51It4eVCmX3/4ef14765c79cc5b7ecfa3f3155caa9eb/Screen_Shot_2021-05-18_at_8.54.55_PM.png)</Frame>

### ログイン

The [Login](/docs/authenticate/database-connections/custom-db/templates/login) script executes each time a user who is not found in the Auth0 attempts to log in. It verifies that the user exists in the external user store without reprompting the user for their password.

### ユーザーがサインアップ試行を開始

The [Get User](/docs/authenticate/database-connections/custom-db/templates/get-user) script executes after any of the following scenarios:

* ユーザーがIdentifier First + 生体認証を使用する際に、ログインIDを入力
* Management APIの[ユーザーのメールアドレスまたはユーザー名の更新](/api/v2#!/Users/patch_users_by_id)または[ユーザーの作成](/api/management/v2#!/Users/post_users)エンドポイントが呼び出される
* 移行されていないユーザーがパスワード変更を承認し、ログインに成功すると、ユーザープロファイルが新しいパスワードでAuth0に作成されます。このユーザープロファイルは、ユーザー取得スクリプトで返されたすべてのデータを含みます。ユーザーのこれ以降のすべてのログインは、Auth0で直接実行されます。
* The <Tooltip tip="Management API: A product to allow customers to perform administrative tasks." cta="View Glossary" href="/docs/glossary?term=Management+API">Management API</Tooltip> [Update a User's Email or Username](https://auth0.com/docs/api/v2#!/Users/patch_users_by_id) or [Create User](https://auth0.com/docs/api/management/v2#!/Users/post_users) endpoint is called.

すべてのユーザーがAuth0 DashboardまたはAuth0 Management APIを使用してAuth0ユーザーストアに移行されたことを確認します。

## 外部ユーザーストアの接続解除

Verify that all users have been migrated to the Auth0 user store using the <Tooltip tip="Auth0 Dashboard: Auth0's main product to configure your services." cta="View Glossary" href="/docs/glossary?term=Auth0+Dashboard">Auth0 Dashboard</Tooltip> or the Auth0 Management API.

1. Go to [Auth0 Dashboard > User Management > Users](https://manage.auth0.com/#/users), and review the list of users.
2. Use the Management API [List or Search Users](https://auth0.com/docs/api/v2#!/Users/get_users) endpoint.

## ユーザーの移行に関する問題のトラブルシューティング

自動移行で問題が生じた場合は、まず「[カスタムデータベース接続とアクションスクリプトのベストプラクティス](/custom-database-connections-scripts)」をお読みください。

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

Make sure to leave the **Import Users to Auth0** option turned on. If you turn this option off Auth0 will only use the scripts to authenticate and perform other user actions instead of using the users that were imported locally.

</Callout>

1. Go to [Auth0 Dashboard > Authentication > Database](https://manage.auth0.com/#/connections/database), and then select your Database connection.
2. Switch to the **Custom Database** view, and then locate **Database Action Scripts.**
3. Update the **Login** script.

   ```javascript lines
   function login (email, password, callback) {
     return callback(null, null);
   }
   ```


   

   
4. Update the **Get User** script.

   ```javascript lines
   function getByEmail (email, callback) {
     return callback(null, null);
   }
   ```


   

   

## ユーザーはすでに存在しています

If you encounter any issues with automatic migration, first read [Custom Database Connection and Action Script Best Practices](/docs/authenticate/database-connections/custom-db/custom-database-connections-scripts).

### データベース接続からユーザーを削除した後、ユーザーの再作成を試みた

外部ユーザーストアに存在しているユーザーを、新規ユーザーとしてデータベース接続で作成を試みた

* ユーザーの移行プロセスが中断された
* ユーザーの移行プロセスの間、Auth0はまず、内部のユーザーストアで部分的なユーザープロファイルを作成してから、データベース接続で完全なユーザープロファイルを作成します。完全なユーザープロファイルの作成を妨げる問題が生じた場合、`The user already exists`（ユーザーはすでに存在しています）エラーの可能性があります。
* この問題は通常、データベース接続からそのユーザーを削除し、内部のユーザーストアからもそのユーザーを削除したのち、移行プロセスを再試行することで解決できます。

メタデータの不足

ユーザーが移行プロセスを開始するログインまたはパスワード変更のフロー中に中断された場合、Auth0はそのメタデータ（`user_metadata`または`app_metadata`）および他のプロファイルデータを移行できない可能性があります。

1. Check the `console.log()` statements with the [Real-time Webtask Logs extension](/docs/customize/extensions/real-time-webtask-logs).
2. Delete the user with the Management API [Delete a User](https://auth0.com/docs/api/management/v2#!/Users/delete_users_by_id) endpoint.
3. Delete the user with the Management API [Delete a Connection User](https://auth0.com/docs/api/management/v2#!/Connections/delete_users_by_email) endpoint.
4. Instruct the user to log in or change their password to reattempt migration.

### このようなシナリオは、ユーザープロファイルにメタデータが不足していないかを確認して、外部ユーザーストアから取得してAuth0に保存する[アクション](/actions)を作成することで減らせます。

If a user is interrupted during the login or change password flow that initiates the migration process, Auth0 may not be able to transfer their metadata (`user_metadata` or `app_metadata`) along with their other profile data.

You can mitigate this scenario by creating an [Action](/docs/customize/actions) that verifies the user's profile is missing metadata, retrieves it from the external use store, and then stores it in Auth0.

## Learn more

* [Bulk User Imports](/docs/manage-users/user-migration/bulk-user-imports)
* [User Import / Export Extension](/docs/manage-users/user-migration/user-import-export-extension)