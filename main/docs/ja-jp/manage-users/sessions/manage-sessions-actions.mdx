---
og:description: Learn about managing sessions with Actions
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Actionsを使用したセッション
og:url: https://auth0.com/docs/
permalink: manage-sessions-actions
title: Actionsを使用したセッション
twitter:description: Learn about managing sessions with Actions
twitter:title: Actionsを使用したセッション
---

Using Sessions with [Actions](/docs/customize/actions) allows you to configure post-authentication risk detection and response capabilities to protect your applications and users against session hijacking. You can also dynamically customize the [session lifetime limits](/docs/manage-users/sessions/configure-session-lifetime-settings).

**event.session**：一意の`id`、`created_at`、`expires_at`、`idle_expires_at`、`updated_at`の日付、`clients`、`authentication_at`の他にも、`ASN`、`IP`や`User_agent`などの`device`情報を含む、関連情報を提供します。

* **api.session：**セッションを取り消すか、`expiry`の日付を変更することで、既存のセッションを管理できます。
* これらのオブジェクトの詳細については、以下をご確認ください。

The `event.session` and `api.session` objects both support interactive web-based flows, including [authorization code flow](/docs/get-started/authentication-and-authorization-flow/authorization-code-flow), implicit flow, device code flow, as well as <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=SAML">SAML</Tooltip> and <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=WS-Fed">WS-Fed</Tooltip>.

[APIオブジェクト](/signup-and-login-triggers/login-trigger/post-login-api-object)：セッションのAPIオブジェクトとメソッドについて説明します。

Actionsでセッションを取り消す

ログイン後の**api.session.revoke(reason, options)**メソッドを使用すると、トランザクションに関連するリスクに対処することができます。このメソッドには、取り消されたトランザクションにバインドされているリフレッシュトークンを保存できるオプションが含まれています。

* [Event object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-event-object): Learn about the session Event object and properties.
* [API object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-api-object): Learn about the session API object and methods.

## Auth0で現在のセッションのトランザクションを無効にする

The post-login **api.session.revoke(reason, options)** method allows you to react to risks associated with a transaction. This method includes an option to allow you to preserve the <Tooltip tip="Refresh Token: Token used to obtain a renewed Access Token without forcing users to log in again." cta="View Glossary" href="/docs/glossary?term=refresh+tokens">refresh tokens</Tooltip> bound to the revoked transaction.

In addition to revoking the session, the method will also initiate a `session-revoked` [OIDC Back-Channel Logout Initiator](/docs/authenticate/login/logout/back-channel-logout/oidc-back-channel-logout-initiators) to log out users from all applications bound to the current session and log a [session_revoked](/docs/deploy-monitor/logs/log-event-type-codes) event in the tenant logs.

これはカスタマイズ可能なオプションであり、取り消すのではなく、リフレッシュトークンの保持を選択することもできます。この操作は非同期的に実行され、最終的には整合します。

* イベントログの取り消しを監視する
* 以下のログイン後オブジェクトプロパティを使用すると、ユーザーの認証に使用される接続に対してライフタイムを定義できます。
* Revoke all [refresh tokens](/docs/secure/tokens/refresh-tokens) associated with the existing session with a matching `session_id` value.

  + Actionsでセッションの有効期限日を変更する

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

If you want to use the `api.session.revoke(reason,options)` method, ensure that the property event.session.id exists.

Different from `api.access.deny()`, `api.session.revoke()` will deny the current transaction and also revoke the session, therefore first factor authentication will be required again

</Callout>

### セッションの[有効期限日](/users/sessions/session-lifetime-limits)を変更するには、以下のポストログインメソッドを使用します。

The revoke operation adds the following log event in your [tenant logs](/docs/deploy-monitor/logs):

**api.session.setIdleExpiresAt(idle)**を使用すると、特定のセッションに新しい非アクティブタイムアウトの日付を設定できます。

## これらのメソッドを使用すると、以下を基に、セッションのライフタイムと非アクティブポリシーを動的にカスタマイズすることができます。

You can modify session [expiry dates](/docs/manage-users/sessions/session-lifetime-limits) with the following post-login methods:

* ユーザーのAuth0接続
* **api.session.setIdleExpiresAt(idle)** allows you to set a new inactivity timeout date for a specified session.

リスク評価

* Actionsの実行中に使用できる他の動的基準
* 制限事項
* ログイン後APIメソッドの`api.session.setExpiresAt(absolute)`と`api.session.setIdleExpiresAt(idle)`がリリースされる前に発行されたセッションには、次のevent.sessionプロパティは含まれません：`last_interacted_at`。
* ログイン後APIメソッドの`api.session.revoke(reason, options)`がリリースされる前に発行されたセッションには、以下のevent.session.deviceプロパティは含まれません。
* ユースケース：セッションを取り消す

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

If you want to use the `api.session.setExpiresAt(absolute)` and `api.session.setIdleExpiresAt(idle)` methods, ensure that a property of the event.session object exists, such as `event.session.id`.

The `api.session.setIdleExpiresAt(idle)` method sets the session inactivity timeout for  the current interaction. If the method is not reapplied, subsequent successful interactions will override the inactivity timeout using the session inactivity timeout settings.

</Callout>

## `initial_asn`

ログイン後オブジェクトプロパティの`event.session.device.initial_asn`および`event.request.asn`を使用して、その期間中セッショントランザクションと特定の[autonomous system number (ASN)]()ネットワークをバインドして、ASNネットワークが変更した場合は再認証を要求できます。

セキュリティ上の理由から、非アクティブタイムアウトと絶対タイムアウトを、テナントの[セッションライフタイム制限](/users/sessions/configure-session-lifetime-settings)で定義されたセッション設定を超えた値には設定できません。ライフタイム制限を超えた日付を設定しようとすると、APIメソッドはライフタイム制限に達するまで更新し、テナントログに警告イベント（`w`）を記録します。

* ユースケース：セッションを取り消す
* ASNネットワークバインディングによるセッションの取り消し
* ログイン後オブジェクトプロパティの`event.session.device.initial_asn`および`event.request.asn`を使用して、その期間中セッショントランザクションと特定の[autonomous system number (ASN)]()ネットワークをバインドして、ASNネットワークが変更した場合は再認証を要求できます。

For security reasons, inactivity and absolute timeouts cannot be set above the session settings defined in the [session lifetime limits](/docs/manage-users/sessions/configure-session-lifetime-settings) for the tenant. If you attempt to set a date above the lifetime limits, the API methods will update up to the lifetime limits and log a warning event (`w`) in the tenant logs.

## セッションを無効にする

You can use [Actions](/docs/customize/actions) to configure risk detections and revoke risky sessions and their associated refresh tokens with the post-login `api.session.revoke(reason, options)` method and the `event.session` object.

### 関連するリフレッシュトークンすべてを取り消す

You can use the post-login object properties, `event.session.device.initial_asn` and `event.request.asn` to bind session transactions to a specific [autonomous system number (ASN)](https://www.arin.net/resources/guide/asn/) network for their duration and require a re-authentication if the ASN network changes.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  const sessionInitialAsn = event.session?.device?.initial_asn;
  const sessionCurrentAsn = event.request.asn;

  // if there is a session and the ASN changes
  if (
    sessionInitialAsn &&
    sessionCurrentAsn &&
    sessionInitialAsn != sessionCurrentAsn
  ) {
    api.session.revoke( "Invalid network change. Login again from a trusted network" )
  }
};
```

IPバインディングによるセッションの取り消し

* 接続に基づいて絶対的なセッション有効期限時間をカスタマイズする
* 以下のログイン後オブジェクトプロパティを使用すると、ユーザーの認証に使用される接続に対してライフタイムを定義できます。
* event.session.created_at
* event.session.expires_at

### 関連するリフレッシュトークンすべてを取り消す

You can use the post-login object properties `event.session.device.initial_ip` and `event.request.ip` to ensure a session transaction stays with the same IP address for its duration. In this scenario, any IP change is considered a risk, and the user will be prompted to re-authenticate.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  const sessionInitialIp = event.session?.device?.initial_ip;
  const sessionCurrentIp = event.request.ip;

  // if there is a session and the IP changes
  if (
    sessionInitialIp &&
    sessionCurrentIp &&
    sessionInitialIp != sessionCurrentIp
  ) {
    api.session.revoke("Invalid IP change")
  }
};
```






ユースケース：セッションの有効期限日をカスタマイズする

* 接続に基づいて絶対的なセッション有効期限時間をカスタマイズする
* 以下のログイン後オブジェクトプロパティを使用すると、ユーザーの認証に使用される接続に対してライフタイムを定義できます。
* event.session.created_at
* event.session.expires_at

## また、Auth0 [Management API]()を使用して接続メタデータの`event.connection.metadata.session_timeout`を作成し、特定の接続タイムアウトを定義します。

You can use [Actions](/docs/customize/actions) to customize session idle and absolute expiration dates. Specifically, you can configure the expiry dates for a particular session transaction using the post-login `api.session.setExpiresAt(absolute)` and `api.session.setIdleExpiresAt(idle)` methods and the `event.session` object.

### Organizationに基づいてセッションの非アクティブタイムアウトをカスタマイズする

この例では、Organizationに対して特定のアイドルタイムアウトが定義されている場合、アクションは`current_time`＋`idle_organization_lifetime`と等しくなるようにセッションの非アクティブタイムアウトを設定します。

* event.session.created_at
* event.session.expires_at

And using the Auth0 [Management API](https://auth0.com/docs/api/management/v2/connections/patch-connections-by-id) to create a connection metadata , `event.connection.metadata.session_timeout define` a specific connection timeout.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  const created = Date.parse(event.session?.created_at ?? "");

  // desired session lifetime for this connection in milliseconds, configured as connection metadata
  const connection_lifetime = event.connection?.metadata?.session_timeout;

  // if there is a session lifetime defined for the connection, set it
  if (event.session?.id && connection_lifetime) {
    api.session.setExpiresAt(created + Number(connection_lifetime));
  }
};
```






In this example, a check occurs at the start of the Action to verify that there is a  `session_timeout` defined in the current connection. In that case, the Action sets the session expiration to be equal to when the session was `created` plus the `connection_lifetime`.

### Customize session inactivity timeout based on the Organization

You can define a `current_time` variable and using a new Organization metadata called `idle_session_timeout` set the idle timeout desired for an organization.

```js lines
exports.onExecutePostLogin = async (event, api) => {
  // The Organization metadata is configured with a shorter idle timeout for sessions (in milliseconds)
  const idle_organization_lifetime =
    event.organization?.metadata?.idle_session_timeout;

  // If the organization has an specific idle timeout defined, set the timeout
  if (event.session?.id && idle_organization_lifetime) {
    const current_time = new Date().getTime();

    api.session.setIdleExpiresAt(
      current_time + Number(idle_organization_lifetime),
    );
  }
};
```






In this example, if there is a specific idle timeout defined for the Organization, the Action sets the session inactivity timeout to be equal to the `current_time` plus the `idle_organization_lifetime` .