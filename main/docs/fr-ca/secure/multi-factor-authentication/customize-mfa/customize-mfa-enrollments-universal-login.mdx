---
og:description: Customize MFA flows using post-login Actions to prompt users to enroll
  in specific factors.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Personnaliser les inscriptions à MFA pour la connexion universelle
og:url: https://auth0.com/docs/
permalink: customize-mfa-enrollments-universal-login
title: Personnaliser les inscriptions à MFA pour la connexion universelle
twitter:description: Customize MFA flows using post-login Actions to prompt users
  to enroll in specific factors.
twitter:title: Personnaliser les inscriptions à MFA pour la connexion universelle
---

Auth0 supports a variety of factors for securing user access with [multi-factor authentication (MFA](/docs/secure/multi-factor-authentication/multi-factor-authentication-factors)). Using `post-login` Actions, you can customize your <Tooltip tip="Multi-factor authentication (MFA): User authentication process that uses a factor in addition to username and password such as a code via SMS." cta="View Glossary" href="/docs/glossary?term=MFA">MFA</Tooltip> flows to prompt users to enroll in specific factors. After a user enrolls in a factor, they can use that factor as a secondary method of authentication in future logins.

Vous pouvez également utiliser des informations contextuelles pour personnaliser davantage vos flux d’inscription à MFA. Par exemple, vous pouvez demander aux utilisateurs de s’inscrire aux SMS pour une application, tout en les invitant à s’inscrire aux notifications poussées ou à WebAuthN pour une autre application.

This feature allows you to customize your MFA enrollment flows. If you want to customize MFA flows for users who are already enrolled, review [Customize MFA Selection for Universal Login](/docs/secure/multi-factor-authentication/customize-mfa/customize-mfa-selection-universal-login).

## Fonctionnement

You can use [Actions](/docs/customize/actions) to customize your MFA enrollment flows. Specifically, you can modify the `post-login` trigger of the [Login Flow](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger) with the following Authentication API methods:

* `enrollWith`: Cette section spécifie le facteur par défaut présenté aux utilisateurs lors de l’inscription. Facultativement, vous pouvez fournir une liste alternative de facteurs parmi lesquels les utilisateurs peuvent choisir. Si elle est fournie, un lien « Essayer une autre méthode » s’affiche sur l’invite d’inscription.
* `enrollWithAny`: Cette section spécifie un ensemble de facteurs parmi lesquels les utilisateurs peuvent choisir lors de l’inscription. Par défaut, cette méthode présente une invite de sélection qui permet aux utilisateurs de choisir leur facteur souhaité. Dans certains cas, l’expérience utilisateur peut varier :

  + Si deux facteurs ou plus ont été spécifiés, l’invite de sélection s’affiche à l’utilisateur.
  + Si l’utilisateur s’est déjà inscrit à tous les facteurs spécifiés sauf un, l’invite de sélection est ignorée, et l’utilisateur est invité à s’inscrire au facteur restant.
  + Si l’utilisateur est déjà inscrit dans tous les facteurs spécifiés, la commande échoue et la séquence de connexion se poursuit.

Vous pouvez utiliser une combinaison de ces méthodes pour personnaliser vos flux d’inscription à MFA. Vous pouvez également intégrer des métadonnées utilisateur, telles que les rôles ou la date de la dernière connexion, pour créer des expériences plus personnalisées.

Les flux d’inscription personnalisés prennent en charge les facteurs suivants :

* `otp`
* `recovery-code`
* `push-notification`
* `téléphone`

  + `méthode préférée : voix`
  + `méthode préférée : sms`
  + `méthode préférée : les deux`
* `webauthn-platform`
* `webauthn-roaming`

Après qu’un utilisateur s’est inscrit à un facteur, sa valeur est ajoutée à `enrolledFactors`. Cette propriété représente la liste des facteurs actifs associés à leur compte utilisateur.

Le tableau `event.authentication.methods` inclut un champ `type` lorsque le nom de la méthode est défini sur `mfa`. Ce champ contient des valeurs de facteur (chaîne) qui correspondent à celles utilisées par le champ `type` dans `enrolledFactors`.

Lorsqu’une inscription à MFA se produit, `methods` contient l’objet de `name:mfa` et le `type` défini sur le facteur utilisé pour cet événement. `methods` et `enrolledFactors` ne sont mis à jour que lorsqu’une action commence pour la première fois. Vous pouvez accéder aux résultats d’un événement d’inscription dans l’action suivante du flux.

Pour en apprendre davantage, examinez les ressources suivantes :

* [Actions Triggers: post-login - Event Object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-event-object)
* [Actions Triggers: post-login - API Object](/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-api-object)

### Flux séquencés et contextuels

Avec les commandes `enrollWith` ou `enrollWithAny` vous pouvez utiliser des informations contextuelles pour déterminer la meilleure inscription ou la série d’inscriptions à présenter aux utilisateurs.

* The `enrollWith` command supports an initial or default factor and a list of alternatives. Users can only enroll in one factor per command.
* La commande `enrollWithAny` prend en charge une liste de facteurs. L’ordre spécifié des facteurs détermine comment la liste s’affiche aux utilisateurs. Les utilisateurs ne peuvent s’inscrire qu’à un seul facteur par commande.

Grâce à ces commandes, vous pouvez tirer parti des éléments suivants :

* **Flux séquencés** : Inscrivez les utilisateurs avec une série de facteurs dans un ordre spécifique.
* **Flux contextuels** : Déterminez quel facteur proposer à l’utilisateur en fonction des métadonnées ou des commandes précédentes dans le flux.

Pour illustrer ces flux, considérons l’exemple suivant :

```javascript lines expandable
// Action 1

exports.onExecutePostLogin = async (event, api) => {
  if (event.user.enrolledFactors.length) {
    // already enrolled, challenge
    api.authentication.challengeWithAny(event.user.enrolledFactors.map(m => ({type: m.type})));
    if (event.user.app_metadata.isAdmin &&
        !event.user.enrolledFactors.some(m => m.type === 'webauthn-roaming')) {
          // if is admin and doesn't have a security key, meaning a different factor was used, enroll now
          api.authentication.enrollWith({type: 'webauthn-roaming'})
        }
  }
  else {
    // not enrolled; choose a factor to enroll now
    api.authentication.enrollWithAny([{type: 'webauthn-roaming'}, {type: 'otp'}]);
    if (event.user.app_metadata.isAdmin) {
      // one more factor for admins
      api.authentication.enrollWithAny([{type: 'webauthn-roaming'}, {type: 'otp'}]);
    }
  }
};

// Action 2

exports.onExecutePostLogin = async (event, api) => {
  function performed(type) {
    return event.authentication.methods.some(m => m.name === 'mfa' &&
           m.type === type &&
           Date.now() - new Date(m.timestamp).getTime() < 5000)
  }
  if (event.user.app_metadata.isAdmin) {
      // enforce both factors are used by challenging the one that has not been used yet
      if (!performed('webauthn-roaming')) {
        api.authentication.challengeWith({type: 'webauthn-roaming'})
      }
      else if (!performed('otp')) {
        api.authentication.challengeWith({type: 'otp'})
      }
  }
};
```






Ces deux actions fusionnent pour créer un scénario où les utilisateurs **sans** le rôle d’administrateur sont tenus de s’inscrire soit avec un mot de passe à usage unique (OTP), soit avec une clé de sécurité. À l’inverse, les utilisateurs **ayant** le rôle d’administrateur doivent s’inscrire dans les deux facteurs.

L’Action 1 examine les `app_metadata` pour déterminer si l’utilisateur est un administrateur, puis l’invite à s’inscrire dans des facteurs spécifiques. Si un utilisateur administrateur ne s’est inscrit qu’à l’OTP, il est d’abord confronté à l’OTP pour terminer son authentification. Ils sont ensuite invités à s’inscrire avec des clés de sécurité (`webauthn-roaming`).

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

To keep user accounts secure, users must complete an MFA challenge using one of their existing enrolledFactors before they can enroll in additional factors. This condition ensures you can safely implement a custom MFA enrollment policy after an application with different factors and configurations has already been used.

</Callout>

Le flux fait une pause après l’exécution de l’Action 1, et `event.user.enrolledFactors` et `event.authentication.methods` seront mises à jour lorsque l’Action 2 s’exécutera. Cela permet au code de l’Action de prendre des décisions en fonction des données réelles de l’utilisateur lorsque les utilisateurs ont le choix de se confronter à ou de s’inscrire dans différents facteurs.

**Remarque** : Cette méthode d’exécution des actions s’applique uniquement à celles contenant les commandes `challengeWith` ou `challengeWithAny`. Les actions servant à d’autres fins ne sont pas affectées.

## Avant de commencer

Before you can customize your MFA flows, you must set up MFA in your tenant and enable the Customize MFA Factors using Actions setting. You can enable one or more factors and define your MFA policies on your <Tooltip tip="Auth0 Dashboard: Auth0's main product to configure your services." cta="View Glossary" href="/docs/glossary?term=Auth0+Dashboard">Auth0 Dashboard</Tooltip> under [Security > Multi-factor Auth](https://manage.auth0.com/#/security/mfa).

* To learn more about the setup process, review [Enable Multi-Factor Authentication](/docs/secure/multi-factor-authentication/enable-mfa).
* For information about configuring specific factors, review [Multi-factor Authentication Factors](/docs/secure/multi-factor-authentication/multi-factor-authentication-factors).

Pour personnaliser vos flux, vous devez activer Personnaliser les facteurs MFA à l’aide du commutateur d’actions situé dans la section Paramètres additionnels. Vos flux personnalisés ne fonctionneront pas correctement si ce paramètre n’est pas activé.

<Frame>![Auth0 Dashboard > Security > Multi-factor Auth > Additional Settings](/images/cdy7uua7fh8z/2hv0ELTkkka3t230SXfxw/46def5395652b2451cfc9e0ad01a371a/MFA_actions.png)</Frame>

**Remarque** : Les Actions avec les commandes `enrollWith` ou `enrollWithAny` remplacent toutes les politiques ou règles existantes qui activent ou désactivent la MFA dans un locataire.

## Personnaliser les flux d’inscription à MFA

Après avoir configuré la MFA pour votre locataire, vous pouvez créer des Actions `post-login` pour personnaliser vos flux d’inscription à MFA.

<Warning>

Actions (or series of Actions) in a tenant can only execute **four** of the following commands per user flow:

* `enrollWith`
* `enrollWithAny`
* `challengeWith`
* `challengeWithAny`

If this limit is exceeded (i.e., a fifth command of this type attempts to execute), an authentication error will occur.

</Warning>

### Créer votre action post-connexion

Vous pouvez créer des actions via Auth0 Dashboard :

1. Navigate to [Actions > Flows](https://manage.auth0.com/#/actions/flows) and select **Login**.
2. In the Add Action panel, select the **plus sign (+)** icon and choose **Build from scratch**.
3. On the Create Action popup:

   * Saisissez un nom pour votre action.
   * Sélectionnez **Login / Post-Login (Connexion/ Post-connexion)** comme déclencheur.
   * Utilisez **Node 18 (Nœud 18) (Recommandé)** comme temps de fonctionnement.
4. Review the popup to ensure accuracy. Then, select **Create**.
5. In the code editor, add your custom code to the `onPostExecute` command.
6. When your command is ready, select **Deploy**.
7. Select **Add to Flow** on the successful deployment notification.

   * **Remarque** : Si la notification se ferme, choisissez **Back to Flow (Retour au flux)** situé au-dessus de l’éditeur de code.
8. Drag and drop your new command from the Add Action panel into your Login flow. Then, select **Apply**.

To make additional changes after saving, navigate to [Actions > Library > Custom](https://manage.auth0.com/#/actions/library) and select your Action. You can then update and redeploy your code as needed.

### Tester votre action post-connexion

Pour être certain que vos commandes fonctionnent correctement, vous pouvez mettre votre action à l’essai via le Tableau de bord Auth0 :

1. Navigate to [Authentication > Authentication Profile](https://manage.auth0.com/#/authentication-profiles).
2. Select **Try** to open a sample login prompt in a new tab.
3. Enter your credentials and test your new MFA flow.

If the flow is successful, a confirmation screen displays. If you encounter any issues, you can update your code by navigating to [Actions > Library > Custom](https://manage.auth0.com/#/actions/library) in your Auth0 Dashboard.

## Exemples de cas d’utilisation

Les exemples ci-dessous décrivent un cas d’utilisation courant pour personnaliser les flux d’inscription à MFA.

### Proposez aux utilisateurs des options MFA pour l’inscription

L’exemple suivant met les utilisateurs au défi en mettant par défaut un mot de passe à usage unique. S’ils le souhaitent, ces derniers peuvent accéder au lien Essayer une autre méthode pour s’authentifier par courriel.

## Dépannage

Si vous rencontrez des erreurs ou obtenez des résultats inattendus avec vos inscriptions personnalisées à MFA, vous pouvez utiliser les renseignements ci-dessous pour vous aider à identifier et à résoudre ces problèmes.

### Journaux de locataires

You can monitor your customized MFA enrollments through [tenant logs](/docs/deploy-monitor/logs).

Tenant logs are available in the Auth0 Dashboard under [Monitoring > Logs](https://manage.auth0.com/#/logs). Alternatively, you can retrieve logs using the [Management API](https://auth0.com/docs/api/management/v2/introduction).

Si vous ou vos utilisateurs remarquez un comportement inattendu, consultez les journaux des locataires pour les codes d’événement suivants afin d’en savoir plus :

<table class="table"><thead>
<tr>
<th>Scenario</th>
<th>Event</th>
<th>Error Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>A user is prompted to enroll with a specific factor. However, the requested factor meets one of the following conditions:<br/><ul><li>The factor is not enabled in your tenant.</li><li>The factor is not supported by the user's browser.</li><li>The user has already enrolled in the requested factor.</li></ul>In this scenario, the user can complete the flow if alternative factors are available.</td>
<td>w</td>
<td>An MFA enrollment is used in a PostLogin action, but the requested factor ${factor.name} is not properly set up. Enable the requested factor and ensure the user is not already enrolled with it.</td>
</tr>
<tr>
<td>A user is prompted to enroll with one or more factors, but the supplied factors cannot be used for enrollment. In this case, the user cannot complete the flow.</td>
<td>mfar</td>
<td>An MFA enrollment is used in a PostLogin action but the requested factors are not properly set up. To perform MFA, enable the requested factors and ensure the user is not already enrolled with them.</td>
</tr>
<tr>
<td>A user attempts to enroll in a new factor without completing at least one challenge using an existing enrollment.</td>
<td>mfar</td>
<td>An MFA enrollment was requested but the user is already enrolled in MFA. Challenge with at least one existing factor before enrolling a new one.</td>
</tr>
</tbody>
</table>

### Liste de vérification de dépannage

La liste de vérification suivante fournit des suggestions supplémentaires pour identifier et résoudre les problèmes courants liés aux flux MFA personnalisés.

1. The **Customize MFA factors with Actions** toggle must be enabled.

   * Navigate to [Auth0 Dashboard > Security > Multi-factor Auth](https://manage.auth0.com/#/security/mfa) and ensure the toggle in the Additional Settings section is enabled.
2. Factors referenced in your Actions must be enabled in your tenant.

   * **Review your code**: Navigate to [Auth0 Dashboard > Actions > Library > Custom](https://manage.auth0.com/#/actions/library) and review your Actions code. Ensure all factors referenced are applicable to your use cases.
   * **Review your factors**: Navigate to [Auth0 Dashboard > Security > Multi-factor Auth](https://manage.auth0.com/#/security/mfa) and ensure all factors referenced in your Actions are enabled.
3. Ensure your Actions have been deployed and saved in your Pipeline.

   1. Navigate to [Auth0 Dashboard > Actions > Library > Custom](https://manage.auth0.com/#/actions/library). Locate your Action in the list and ensure its status is **Deployed**. If a different status is listed, access your Action, review your code, and click **Deploy** to the top right.
   2. Navigate to [Auth0 Dashboard > Actions > Library > Flows](https://manage.auth0.com/#/actions/flows) and select **Login**. Ensure your Action is listed in the flow. If not, access the **Custom tab** of the Add Action panel and drag and drop your Action into your Login flow. Then, select **Apply**.
4. Ensure you've upgraded to the latest version of `post-login` Actions.

   * Navigate to [Auth0 Dashboard > Actions > Library > Custom](https://manage.auth0.com/#/actions/library) and select your Action. If your Action is out-of-date, you will see a yellow banner prompting you to update the Action. If the banner displays, select **Update**.
   * You can also specify the latest version of `post-login` Actions for deployment when using the Deploy CLI. For more information, review [Configure the Deploy CLI](/docs/deploy-monitor/deploy-cli-tool/configure-the-deploy-cli).