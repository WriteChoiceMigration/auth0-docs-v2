---
og:description: Describes how to migrate from using ID tokens to access tokens when
  linking user accounts.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Migrate to Access Tokens for Account Linking (Migrer vers des jetons d’accès
  pour associer les comptes)
og:url: https://auth0.com/docs/
permalink: link-user-accounts-with-access-tokens-migration
title: Migrate to Access Tokens for Account Linking (Migrer vers des jetons d’accès
  pour associer les comptes)
twitter:description: Describes how to migrate from using ID tokens to access tokens
  when linking user accounts.
twitter:title: Migrate to Access Tokens for Account Linking (Migrer vers des jetons
  d’accès pour associer les comptes)
---

Auparavant, il était possible d’utiliser des jetons d’ID pour associer et désassocier des comptes d’utilisateurs dans certains cas d’utilisation. Auth0 supprime cette fonctionnalité. Vous devrez désormais utiliser des jetons d’accès dans tous les cas.



## Fonctionnalités affectées

Les modifications dans l’association des comptes sont :

* Vous ne pouvez plus utiliser de jeton d’ID dans l’en-tête `Authorization`, un jeton d’accès doit être utilisé à la place.
* Si vous utilisez un jeton d’accès dans l’en-tête `Authorization`, avec `update:users` comme permission accordée, vous pouvez envoyer comme le corps de la requête soit le `user_id`, soit le jeton d’ID du compte secondaire.
* Si vous utilisez un jeton d’accès dans l’en-tête `Authorization`, avec `update:current_user_metadata` comme permission accordée, vous ne pouvez envoyer que le jeton d’ID du compte secondaire dans le corps de la requête.
* Si vous envoyez le jeton d’ID du compte secondaire dans le corps de la requête (cas d’utilisation décrits dans les deux points précédents), les conditions suivantes doivent s’appliquer :

* Le jeton d’ID doit être signé à l’aide de `RS256` (vous pouvez définir cette valeur dans **Dashboard > Clients > Réglages client > Réglages avancés > OAuth**.
* La demande `aud` du jeton d’ID doit identifier le client et avoir la même valeur que la demande `azp` du jeton d’accès.
* Pour dissocier les comptes, vous ne pouvez plus utiliser de jeton d’ID à l’entête `Authorization`. Vous devez utiliser un jeton d’accès à la place.

Il existe plusieurs façons de lier et de dissocier des comptes. Dans la liste suivante, vous pouvez voir les cas d’utilisation et la façon dont les changements les affectent.



## Actions

Passez en revue tous vos appels au [point de terminaison Identities](/api/management/v2/#!/Users/post_identities) d’association de comptes et mettez à jour ceux qui utilisent le flux vulnérable décrit ci-dessus. Vous pouvez mettre à jour vos requêtes en choisissant l’une des options suivantes :

* **Scénarios d’association côté client / à l’initiative de l’utilisateur :** pour les scénarios d’association côté client, faites l’appel au point de terminaison Identities en utilisant un jeton d’accès avec la permission `update:current_user_identities`, et fournissez le jeton d’ID du compte secondaire dans la charge utile (`link_with`). Ce jeton d’ID doit être obtenu par un flux conforme à OAuth/OIDC.
* **Scénarios d’association côté serveur****: **pour les scénarios d’association côté serveur, appelez le point de terminaison Identities à l’aide d’un jeton d’accès avec la permission `update:users` et fournissez le `user_id` du compte secondaire dans la charge utile.

Consultez [Associer des comptes d’utilisateurs](/users/user-account-linking/link-user-accounts) pour obtenir plus de détails.

### Associer des comptes d’utilisateurs

Pour associer des comptes d’utilisateurs, vous pouvez appeler le point de terminaison [Associer un compte utilisateur](https://auth0.com/docs//api/management/v2#!/Users/post_identities) de Management API ou utiliser la [bibliothèque Auth0.js](/libraries/auth0js).

#### Associer des comptes d’utilisateurs actuels avec le Management API

Un cas d’utilisation courant consiste à permettre à l’utilisateur connecté d’associer ses comptes à l’aide de votre application.

Avant cette dépréciation, vous pouviez utiliser le jeton d’ID de l’utilisateur principal ou le jeton d’accès (qui contenait la permission `update:current_user_identities`) pour vous authentifier auprès de Management API et utiliser le point de terminaison [Associer un compte utilisateur](https://auth0.com/docs/api/management/v2#!/Users/post_identities).

Désormais, vous devez obtenir un jeton d’accès (contenant la permission `update:current_user_identities`) et l’utiliser pour vous authentifier auprès de l’API et utiliser le point de terminaison Associer un compte utilisateur. Les données utiles doivent être le jeton d’ID de l’utilisateur secondaire.

1. Obtenez un jeton d’accès avec la permission `update:current_user_identities` comme le montre l’exemple suivant. L’exemple utilise le [flux implicite](/login/flows/implicit-flow-with-form-post), mais vous pouvez [obtenir des jetons d’accès](/security/tokens/access-tokens/get-access-tokens) pour n’importe quel type d’application.
2. En utilisant la méthode précédente avec un jeton d’ID, votre code ressemblerait à ceci : 
En utilisant la nouvelle méthode avec un jeton d’accès, votre code ressemblera à ceci :
3. Pour obtenir un jeton d’accès à Management API :

1. Définir `audience` à `https://${account.namespace}/api/v2/`.
2. Demandez la `scope``${scope}`.
3. Définissez le `response_type` à `id_token token` pour que Auth0 envoie à la fois un jeton d’ID et un jeton d’accès.
Si nous décodons le jeton d’accès et examinons son contenu, nous constatons ce qui suit :

Remarquez que `aud` est défini sur l’URI de l’API de votre locataire, `scope` sur `${scope}`, et `sub` sur l’identifiant de l’utilisateur connecté.
4. Les conditions suivantes doivent être remplies :

1. Le jeton d’ID du compte secondaire doit être signé avec `RS256.`
2. La demande `aud` dans le jeton d’ID du compte secondaire doit identifier le client et avoir la même valeur que la demande `azp` du jeton d’accès utilisé pour effectuer la demande.
5. Une fois que vous avez le jeton d’accès, vous pouvez l’utiliser pour associer des comptes d’utilisateurs. Cette partie reste inchangée, rien d’autre ne change dans la demande, à l’exception de la valeur utilisée comme jeton `Bearer`. La réponse reste également la même.

#### Associer les comptes utilisateurs actuels avec auth0.js

Si vous utilisez la [bibliothèque auth0.js](/libraries/auth0js) pour accéder à Management API et associer des comptes, vous utilisez probablement le jeton d’ID de l’identité principale de l’utilisateur pour instancier `auth0.Management` et l’utiliser pour associer des comptes.

1. Obtenez un jeton d’accès avec la permission `update:current_user_identities`, puis utilisez ce jeton pour instancier `auth0.Management`. L’appel final à `linkUser`reste inchangé.
2. En utilisant la méthode précédente avec un jeton d’ID, votre code ressemblerait à ceci : 
En utilisant la nouvelle méthode avec un jeton d’accès, votre code ressemblera à ceci :

1. Demande un jeton d’ID et un jeton d’accès en réponse (`responseType: `token id_token``).
2. Définit Management API comme public cible du jeton (`audience: `https://{yourDomain}/api/v2/``).
3. Demande la permission requise (`scope: `update:current_user_identities``).
4. S’authentifie auprès de Management API à l’aide du jeton d’accès.

#### Associer n’importe quel compte d’utilisateur à Management API

Si vous obtenez un jeton d’accès pour l’association de comptes qui contient la permission `update:users`, et que vous envoyez le `user_id` et le `provider` du compte secondaire dans la requête, vous n’avez pas besoin d’effectuer de modifications.

Toutefois, cette nouvelle méthode offre une alternative. Vous utiliserez toujours un jeton d’accès contenant la permission `update:users` pour vous authentifier auprès de l’API, mais dans la charge utile de la demande, vous pouvez envoyer le jeton d’ID du compte secondaire (au lieu du `user_id` et du `provider`).



Les conditions suivantes doivent être remplies :

* Le jeton d’ID du compte secondaire doit être signé avec `RS256`.
* La demande `aud` dans le jeton d’ID du compte secondaire doit identifier le client et avoir la même valeur que la demande `azp` du jeton d’accès utilisé pour effectuer la demande.

### Désassocier des comptes d’utilisateurs

Si vous utilisez des jetons d’ID pour dissocier des comptes, vous devez mettre à jour votre code pour utiliser des jetons d’accès.

1. Tout d’abord, vous devez obtenir un jeton d’accès avec la permission `update:current_user_identities`.
2. En utilisant la méthode précédente avec un jeton d’ID, votre code ressemblerait à ceci : 
En utilisant la nouvelle méthode avec un jeton d’accès, votre code ressemblera à ceci :
3. Pour obtenir un jeton d’accès à Management API :

1. Définir `audience` à `https://${account.namespace}/api/v2/`.
2. Demandez la `scope``${scope}`.
3. Définissez le `response_type` à `id_token token` pour que Auth0 envoie à la fois un jeton d’ID et un jeton d’accès.
Si nous décodons le jeton d’accès et examinons son contenu, nous constatons ce qui suit :
Notez que `aud` est défini sur l’URI de l’API de votre locataire, `scope` sur `update:current_user_identities`, et `sub` sur l’identifiant de l’utilisateur connecté.``
4. Une fois que vous avez le jeton d’accès, vous pouvez appeler le [point de terminaison Dissocier l’identité d’un utilisateur](https://auth0.com/docs/api/management/v2#!/Users/delete_user_identity_by_user_id) de Management API, en l’utilisant dans l’en-tête `Autorisation`.
5. En utilisant la méthode précédente, votre requête ressemblera à ceci :
En utilisant la nouvelle méthode, votre requête ressemblera à ceci :

## Considérations relatives à la sécurité

Nous avons identifié une faiblesse dans le flux de liaison d’un compte particulier qui pourrait permettre de l’utiliser à mauvais escient dans des circonstances spécifiques. Nous n’avons trouvé aucune preuve que cela ait été utilisé de manière malveillante, mais nous avons décidé de déprécier le flux pour éviter que cela ne se produise.

Par conséquent, Auth0 demande aux clients qui utilisent le flux de liaison de compte affecté de migrer vers une implémentation plus sécurisée avant le 19 octobre 2018. Le présent guide fournit des pistes de migration qui ne devraient pas entraîner de perte de fonctionnalité.

À partir du 19 octobre 2018, le flux de liaison des comptes concernés sera désactivé et des erreurs d’exécution se produiront.

Vous êtes concerné si vous appelez le [point de terminaison Post Identities](https://auth0.com/docs/api/management/v2#!/Users/post_identities) en utilisant un jeton (identifiant ou jeton d’accès) avec la permission `update:current_user_identities` dans l’en-tête Authorization et que vous incluez le `user_id` du compte secondaire dans la charge utile. Aucun autre cas d’utilisation n’est affecté.