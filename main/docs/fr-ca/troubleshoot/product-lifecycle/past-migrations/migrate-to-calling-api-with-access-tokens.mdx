---
og:description: Describes the deprecation of using ID tokens as credentials for the
  Management API and how to migrate your configuration to use access tokens.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Migrer vers les points de terminaison de Management API avec des jetons
  d’accès
og:url: https://auth0.com/docs/
permalink: migrate-to-calling-api-with-access-tokens
title: Migrer vers les points de terminaison de Management API avec des jetons d’accès
twitter:description: Describes the deprecation of using ID tokens as credentials for
  the Management API and how to migrate your configuration to use access tokens.
twitter:title: Migrer vers les points de terminaison de Management API avec des jetons
  d’accès
---

Using <Tooltip tip="ID Token: Credential meant for the client itself, rather than for accessing a resource." cta="View Glossary" href="/docs/glossary?term=ID+tokens">ID tokens</Tooltip> to call <Tooltip tip="ID Token: Credential meant for the client itself, rather than for accessing a resource." cta="View Glossary" href="/docs/glossary?term=Management+API">Management API</Tooltip> endpoints is being deprecated. You must use <Tooltip tip="Management API: A product to allow customers to perform administrative tasks." cta="View Glossary" href="/docs/glossary?term=access+tokens">access tokens</Tooltip>. The grace period for this migration started on **March 31, 2018**.

Une fois la migration vers les jetons d’accès terminée, désactivez le bouton à bascule **Autoriser les jetons d’ID pour l’authentification Management API v2** dans le Dashboard.

Si vous utilisez des jetons d’ID pour appeler l’un des points de terminaison suivants, vous êtes concerné par cette migration. Ces points de terminaison peuvent désormais accepter des jetons d’accès ordinaires. Rien d’autre ne change dans la façon dont les points de terminaison fonctionnent. Les schémas de demande et de réponse sont les mêmes et il suffit de mettre à jour le jeton que vous utilisez pour l’autorisation.

## Points de terminaison concernés

<table class="table"><thead>
<tr>
<th>Endpoint</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET /api/v2/users/{id}</td>
<td>Retrieve a user's information</td>
</tr>
<tr>
<td>GET /api/v2/users/{id}/enrollments</td>
<td>Retrieve all Guardian MFA enrollments for a user</td>
</tr>
<tr>
<td>PATCH /api/v2/users/{id}</td>
<td>Update a user's information</td>
</tr>
<tr>
<td>DELETE /api/v2/users/{id}/multifactor/{provider}</td>
<td>Delete the MFA provider settings for a user</td>
</tr>
<tr>
<td>POST /api/v2/device-credentials</td>
<td>Create a public key for a device</td>
</tr>
<tr>
<td>DELETE /api/v2/device-credentials/{id}</td>
<td>Delete a device credential</td>
</tr>
<tr>
<td>POST/api/v2/users/{id}/identities</td>
<td>Link user accounts from various identity providers</td>
</tr>
<tr>
<td>DELETE /api/v2/users/{id}/identities/{provider}/{user_id}</td>
<td>Unlink user accounts</td>
</tr>
</tbody>
</table>

## Actions

### Modifications de permissions

Les actions que vous pouvez effectuer avec Management API dépendent des permissions que votre jeton d’accès contient. Avec cette migration, vous pouvez obtenir soit un jeton d’accès limité qui ne peut mettre à jour que les données de l’utilisateur connecté, soit un jeton d’accès qui peut mettre à jour les données de n’importe quel utilisateur. Dans la matrice suivante, vous pouvez voir les permissions que votre jeton doit avoir par cas et par point de terminaison.

For example, if you get an access token that contains the scope `read:users`, you can retrieve the data of any user using the `GET /api/v2/users/{id}` endpoint. However, if your token contains the scope `read:current_user`, you can only retrieve the information of the currently logged-in user (the one that the token was issued for).

<table class="table"><thead>
<tr>
<th>Endpoint</th>
<th>Scope for current user</th>
<th>Scope for any user</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET /api/v2/users/{id}</td>
<td><code>read:current_user</code></td>
<td><code>read:users</code></td>
</tr>
<tr>
<td>GET /api/v2/users/{id}/enrollments</td>
<td><code>read:current_user</code></td>
<td><code>read:users</code></td>
</tr>
<tr>
<td>POST/api/v2/users/{id}/identities</td>
<td><code>update:current_user_identities</code></td>
<td><code>update:users</code></td>
</tr>
<tr>
<td>DELETE /api/v2/users/{id}/identities/{provider}/{user_id}</td>
<td><code>update:current_user_identities</code></td>
<td><code>update:users</code></td>
</tr>
<tr>
<td>PATCH /api/v2/users/{id}</td>
<td><code>update:current_user_metadata</code></td>
<td><code>update:users</code></td>
</tr>
<tr>
<td>PATCH /api/v2/users/{id}</td>
<td><code>create:current_user_metadata</code></td>
<td><code>update:users</code></td>
</tr>
<tr>
<td>DELETE /api/v2/users/{id}/multifactor/{provider}</td>
<td><code>delete:current_user_metadata</code></td>
<td><code>update:users</code></td>
</tr>
<tr>
<td>POST /api/v2/device-credentials</td>
<td><code>create:current_user_device_credentials</code></td>
<td><code>create:device_credentials</code></td>
</tr>
<tr>
<td>DELETE /api/v2/device-credentials/{id}</td>
<td><code>delete:current_user_device_credentials</code></td>
<td><code>delete:device_credentials</code></td>
</tr>
</tbody>
</table>

### Obtenir des jetons d’accès

Auth0 has changed how you get a token for the previously mentioned endpoints. There are several variations on how you authenticate a user and get tokens, depending on the technology and the <Tooltip tip="OAuth 2.0: Authorization framework that defines authorization protocols and workflows." cta="View Glossary" href="/docs/glossary?term=OAuth+2.0">OAuth 2.0</Tooltip> flow you use to authenticate:

* **SPA fonctionnant dans un navigateur** : utilisez le point de terminaison d’autorisation.
* **Web app running on a server, a mobile app, a server process, or a highly trusted app**: Use the <Tooltip tip="Token Endpoint: Endpoint on the Authorization Server that is used to programmatically request tokens." cta="View Glossary" href="/docs/glossary?term=Token+endpoint">Token endpoint</Tooltip>.
* **Authentification croisée** : utilisez Lock intégré ou auth0.js pour authentifier les utilisateurs lorsque les demandes proviennent de domaines différents.

#### Point de terminaison d’autorisation

Dans cette section, nous allons utiliser un exemple pour montrer les différences dans la façon dont vous obtenez un jeton avec le point de terminaison Authorization. Gardez à l’esprit que, quel que soit le point de terminaison que vous souhaitez migrer, les changements sont les mêmes, la seule chose qui diffère sont les permissions que vous spécifiez dans la requête.

Dans l’exemple ci-dessous, vous utilisez le point de terminaison `GET User by ID (Obtenir l’utilisateur par identifiant)` pour récupérer les informations de profil complètes de l’utilisateur connecté. Pour ce faire, nous allons d’abord authentifier l’utilisateur à l’aide de l’octroi implicite et récupérer le(s) jeton(s). Vous pouvez voir ci-dessous une implémentation de l’ancienne approche qui obtient un jeton d’ID et l’utilise ensuite pour appeler le point de terminaison.

```http lines
https://{yourDomain}/authorize?
      scope=openid
      &response_type=id_token
      &client_id={yourClientId}
      &redirect_uri=https://{yourApp}/callback
      &nonce={nonce}
      &state={opaqueValue}
```






Dans l’exemple ci-dessous, vous pouvez voir la nouvelle approche qui obtient un jeton d’accès.


```http lines
https://{yourDomain}/authorize?
      audience=https://{yourDomain}/api/v2/
      &scope=read:current_user
      &response_type=token%20id_token
      &client_id={yourClientId}
      &redirect_uri=https://{yourApp}/callback
      &nonce={nonce}
      &state={opaqueValue}
```






Pour obtenir un jeton d’accès permettant d’accéder à Management API :

* Set the `audience` to `https://{yourDomain}/api/v2/`
* Demander la permission `${scope}`
* Définissez le `response_type` à `id_token token` pour que Auth0 envoie à la fois un jeton d’ID et un jeton d’accès.

Si vous décodez le jeton d’accès reçu et examinez son contenu, vous verrez ce qui suit :

```json lines
{
      "iss": "https://{yourDomain}/",
      "sub": "auth0|5a620d29a840170a9ef43672",
      "aud": "https://{yourDomain}/api/v2/",
      "iat": 1521031317,
      "exp": 1521038517,
      "azp": "{yourClientId}",
      "scope": "${scope}"
    }
```






Remarquez que `aud` est défini sur l’URI de l’API de votre locataire, `scope` est défini sur `${scope}`, et `sub` est défini sur l’identifiant de l’utilisateur connecté.

Une fois que vous avez le jeton d’accès, vous pouvez l’utiliser pour appeler le point de terminaison. Cette partie reste inchangée, rien d’autre ne change dans la demande, à l’exception de la valeur utilisée comme jeton `Bearer`. La réponse reste également la même.

#### Point de terminaison du jeton

Dans cette section, nous allons utiliser un exemple pour montrer les différences dans la façon dont vous obtenez un jeton avec le point de terminaison du jeton. Gardez à l’esprit que, quel que soit le point d’accès que vous souhaitez migrer, les changements sont les mêmes, la seule chose qui diffère est les permissions que vous spécifiez dans la requête.

Dans l’exemple ci-dessous, vous souhaitez utiliser le point de terminaison `GET User by ID` pour récupérer les informations de profil complètes de l’utilisateur connecté. Tout d’abord, authentifiez l’utilisateur à l’aide de l’octroi Password Exchange (Échange de mot passe), puis récupérez le(s) jeton(s). Vous pouvez voir ci-dessous une implémentation de l’ancienne approche qui obtient un jeton d’ID (et l’utilise ensuite pour appeler le point de terminaison).


```json lines
POST https://{yourDomain}/oauth/token
    Content-Type: application/x-www-form-urlencoded
    {
      "grant_type": "password",
      "username": "{yourUsername}",
      "password": "{yourPassword}",
      "scope": "openid",
      "client_id": "{yourClientId}",
      "client_secret": "{yourClientSecret}",
    }
```






Dans l’exemple ci-dessous, vous pouvez voir la nouvelle approche qui obtient également un jeton d’accès.

```json lines
POST https://{yourDomain}/oauth/token
    Content-Type: application/x-www-form-urlencoded
    {
      "grant_type": "password",
      "username": "{yourUsername}",
      "password": "{yourPassword}",
      "audience": "https://{yourDomain}/api/v2/",
      "scope": "read:current_user",
      "client_id": "{yourClientId}",
      "client_secret": "{yourClientSecret}",
    }
```






Pour obtenir un jeton d’accès permettant d’accéder à Management API :

* Set the `aud` to `https://{yourDomain}/api/v2/`
* Demandez la permission `read:current_user`

Une fois que vous avez le jeton d’accès, vous pouvez l’utiliser pour appeler le point de terminaison. Cette partie reste inchangée, rien d’autre ne change dans la demande, à l’exception de la valeur utilisée comme jeton `Bearer`. La réponse reste également la même.

#### Lock intégré ou auth0.js

Si vous intégrez Lock ou auth0.js v9 dans votre application, vous utilisez l’authentification inter-origines. Celle-ci est utilisée pour authentifier les utilisateurs lorsque les demandes proviennent de domaines différents.

Si vous utilisez auth0.js pour accéder à Management API et gérer vos utilisateurs, votre script devra être mis à jour.

Dans l’exemple ci-dessous, vous pouvez voir l’ancienne approche.

```javascript lines
// get an ID Token
    var webAuth = new auth0.WebAuth({
      clientID: '{yourClientId}',
      domain: '{yourDomain}',
      redirectUri: 'https://{yourApp}/callback',
      scope: 'openid',
      responseType: 'id_token'
    });
    // create a new instance
    var auth0Manage = new auth0.Management({
      domain: '{yourDomain}',
      token: '{yourIdToken}'
    });
```


Dans cet exemple, vous pouvez voir la nouvelle approche.

```javascript lines
// get an Access Token
    var webAuth = new auth0.WebAuth({
      clientID: '{yourClientId}',
      domain: '{yourDomain}',
      redirectUri: 'https://{yourApp}/callback',
      audience: 'https://{yourDomain}/api/v2/',
      scope: 'read:current_user',
      responseType: 'token id_token'
    });
    // create a new instance
    var auth0Manage = new auth0.Management({
      domain: '{yourDomain}',
      token: '{yourMgmtApiAccessToken}'
    });
```






* Demandez un jeton d’ID et un jeton d’accès dans la réponse

  `responseType: 'token id_token'`
* Set the Management API as the intended <Tooltip tip="Audience: Unique identifier of the audience for an issued token. Named aud in a token, its value contains the ID of either an application (Client ID) for an ID Token or an API (API Identifier) for an Access Token." cta="View Glossary" href="/docs/glossary?term=audience">audience</Tooltip> of the token

  `audience: 'https://YOUR_DOMAIN/api/v2/'`
* Demander la permission requise

  `scope: 'read:current_user'`
* S’authentifier auprès de Management API à l’aide du jeton d’accès

### Changements dans la liaison des comptes

Les modifications apportées à cette fonctionnalité sont les suivantes :

* Vous ne pouvez plus utiliser de jeton d’ID dans l’en-tête `Authorization`.
* Si vous utilisez un jeton d’accès dans l’en-tête `Authorization`, avec `update:users` comme permission accordée, vous pouvez envoyer dans le corps de la requête soit le `user_id`, soit le jeton d’ID du compte secondaire.
* Si vous utilisez un jeton d’accès dans l’en-tête `Authorization`, avec `update:current_user_metadata` comme permission accordée, vous ne pouvez envoyer que le jeton d’ID du compte secondaire dans le corps de la requête. Les conditions suivantes doivent être remplies :

  + Le jeton d’ID doit être signé à l’aide de `RS256` (vous pouvez définir cette valeur dans **Dashboard > Applications > Paramètres de l’application > Paramètres avancés > OAuth**).
  + La demande `aud` du jeton d’ID doit identifier l’application et avoir la même valeur que la demande `azp` du jeton d’accès.

## Restrictions

Les jetons d’accès utilisés pour accéder à Management API ne doivent contenir qu’une seule valeur au niveau de la demande `aud`. Si votre jeton contient plus d’une valeur, votre demande au Management API sera rejetée.

## Learn more

* [Migrate to Access Tokens for Account Linking](/docs/troubleshoot/product-lifecycle/past-migrations/link-user-accounts-with-access-tokens-migration)