---
og:description: Describes migration from Legacy namespaced claims to custom claims.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Migration des demandes personnalisées
og:url: https://auth0.com/docs/
permalink: custom-claims-migration
title: Migration des demandes personnalisées
twitter:description: Describes migration from Legacy namespaced claims to custom claims.
twitter:title: Migration des demandes personnalisées
---

À partir du 28 juillet 2022, Auth0 permettra d’ajouter des demandes personnalisées privées, sans espace de nommage, aux jetons d’accès et d’ID. Ces mêmes demandes ont également été ajoutées à la réponse du [point de terminaison `/userinfo`](https://auth0.com/docs/api/authentication#get-user-info). Pour en savoir plus sur les types de demandes JWT, consultez [Demandes de jetons Web JSON](/security/tokens/json-web-tokens/json-web-token-claims).



#### Exemple

Antérieurement, Auth0 autorisait uniquement les demandes avec espace de noms sur les jetons d’accès et d’ID. Grâce à la migration vers les demandes personnalisées, les demandes sans espace de noms peuvent être utilisées sur les jetons d’accès, les jetons d’ID et le point de terminaison `/userinfo` de l’Authentication API Auth0.



## Flux affectés

Tous les flux OpenID Connect (OIDC) pris en charge par Auth0 sont concernés par cette migration. Pour consulter la liste des flux, lisez [Flux d’authentification et d’autorisation](/login/flows).

Les fonctionnalités suivantes sont également affectées :

* [ Connexion native via réseau social](/login/flows)
* [Jetons d’actualisation](/security/tokens/refresh-tokens)

Les fonctionnalités suivantes ne sont concernées que lorsqu’elles sont utilisées conjointement avec les [Règles d'Auth0](/rules) et le mappage d’attributs :

* [Protocole Web Services Federation (WS-Fed)](/protocols/ws-fed-protocol)
* [Module complémentaire d’application Web SAML2](/saml-configuration/saml-sso-integrations/enable-saml2-web-app-addon)

## Restrictions

### Taille maximale du jeton

Auth0 a restreint la charge utile des demandes personnalisées (100 Ko max.). Il est important de s’assurer que la charge utile ne dépasse pas cette limite, sinon la transaction d’authentification échouera et une erreur se produira. Nous vous recommandons de revoir votre utilisation du code d’extensibilité (c’est-à-dire les [Règles](/rules), les [Hooks](/hooks) ou les [Actions](/actions)). Plus particulièrement, vérifiez les charges utiles importantes provenant d’API externes.

Pour éviter que des erreurs se produisent, Auth0 recommande d’utiliser la plus petite charge utile de jeton nécessaire au fonctionnement de votre application. Vous devrez peut-être supprimer toutes les propriétés qui ne sont pas cruciales avant de définir la valeur de la demande personnalisée.



La limite de 100 Ko s’applique aux jetons d’accès et aux jetons d’ID séparément. À titre d’exemple, un jeton d’accès de 100 Ko et un jeton d’ID de 100 Ko peuvent être renvoyés au cours de la même transaction.

#### Exemples







### Demandes restreintes

Auth0 restreindra la personnalisation des demandes utilisées dans les normes OIDC ou OAuth2 ou des demandes à usage interne. Toute tentative de modification de l’une de ces demandes sera ignorée. La transaction n’échouera pas, mais la demande ne sera pas ajoutée aux jetons. Auth0 recommande l’utilisation d’une demande publique, avec espace de noms.



#### Exemple



### Audience de jetons restreints

Auth0 restreindra la création de demandes personnalisées privées, sans espace de noms, sur les jetons d’accès dont l'audience est une API Auth0. Toute tentative de définition d’une demande personnalisée privée, sans espace de nommage, sur un jeton d’accès dont l'audience est une API Auth0 sera ignorée. La transaction n’échouera pas, mais la demande ne sera pas ajoutée à votre jeton. Auth0 recommande de ne pas définir de demandes personnalisées sur les jetons qui doivent être consommés par les API d’Auth0.



L'audience suivante restreint la création de demandes personnalisées privées, sans espacement de noms :

* `https://YOUR_TENANT.auth0.com/api` ou `https://YOUR_TENANT.auth0app.com/api`
* `https://YOUR_TENANT.auth0.com/api/v2` ou `https://YOUR_TENANT.auth0app.com/api/v2`
* `https://YOUR_TENANT.auth0.com/mfa` ou `https://YOUR_TENANT.auth0app.com/mfa`

L’exception à cette restriction est l’audience Auth0 `/userinfo`. Les demandes personnalisées privées, sans espace de nom, sont autorisées pour les audiences suivantes :

* `https://YOUR_TENANT.auth0.com/userinfo`
* `https://YOUR_TENANT.auth0app.com/userinfo`

#### Exemples



L’exemple ci-dessous vous montre la réponse renvoyée avec des demandes personnalisées si l’audience n’est pas une API Auth0 :





L’exemple ci-dessous vous montre la réponse renvoyée avec des demandes personnalisées qui n’ont pas été ajoutées avec une audience de l’API Auth0 :





## Restriction sur les espaces de noms Auth0 et Webtask

Auth0 restreindra la création de demandes personnalisées avec espace de nommage comportant un domaine Auth0 comme identifiant d’espace de nommage. Les domaines Auth0 sont :

* auth0.com
* webtask.io
* webtask.run

Auth0 restreindra la création de demandes personnalisées avec espace de nommage comportant un domaine Auth0 comme identifiant d’espace de nommage. Les domaines Auth0 sont :





### Demandes de profil utilisateur OIDC

Auth0 permet désormais d’ajouter aux jetons d’accès des demandes de profil utilisateur OIDC.

Auth0 permet désormais d’ajouter aux jetons d’accès des demandes de profil utilisateur OIDC.



Vous pouvez ajouter les demandes de profil d’utilisateur OIDC suivantes aux jetons d’accès :



#### Exemple



### Module complémentaire SAML2 et protocole Web Service Federation (WS-Fed) avec règles d'Auth0

De la même manière que les règles Auth0 permettent de modifier l’objet utilisateur, les demandes de pré-migration`app_metadata` ou `user_metadata` fusionnent également le contenu lorsque la demande est définie sur l’objet `context.idToken` et que les noms sont en conflit. Pour en savoir plus sur les propriétés de l’objet, consultez [Propriétés de l’objet utilisateur dans les règles](https://auth0.com/docs/customize/rules/user-object-in-rules).

Cependant, en utilisant des demandes personnalisées, Auth0 privilégie la demande qui a été définie sur l’`objet context.idToken`.

Ce changement a un impact sur les règles d'Auth0 qui définissent `app_metadata` et `user_metadata` via `context.id_token` (en leur assignant des objets) et qui, en même temps, utilisent ces champs dans le mappage d’attributs pour le module complémentaire SAML ou le protocole Web Service Federation (WS-Fed).

Exemple 1 : Auth0 ignore le mappage d’attributs lorsque `context.idToken.app_metadata` est défini avec un objet vide.



Réponse SAML avant la migration :



Réponse SAML avec le comportement mis à jour :



Exemple 2 : La version avec `app_metadata` dans `context.id_token` est prioritaire.



Réponse SAML avant la migration :



Réponse SAML avec le comportement mis à jour :



### Ajouter des demandes privées, sans espace de noms, aux jetons



Vous pouvez désormais ajouter des demandes personnalisées privées, sans espace de noms, à la charge utile des jetons d’accès et d’ID.

#### Exemple



### Demandes privées, sans espace de noms, vers /userinfo

Auth0 renvoie désormais des demandes personnalisées privées, sans espace de noms, dans la réponse /userinfo lorsqu’elles sont définies sur des jetons d’ID.

#### Exemple







## Actions

### Examiner les journaux de locataires

Vérifiez d’abord les avis de dépréciation dans les journaux de vos locataires afin de déterminer si votre locataire est concerné par la migration.

1. Naviguez vers [Auth0 Dashboard > Surveillance > Journaux](https://manage.auth0.com/#/logs).
2. Recherchez dans les journaux `type: depnote AND description: *Custom*claims*`.

### Exemple

Vérifiez d’abord les avis de dépréciation dans les journaux de vos locataires afin de déterminer si votre locataire est concerné par la migration.



### Correction des règles d'Auth0 pour le module complémentaire SAML2 et le protocole Web Service Federation (Ws-Fed)

Si vous définissez des demandes `app_metadata` ou `user_metadata` sur l’objet `context.idToken` en utilisant le module complémentaire SAML2 ou le protocole Web Service Federation (Ws-Fed) avec les règles d'Auth0 ainsi que le mappage d’attributs, vous devrez mettre à jour votre configuration pour ajuster la façon dont Auth0 évalue les conflits de noms de demandes entre ces objets. Plusieurs solutions sont possibles :

* Assurez-vous que le code de votre règle Auth0 privilégie toujours le contenu des objets définis sur `context.id_token` :
* Si vous utilisez le module complémentaire SAML2 ou le mappage d’attributs du protocole Ws-Fed (Web Service Federation Protocol), évitez de définir des demandes `app_metadata` ou `user_metadata` sur l’objet `context.idToken`. Remplacez ces demandes par des demandes avec espace de nom lorsque c’est possible :
* Utilisez une condition sur le protocole actuel ou sur le client actuel pour exclure les déclarations définissant `app_metadata` ou `user_metadata` lorsque le protocole est `samlp` ou `wsfed`.

### Désactiver le comportement hérité





1. Naviguez vers [Auth0 Dashboard > Paramètres du locataire > Avancé](https://manage.auth0.com/dashboard/#/tenant/advanced) et recherchez **Migrations**.
2. Utilisez la case à cocher pour désactiver l’option **les demandes personnalisées doivent avoir un espace de nommage**.