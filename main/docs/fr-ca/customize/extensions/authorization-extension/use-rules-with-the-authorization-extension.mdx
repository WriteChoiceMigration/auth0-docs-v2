---
og:description: Describes how to use information from the Authorization Extension
  in rules.
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Règles d’utilisation avec Authorization Extension
og:url: https://auth0.com/docs/
permalink: use-rules-with-the-authorization-extension
title: Règles d’utilisation avec Authorization Extension
twitter:description: Describes how to use information from the Authorization Extension
  in rules.
twitter:title: Règles d’utilisation avec Authorization Extension
---

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

Auth0 provides two ways to implement role-based access control (RBAC), which you can use in place of or in combination with your API's own internal access control system:

* [Authorization Core](/docs/manage-users/access-control/rbac)
* [Authorization Extension](/docs/customize/extensions/authorization-extension)

The Authorization Core feature set matches the functionality of the Authorization Extension, improves performance and scalability, and provides a more flexible RBAC system than the Authorization Extension.

Currently, both implement the key features of RBAC and allow you to restrict the custom scopes defined for an API to those that have been assigned to the user as permissions.

</Callout>

Vous pouvez utiliser les règles d'Auth0 avec Authorization Extension pour faire des choses comme :

* Ajouter des demandes personnalisées au jeton émis.
* Déterminer l’appartenance de l’utilisateur à un groupe, ses rôles et ses autorisations.
* Stocker les informations sur les groupes, les rôles et les autorisations de l’utilisateur dans `app_metadata`.
* Ajouter les groupes, rôles et permissions de l’utilisateur au jeton sortant (qui peut être demandé via la permission `openid groups permissions roles`).

Comme la logique ci-dessus fait partie d’une règle, elle ne sera exécutée que dans le contexte d’une connexion. Si des utilisateurs sont ajoutés à un groupe ou en sont retirés, ce changement ne sera reflété dans Auth0 qu’après la prochaine connexion de l’utilisateur.

To learn more, read [Auth0 Rules](/docs/customize/rules).

## Ajouter des demandes personnalisées au jeton émis

Vous pouvez ajouter des demandes personnalisées à vos jetons en créant une règle supplémentaire qui autorise Authorization Extension à le faire. Les demandes personnalisées peuvent être à espacement de noms ou non.

To learn more, read [Create Custom Claims.](/docs/secure/tokens/json-web-tokens/create-custom-claims)

Vous devez limiter le nombre de demandes que vous ajoutez au jeton.

```javascript lines
function (user, context, callback) {
  var namespace = 'http://yourdomain/claims/'; // You can set your own namespace, but do not use an Auth0 domain

  // Add the namespaced tokens. Remove any which is not necessary for your scenario
  context.idToken[namespace + "permissions"] = user.permissions;
  context.idToken[namespace + "groups"] = user.groups;
  context.idToken[namespace + "roles"] = user.roles;
  
  callback(null, user, context);
}
```






Cette règle doit être exécutée **après** la règle d’Authorization Extension. Pour vous en assurer, veillez à la placer en dessous de la règle d’Authorization Extension.

Lorsque vous appelez le point de terminaison `/authorize` ou que vous configurez Lock, vous devez préciser les informations que vous souhaitez dans `scope` en indiquant `groups`, `permissions` et/ou `roles`.

## Contrôler l’accès aux applications

Vous pouvez également écrire des règles qui sont exécutées après la règle d’Authorization Extension pour faire des choses comme contrôler l’accès à votre application. L’une des méthodes consiste à indiquer les rôles requis pour chaque application à l’aide des métadonnées de l’application.

For more details, review [Manage Metadata with Rules](/docs/manage-users/user-accounts/metadata/manage-metadata-rules).

### Définir les rôles requis pour les métadonnées de l’application

Vous pouvez définir les métadonnées de l’application avec des rôles, qui sont des groupes d’autorisations que vous regroupez pour créer un ensemble particulier de fonctionnalités. Vous pouvez considérer cette étape comme un « étiquetage » de l’application, de sorte que les règles que vous définissez sachent sur quelle application agir.

1. ⁠⁠⁠⁠To set the `context.clientMetadata` field with `required_roles`, select the application you want to work at [Auth0 Dashboard > Applications > Applications](https://manage.auth0.com/#/applications).
   Vous accédez ainsi aux **Paramètres** de l’application. Faites défiler vers le bas et sélectionnez **Afficher les paramètres avancés** au bas de la page.
2. Under **Application Metadata** add an item setting the **Key** to `required_roles` and in **Value** field list your roles in comma separated style. Select **+ Add** to add the field.
3. When finished, select **Save Changes**. Now, when you log in from this application, in `context.clientMetadata`, you will have the `required_roles` with the roles value string you entered.

### Créer une règle appliquant les rôles des applications

Maintenant que chaque application a un rôle qui lui est associé, vous pouvez créer la règle qui s’exécute avec cet élément d’information sur l’application dans le contexte.

1. Before creating this rule, enable **Roles** under the **Token Contents** and publish the Authorization Extension rule.
2. Add this rule and make sure it is listed after the generated "auth0-authorization-extension" rule.
3. After setting `required_roles`, create a new [rule](https://manage.auth0.com/#/rules) with the following body:

   ```javascript lines
   function (user, context, callback) {
     context.clientMetadata = context.clientMetadata || {};
     if (context.clientMetadata.required_roles && context.clientMetadata.required_roles.length){
       if (user.roles) {
         var _ = require('lodash');
         var roles = context.clientMetadata.required_roles.split(',');
         var matchingRoles =_.filter(user.roles, function(roleName) {
           return _.includes(roles, roleName);
         });

         if (matchingRoles && matchingRoles.length) {
           return callback(null, user, context);
         }
       }

       return callback(new UnauthorizedError('You do not have the required role to access ' + context.clientName));
     }

    callback(null, user, context);
   }
   ```


   

   

## Learn more

* [Import and Export Authorization Extension Data](/docs/customize/extensions/authorization-extension/import-and-export-authorization-extension-data)
* [Enable API Access to Authorization Extension](/docs/customize/extensions/authorization-extension/enable-api-access-to-authorization-extension)
* [Troubleshoot Authorization Extension](/docs/troubleshoot/authentication-issues/troubleshoot-authorization-extension)