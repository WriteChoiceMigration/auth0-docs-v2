---
og:description: Step 2 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Tutoriel Passerelle API AWS - Étape 2
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-2
title: Tutoriel Passerelle API AWS - Étape 2
twitter:description: Step 2 of Amazon API Gateway Tutorial
twitter:title: Tutoriel Passerelle API AWS - Étape 2
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## Étape 2 - Sécuriser et déployer la Passerelle API Amazon

Maintenant que votre API fonctionne, vous devez ajouter un niveau de sécurité. Au cours de cette étape, vous allez :

* Sécurisez l’API de mise à jour pour limiter l’accès aux utilisateurs authentifiés ayant un rôle IAM AWS spécifique;
* Configurez la délégation Auth0 pour utiliser les fonctionnalités de la fédération IAM AWS;
* Obtain an AWS <Tooltip tip="Access Token: Authorization credential, in the form of an opaque string or JWT, used to access an API." cta="View Glossary" href="/docs/glossary?term=Access+Token">Access Token</Tooltip> that uses the AWS IAM role.

Once your API is secure, you'll build a serverless, single-page application (SPA). The SPA will rely on federating identity to determine which users are allowed access. By combining AWS IAM Integration for AWS Gateway API, AWS IAM Identity Federation for <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=SAML">SAML</Tooltip>, and Auth0 Delegation for AWS, you can enable users from many different sources, including Social Providers or enterprise connections, to access your APIs. The following diagram illustrates a sample flow using a SAML-based <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=Identity+Provider">Identity Provider</Tooltip> and Auth0 SAML Federation and Delegation for AWS.

Il existe deux façons de mettre en œuvre ce flux :

1. Using Auth0 Delegation with AWS IAM;
2. Adding an identity token to flow identity to the Lambda function.

La délégation facilite l’obtention des jetons à partir de AWS pour accéder à tous les services d’AWS dans votre application.

### Procédures de sécurisation de la Passerelle API Amazon

La Passerelle API AWS offre différentes méthodes pour sécuriser vos API :

1. API keys;
2. IAM;
3. [Amazon Cognito](/docs/customize/integrations/aws/aws-api-gateway-cognito).

L’utilisation de clés API est généralement appropriée pour une interaction entre services, comme illustré ci-dessous. Cependant, cette approche présente plusieurs inconvénients :

* L’attribution d’un secret de longue durée sur l’application est risquée (cette dernière est plus facile à compromettre);
* La création d’un cadre d’applications pour émettre et gérer des clés API nécessite une mise en œuvre sécurisée parfois complexe.

This section of the tutorial will utilize IAM roles and policies to secure your API in API Gateway, but you can also choose to do so using user pools in Amazon Cognito. To review detailed instructions on securing your AWS API, read [Secure AWS API Gateway Using Cognito](/docs/customize/integrations/aws/aws-api-gateway-cognito). For more information on using IAM roles and policies, read the Amazon article, [Control access to an API with IAM permissions](http://docs.aws.amazon.com/apigateway/latest/developerguide/permissions.html). To read more about user pools in Cognito, visit [Amazon Cognit user pool](http://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html).

### Step 1. Configuration d’IAM et d’Auth0 pour intégrer SAML avec la Passerelle API

Vous pouvez spécifier le rôle IAM AWS pour le jeton SAML que vous échangez contre un jeton AWS. Le jeton reçu bénéficie des mêmes autorisations que celles attribuées au rôle IAM en question (qui sont définies par votre fournisseur d’identité). En émettant différents jetons SAML, chacun avec son propre rôle IAM AWS, vous pouvez contrôler les niveaux d’accès de vos utilisateurs.

Par exemple, le fournisseur d’identité peut indiquer le rôle IAM en fonction de l’appartenance à un groupe (p.ex. : un administrateur dans Active Directory) ou de la source d’authentification (p.ex. : une connexion à une base de données ou un fournisseur social comme Facebook). Cette approche vous permet de différencier les autorisations d’accès des utilisateurs à vos méthodes de Passerelle API Amazon lorsque ces dernières sont sécurisées à l’aide d’IAM AWS.

#### Configuration d’Auth0

Connectez-vous à votre compte Auth0. Vous accéderez au Management Dashboard. Cliquez sur le bouton **+ Nouvelle application**, situé dans le coin supérieur droit de la page.

Nommez votre nouvelle application Passerelle API AWS, et indiquez qu’il s’agira d’une application à page unique. Cliquez sur **Créer**.

Accédez à l’onglet modules complémentaires de l’application que vous venez de créer. Cliquez sur la diapositive appropriée pour activer Amazon Web Services. Cela active la délégation AWS.

#### Configurer AWS

Follow the [How to Set Up AWS for Delegated Authentication](/docs/customize/integrations/aws/how-to-set-up-aws-for-delegated-authentication) tutorial to configure AWS for delegated access, which uses SAML. Some caveats:

* Suivez [les instructions ci-dessous](#setting-the-permissions-policy-on-your-iws-iam-role) pour associer la politique de permissions à votre rôle et non à celui indiqué dans le tutoriel ;
* Nommez le fournisseur SAML que vous avez créé comme suit : `auth0`;
* Nommez le rôle IAM AWS comme suit : `auth0-api-role`.

##### Définissez la politique d’autorisation en fonction de votre rôle IAM AWS.

Once you have configured the AWS IAM role, you will add a policy to `auth0-api-role` that lets you execute your API Gateway methods. For more information on this process, please see [User Access Permissions for Amazon API Gateway](http://docs.aws.amazon.com/apigateway/latest/developerguide/permissions.html).

#### Récupération de l’ARN de la Passerelle API.

Avant de commencer, vous aurez besoin de l’ARN de votre Passerelle API :

1. Navigate to [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway) and log in.
2. Select the appropriate API.
3. Click on any of the Methods associated with the API to bring up the Method Execution page.
4. On the Method Execution page, the Method Request box in the top left corner displays the **ARN** for the API, though it includes the Method name:

`arn:aws:execute-api:us-east-2:484857107747:97i1dwv0j4/*/POST/`

Vous devez supprimer le nom de la méthode pour obtenir l’ARN de base de l’API :

`arn:aws:execute-api:us-east-2:484857107747:97i1dwv0j4/*`

Le caractère de remplacement (`*`) dans l’ARN ci-dessus permet d’autoriser l’accès à votre API à toutes les étapes, mais vous pouvez déployer les différentes étapes individuellement (par exemple, la phase de développement d’abord, puis de test, et de production).

Sélectionnez le rôle `auth0-api-role` que vous venez de créer pour ouvrir la page Résumé qui lui est associée.

Agrandissez la section **Politiques en ligne** et cliquez sur **cliquer ici**.

Sélectionnez **Politique personnalisée** et cliquez sur **Sélectionner**.

Modifiez le document de politique. Vous pouvez définir le **Nom de la politique** à ce que vous voulez, mais nous suggérons quelque chose comme `api-gateway-policy`. Pour autoriser l’accès aux méthodes de l’API pour le rôle en question, appliquez cette politique après avoir mis à jour l’ARN avec celui de votre API.

```json lines
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "execute-api:*"
            ],
            "Resource": [
                "arn:[{yourArn}]"
            ]
        }
    ]
}
```






Cliquez sur **Appliquer la politique**.

Étant donné que la Passerelle de l’API assumera ce rôle au nom de l’utilisateur, la politique de confiance doit autoriser cette action. Pour ce faire, modifiez les Relations de confiance du rôle en accédant à l’onglet correspondant sur la page Résumé.

La relation de confiance finale devrait ressembler à celle illustrée ci-dessous :

```json lines expandable
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "auth0",
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::012345670:saml-provider/auth0-api"
      },
      "Action": "sts:AssumeRoleWithSAML",
      "Condition": {
        "StringEquals": {
          "SAML:iss": "urn:{yourDomain}"
        }
      }
    },
    {
      "Sid": "gateway",
      "Effect": "Allow",
      "Principal": {
        "Service": "apigateway.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```






At this point, you will need to set the Authorization Settings on the [API Gateway](https://console.aws.amazon.com/apigateway).

Dans la fenêtre **Ressources**, sélectionnez la méthode POST sous `/pets`.

Cliquez sur le lien **Requête de méthode**.

Cliquez sur l’icône de modification à côté du **Authorization Type ** (Type d’autorisation), et sélectionnez AWS_IAM. Cliquez maintenant sur le bouton **Check** (Vérifier) à côté du champ pour enregistrer ce paramètre.

### Step 2. Configuration du partage des ressources inter-origines (CORS) et déploiement de l’API

Notre application à page unique (SPA) accédera aux méthodes de l’API web à partir d’un domaine différent de celui de la page. La configuration du partage des ressources inter-origines doit explicitement autoriser cette action pour que le navigateur permette l’accès à la Passerelle API AWS. En règle générale, le navigateur envoie d’abord une requête `OPTIONS` pour voir quelles sont les actions autorisées par le site.

Sélectionnez `/pets` sous Ressources et cliquez sur **Créer la méthode**. Dans le menu déroulant, sélectionnez **OPTIONS** et cliquez sur la **coche** pour enregistrer la configuration.

Le navigateur utilise la méthode Options pour obtenir les en-têtes HTTP requis, mais la fonction a besoin d’instructions supplémentaires pour s’exécuter correctement. Sous l’écran de configuration `OPTIONS`, définissez les variables et paramètres suivants :

* **Type d’intégration** : Fonction Lambda;
* **Utiliser l’intégration Proxy Lambda** : ne pas cocher;
* **Région Lambda** : sélectionnez votre région;
* **Fonction Lambda** : NoOp.

Cliquez sur **Enregistrer**. Dans la fenêtre suivante, accordez à votre fonction Lambda les autorisations dont elle a besoin.

Vous serez alors automatiquement dirigé vers la page `OPTIONS` Méthode d’exécution. Ouvrez la page Réponse de méthode.

Élargissez la section **200** située sous la barre d’état HTTP et ajoutez les en-têtes de réponse suivants :

* Access-Control-Allow-Headers;
* Access-Control-Allow-Methods;
* Access-Control-Allow-Origin.

Ensuite, associez les valeurs appropriées à chacun des en-têtes de réponse. Une fois de retour à la page Exécution de méthode, cliquez sur **Integration Response** (Réponse d’intégration). Après avoir développé la ligne associée à l’état de réponse de la méthode **200**, agrandissez les **Mappages d’en-tête** et appliquez les mappages suivants :

* Access-Control-Allow-Headers : `'Content-Type,X-Amz-Date,Authorization,x-api-key,x-amz-security-token'`;
* Access-Control-Allow-Origin : `'*'`
* Access-Control-Allow-Methods : `'POST, GET, OPTIONS'`

Enfin, répétez les étapes ci-dessus pour activer le partage des ressources inter-origines pour les méthodes POST et GET. Toutefois, pour ces deux méthodes, vous ajouterez l’en-tête Access-Control-Allow-Origin, dont la valeur doit être fixée à `'*'`.

### Déployer l’API

Retournez sur la page **Ressources** de votre API. Cliquez sur **Actions**, et sélectionnez **DÉPLOYER L’API**.

Sélectionnez **New Stage** (Nouvelle étape) pour l’état de déploiement et nommez l’étape `Test`. Cliquez sur le bouton **Deploy** (Déployer).

Sur la page des résultats, allez à la section **Génération d’une trousse SDK**. Sélectionnez JavaScript en tant que **Plateforme**. Cliquez sur le bouton **Générer trousse SDK**.

Enregistrez le fichier zip téléchargé pour une utilisation ultérieure.