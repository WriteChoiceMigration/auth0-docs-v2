---
og:description: Step 4 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Tutoriel AWS API Gateway - Étape 4
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-4
title: Tutoriel AWS API Gateway - Étape 4
twitter:description: Step 4 of Amazon API Gateway Tutorial
twitter:title: Tutoriel AWS API Gateway - Étape 4
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## Étape 4 - Utiliser plusieurs rôles avec Amazon API Gateway

Dans cette étape, vous attribuerez différents rôles AWS IAM aux utilisateurs en fonction des informations d’authentification :

* Les utilisateurs s’authentifiant avec connexions sociales seront traités comme des acheteurs;
* Les utilisateurs s’authentifiant avec les connexions de la base de données seront traités comme des administrateurs.

Vous exécuterez cette logique d’attribution de rôle de deux manières différentes :

* JavaScript;
* Règles d'Auth0

Pour de nombreuses applications Auth0, vous aurez besoin d’accorder à différents utilisateurs des niveaux d’accès distincts et de disposer d’informations supplémentaires concernant une identité spécifique à utiliser dans votre logique de service. Dans les situations où il s’agit simplement de restreindre l’accès au niveau de l’API, différents rôles AWS IAM peuvent être mis en œuvre (par exemple, les administrateurs peuvent utiliser la fonction de mise à jour pour ajouter ou supprimer des animaux de compagnie, tandis que les utilisateurs sociaux ne peuvent que les acheter).

Le diagramme ci-dessous présente les attributions de rôles AWS IAM pour deux catégories distinctes d’utilisateurs : ceux authentifiés via les connexions sociales et ceux authentifiés via les connexions de base de données. Il démontre également que les rôles AWS IAM peuvent être affectés à d’autres entités, telles que les fonctions AWS Lambda, afin de gérer les permissions qui leur sont accordées pour compte particulier. En résumé, un rôle IAM représente un ensemble d’autorisations sur les services AWS, défini par une ou plusieurs politiques, puis assigné à une entité.

For cases where you want to make decisions within your code (for example, you might want a credit check of a user buying a pet), you will want to flow identity as well. This will be demonstrated below in [Step 5 - Using Identity Tokens to Flow Identity](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-5).

### Step 1. Créer la ressource API PetPurchase

Using the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), select your Pets API. You will be taken to its Resources page.

Cliquez sur **Actions** et **Créer une ressource**. Nommez la nouvelle ressource enfant `Purchase`. Cliquez sur **Créer une ressource**.

Add an OPTIONS method for the `purchase` resource as outlined previously for `pets` in the [Set Up Cors and Déployer l’API section of Step 2 - Securing and Deploying the Amazon API Gateway](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api).

Créez une nouvelle fonction AWS Lambda pour l’achat d’un animal de compagnie appelé `PetPurchase`, ce qui ajoute les attributs `isSold` et `soldTo` à un animal de compagnie comme suit :

```javascript lines expandable
var AWS = require('aws-sdk');
var DOC = require('dynamodb-doc');
var dynamo = new DOC.DynamoDB();

exports.handler = function(event, context) {
   var petId = event.petId;
   var user = event.userName;
   var pets = {};
   console.log('start PetsPurchase, petId', petId, ' userName', user);

   var writecb = function(err, data) {
      if(!err) {
          context.done(null, pets);
      } else {
          console.log('error on GetPetsInfo: ',err);
          context.done('failed on update', null);
      }
   };

   var readcb = function(err, data) {
      if(err) {
          console.log('error on GetPetsInfo: ',err);
          context.done('failed to retrieve pet information', null);
      } else {
          // make sure we have pets
          if(data.Item && data.Item.pets) {
              pets = data.Item.pets;
              var found = false;

              for(var i = 0; i < pets.length && !found; i++) {
                  if(pets[i].id === petId) {
                     if(!pets[i].isSold) {
                        pets[i].isSold = true;
                        pets[i].soldTo = user;
                        var item = { username:"default",pets: pets};
                        dynamo.putItem({TableName:"Pets", Item:item}, writecb);
                        found = true;
                     }
                  }
               }
               if(!found) {
                 console.log('pet not found');
                 context.done('That pet is not available.', null);
               }
           } else {
              console.log('pet already sold');
              context.done('That pet is not available.', null);
           }
       }
   };

   dynamo.getItem({TableName:"Pets", Key:{username:"default"}}, readcb);
};
```






Once you have defined the Lambda function, [add a POST method to the `purchase` resource](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-1#method-post-pet-information) that calls the `PetPurchase` Lambda. Be sure to also add the `Access-Control-Allow-Origin` header with a value of `*` to the POST method using the method response/integration response configuration found in [Set Up Cors and Déployer l’API section of Step 2 - Securing and Deploying the Amazon API Gateway](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api).

Testez la méthode de passerelle API en fournissant les éléments suivants comme message d’entrée :

```json lines
{
    "petId": 1,
    "userName": "fred flintstone"
 }
```






Dans la réponse du test, vous devriez voir que l’animal de compagnie avec l’ID 1 est maintenant vendu à Fred Flintstone :

```json lines
[
  {
    "id": 1,
    "price": 249.99,
    "type": "dog",
    "isSold": true,
    "soldTo": "fred flintstone"
  },

  ...
```






### Step 2. Utilisez IAM pour sécuriser l’API PurchasePet

#### Mettre à jour IAM

To secure your API, follow the same process for adding a new role that you [performed in Part 2](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2) of this tutorial. Call the new role `auth0-api-social-role`.

L’ARN de la méthode que vous sécuriserez dans la politique IAM devrait ressembler à ceci :

```bash wrap lines
arn:aws:execute-api:us-east-1:your-accountid:your-api-id/*/pets/purchase
```






Assurez-vous également de mettre à jour la politique de confiance.

Go to the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), and select the POST method for the `/pets/purchase` resource. Select **Method Request** and change **Authorization Type** to AWS_IAM. Click the check to save the setting.

À ce stade, vous avez défini deux rôles que vous pouvez utiliser avec la passerelle API :

* `auth0-api-role` : permet de mettre à jour les animaux de compagnie
* `auth0-api-social-role` : permet d’acheter un animal de compagnie

#### Configurer la Connexion avec Amazon et mettre à jour Auth0

Vous pouvez créer un rôle social en utilisant la Connexion avec Amazon (LWA).

Bien que ce didacticiel inclue des instructions sur l’utilisation de la Connexion avec Amazon, veuillez noter que vous pouvez également utiliser d’autres fournisseurs sociaux.

1. Navigate to [Auth0 Dashboard > Authentication > Social](https://manage.auth0.com/#/connections/social), and select **Create Connection**.
2. Choose the connection you want to set up, and consent.
3. Copy and paste the `Client ID` and `Client Secret` from your social identity provider, select the **Attributes** (and **Permissions**, where applicable), and click **Save**.
4. Select the **Applications** view, enable the switch for each of your Auth0 applications that should be able to use this connection, and select **Save**.

Une fois que vous avez saisi les informations appropriées, sélectionnez **Essayer la connexion** pour vous assurer que tout est correctement configuré.

When you configure LWA using the Amazon console, be sure to enter into Allowed Return URLs the callback URL to your Auth0 Application, which should look something like `https://johndoe.auth0.com/login/callback`. The Auth0 help page will show you specifically what to enter.

Navigate to [Auth0 Dashboard > Applications > Applications](https://manage.auth0.com/#/applications), and select your Application to view its settings. Select the **Connections** view, locate the **Social** section, and ensure that **Amazon** is enabled.

#### Déployer l’API et mettre à jour l’application à une seule page

##### Déployer l’API

Using the [Amazon API Gateway Console](https://console.aws.amazon.com/apigateway), you will again [deploy the API and generate a new JavaScript SDK](/docs/customize/integrations/aws/aws-api-gateway-delegation/aws-api-gateway-delegation-2#set-up-cors-and-deploy-the-api).

À ce stade, vous avez effectué les modifications de configuration nécessaires pour permettre les achats d’animaux de compagnie. Pour activer cette mise à jour, copiez votre trousse SDK nouvellement téléchargée sur le précédent dans votre dossier `pets`, ainsi que votre bucket Amazon S3.

##### Mettez à jour la logique du contrôleur de connexion afin de choisir des rôles différents pour chaque type d’utilisateur.

La logique du contrôleur de connexion utilise `getOptionsForRole` pour sélectionner différents rôles pour différents utilisateurs. Lorsque vous obtenez le jeton de délégation, vous pouvez indiquer à Auth0 quel rôle utiliser (c’est-à-dire, l’utilisateur est un administrateur ou non).

Dans le fichier `pets/login/login.js`, modifier les valeurs de `role` et de `principal` pour l’utilisateur non-administrateur afin d’attribuer le rôle IAM de l’utilisateur social que vous venez de créer.

À ce stade, vous devriez être en mesure de vous connecter en utilisant les identifiants Amazon **ou** ceux de l’utilisateur de base de données que vous avez créés précédemment. Veuillez noter que l’interface utilisateur autorise un utilisateur social à acheter des animaux de compagnie, tandis qu’un utilisateur administrateur peut en ajouter ou en supprimer.

Pour tester cette fonctionnalité, vous pouvez masquer temporairement la touche Supprimer dans l’interface utilisateur en supprimant `ng-show="isAdmin"` dans `/pets/home/home.html` :

```html wrap lines
<button ng-show="isAdmin" class="btn delete-btn" ng-click="removePet(pet.id)">remove</button>
```






Après avoir transféré les modifications dans votre bucket S3, tentez de supprimer un animal de compagnie tout en étant connecté en tant qu’utilisateur social.

##### Mettez à jour la logique du contrôleur principal pour permettre aux utilisateurs sociaux d’acheter des animaux de compagnie.

Dans `home.js`, modifiez la fonction `buyPet` pour activer les achats d’animaux de compagnie :

```javascript lines
function buyPet(user, id) {
    var apigClient = getSecureApiClient();

    apigClient.petsPurchasePost({},{userName:user, petId:id})
      .then(function(response) {
        console.log(response);
        $scope.pets = response.data;
        $scope.$apply();
      }).catch(function (response) {
        alert('buy pets failed');
        showError(response);
    });
}
…
```






Copiez le code dans votre bucket S3, déconnectez-vous, puis reconnectez-vous en tant qu’utilisateur social en cliquant sur l’icône Amazon dans la boîte de dialogue Lock login. Vous devrez peut-être avoir besoin de cliquer sur **AFFICHER TOUT**, si votre connexion précédente persiste dans le volet Lock.

Veuillez noter qu’en tant qu’utilisateur Amazon, vous êtes autorisé à acheter un animal de compagnie, mais vous ne pouvez ni en ajouter ni en supprimer. En revanche, si vous vous connectez en tant qu’utilisateur via une connexion à la base de données, vous pouvez ajouter et supprimer des animaux de compagnie, mais vous ne pouvez pas en acheter.

### Appliquer l’attribution des rôles avec les règles d'Auth0

Dans certains cas, vous pouvez définir le rôle approprié à l’aide de l’application (comme illustré ici). Cependant, pour des raisons de sécurité, par exemple, afin d’éviter qu’un utilisateur n’assume un rôle plus privilégié que nécessaire, il peut être préférable de déterminer les privilèges de l’utilisateur côté serveur.

Avec Auth0, cela est possible grâce aux règles, qui sont des instructions logiques que vous configurez et qui s’exécutent durant le processus d’authentification Auth0. Par exemple, vous pouvez créer des règles pour :

* éliminer la transmission des informations de rôle du navigateur à l’application;
* insérez les informations de rôle dans la demande de délégation en fonction de la source d’authentification.

#### Appliquer l’affectation de rôles

Vous ajouterez une règle qui vérifiera si le rôle demandé par l’utilisateur est autorisé, en fonction de son association avec une connexion sociale ou de base de données.

1. Navigate to [Auth0 Dashboard > Auth Pipeline > Rules](https://manage.auth0.com/#/rules), and select **Create Rule**.
2. Choose the **Empty rule** template
3. Name the rule **AWS Pets** (or something similar), then populate the body of the rule with the following JavaScript code:

   ```javascript lines expandable
   function (user, context, callback) {
     if(context.clientID === '{yourClientId}') {
       var socialRoleInfo = {
         role:"arn:aws:iam::<your account>:role/auth0-api-social-role",
         principal: "arn:aws:iam::your account>:saml-provider/auth0"
       };

       var adminRoleInfo = {
         role:"arn:aws:iam::<your account>:role/auth0-api-role",
         principal: "arn:aws:iam::<your account>:saml-provider/auth0"
       };

       var requestRole = context.request.body.role;
       var requestPrincipal = context.request.body.principal;
       var allowedRole = null;

       if(user.identities[0].isSocial === false) {
         allowedRole = adminRoleInfo;
       } else {
         allowedRole = socialRoleInfo;
       }

       if((requestRole && requestRole !== allowedRole.role) ||
          (requestPrincipal && requestPrincipal !== allowedRole.principal)) {
           console.log('mismatch in requested role:',requestRole, ':', requestPrincipal);
           console.log('overridding');
       } else {
         console.log('valid or no role requested for delegation');
       }

       context.addonConfiguration = context.addonConfiguration || {};
       context.addonConfiguration.aws = context.addonConfiguration.aws || {};
       context.addonConfiguration.aws.role = allowedRole.role;
       context.addonConfiguration.aws.principal = allowedRole.principal;
       callback(null, user, context);

     } else {
       callback(null, user, context);
     }
   }
   ```


   

   

   Assurez-vous d’ajuster le code ci-dessus avec les valeurs correctes pour votre intégration. Les champs sont **Princial ARN**, **Rôle ARN**, et **Client Secret**.
4. **Save** your changes.

#### Mises en garde

* Les règles s’exécutent à une permission globale pour chaque authentification. Vous ne devez exécuter la logique que sur les demandes d’authentification associées à une application donnée (c’est pourquoi le script utilisé demande le clientID). En l’absence de ces informations, la logique s’exécute à chaque demande d’authentification associée à votre compte Auth0.
* Les informations sont transmises à la règle, accompagnées du contexte et de l’utilisateur.
* Vous pouvez étendre les objets transmis à la règle. Dans le code ci-dessus, la règle examine le corps de la demande pour extraire les informations relatives aux rôles. Le rôle est défini dans le contexte addonConfiguration du rôle autorisé, qui remplace toujours les paramètres dans le corps de la demande.

#### Déboguer votre règle

Vous êtes prêt à déboguer votre/vos règle(s). Sélectionnez **Essayez cette règle**, et un script vous sera présenté pour tester la logique de la règle Sélectionner **Essayer**.

Vous verrez alors le résultat de l’exécution de votre règle.