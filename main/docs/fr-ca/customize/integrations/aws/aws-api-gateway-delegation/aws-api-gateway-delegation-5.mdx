---
og:description: Step 5 of Amazon API Gateway Tutorial
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Tutoriel AWS API Gateway - Étape 5
og:url: https://auth0.com/docs/
permalink: aws-api-gateway-delegation-5
title: Tutoriel AWS API Gateway - Étape 5
twitter:description: Step 5 of Amazon API Gateway Tutorial
twitter:title: Tutoriel AWS API Gateway - Étape 5
---

<Warning>

This feature uses delegation. By default, delegation is disabled for tenants without an add-on in use as of 8 June 2017. Legacy tenants who currently use an add-on that requires delegation may continue to use this feature. If delegation functionality is changed or removed from service at some point, customers who currently use it will be notified beforehand and given ample time to migrate. In addition, note that delegation does not support the use of custom domains so any features depending on it may not be fully functional alongside a custom domain.

</Warning>

## Étape 6 - Utilisation des jetons d’identité pour le flux Identité

Dans cette dernière étape, vous allez :

* Flow identity to the service by passing your <Tooltip tip="OpenID: Open standard for authentication that allows applications to verify users' identities without collecting and storing login information." cta="View Glossary" href="/docs/glossary?term=OpenID">OpenID</Tooltip> <Tooltip tip="OpenID: Open standard for authentication that allows applications to verify users' identities without collecting and storing login information." cta="View Glossary" href="/docs/glossary?term=JSON+Web+Token">JSON Web Token</Tooltip> (JWT);
* Valider le jeton;
* Extraire les informations de profil pour attribuer un acheteur à un animal de compagnie.

## Utilisation d’un jeton d’ID

You can use your Lambda function to process and obtain information about the user. For example, during a purchasing transaction, you retrieved the username from the profile returned with the <Tooltip tip="ID Token: Credential meant for the client itself, rather than for accessing a resource." cta="View Glossary" href="/docs/glossary?term=identity+token">identity token</Tooltip>. However, you can also choose to have the user's information embedded with the identity itself, which is a JSON Web Token (JWT).

L’utilisation des JWT présente l’avantage de pouvoir :

1. Verify the authenticity of the JWT;
2. Be sure that the calling user is authenticated (instead of relying on a plain-text parameter that could have been tampered with).

En outre, vous pouvez utiliser le JWT pour l’autorisation, ce qui vous permet de contourner l’intégration IAM avec Amazon API Gateway. Notez toutefois que l’utilisation de l' API Gateway pour l’autorisation vous permet d’interrompre l’appel API avant l’invocation de votre fonction Lambda.

### Ajout d’informations au JWT

Il existe plusieurs façons d’ajouter les informations d’un utilisateur au JWT. L’exemple suivant ajoute l’adresse courriel de l’utilisateur au JWT, mais les concepts sont les mêmes pour les autres données de l’utilisateur.

#### Règles d’utilisation

One way to add a user's email address to the JWT is to use a [rule](/docs/customize/rules). This is a good approach if you want to make sure that this value is always available in the JWT for an authenticating user.

Dans `login.js`, vous pouvez voir cette permission spécifiée dans les paramètres passés à `auth.signin` :

```js lines
$scope.login = function() {
    var params = {
        authParams: {
          scope: 'openid email'
        }
      };

    auth.signin(params, function(profile, token) {
      ...
    }
  }
```






Bien que vous puissiez inclure le profil complet de l’utilisateur dans le JWT, vous ne devez inclure que ce qui est nécessaire puisque le JWT est généralement transmis avec chaque requête.

## Validation du jeton JWT

Étant donné que la console AWS Lambda a accès à un nombre limité de modules Node qui peuvent être utilisés lorsque vous entrez votre code Node.js à l’aide de la console du navigateur, vous devrez inclure des modules supplémentaires et téléverser la fonction Lambda en tant que package pour traiter le jeton d’ID.

For additional details, see [Creating Deployment Packages using Node.js](http://docs.aws.amazon.com/lambda/latest/dg/nodejs-create-deployment-pkg.html) and [Uploading Deployment Packages and Testing](http://docs.aws.amazon.com/lambda/latest/dg/walkthrough-s3-events-adminuser-create-test-function-upload-zip-test.html).

Le projet « seed » suivant contient le code dont vous aurez besoin pour votre fonction AWS Lambda mise à jour.

```js wrap lines
<%= include('../../../_includes/_package', { org: 'auth0', repo: 'auth0-aws', path: 'examples/api-gateway/lambda' }) %>
```

Vous verrez deux fichiers JavaScript personnalisés dans le projet seed :

* `index.js` : contient votre code principal;
* `auth0-variables` : contient le code que vous devez mettre à jour.

Outre les fichiers personnalisés, il existe un fichier Node.js standard `package.json`.

Le code ajoute une fonctionnalité permettant d’extraire des informations et de valider le JWT. Par défaut, Auth0 utilise une clé symétrique pour signer le JWT, bien que vous puissiez choisir d’utiliser des clés asymétriques (si vous avez besoin d’autoriser la validation de votre jeton par un tiers, vous devriez utiliser une clé asymétrique et ne partager que votre clé publique).

For more information about token verification, see [Identity Protocols Supported by Auth0](/docs/authenticate/protocols).

Update `auth0-variables.js` with your secret key, which can be found on the Settings tab of your Application in the <Tooltip tip="Auth0 Dashboard: Auth0's main product to configure your services." cta="View Glossary" href="/docs/glossary?term=Auth0+Dashboard">Auth0 Dashboard</Tooltip>:

```javascript lines
var env={};
env.AUTH0_SECRET='{yourAuth0Secret}';
module.exports = env;
```


Exécutez **npm install** depuis le répertoire où se trouvent vos fichiers, zippez le contenu (`index.js` doit être à la racine du zip), et téléversez-le pour qu’il soit utilisé par la fonction Lambda `PurchasePet`. Si vous testez, vous devriez voir un échec d’autorisation, puisque le JWT n’est pas dans le corps du message.

Regardez la logique dans `index.js`. Vous verrez la logique autour de la ligne 60 qui valide le jeton et extrait les informations décodées qui contiennent les informations d’identité utilisées pour la logique d’achat :

```js lines
if(event.authToken) {
     jwt.verify(event.authToken, secret, function(err, decoded) {
         if(err) {
           console.log('failed jwt verify: ', err, 'auth: ', event.authToken);
           context.done('authorization failure', null);
         } else if(!decoded.email)
         {
           console.log('err, email missing in jwt', 'jwt: ', decoded);
           context.done('authorization failure', null);
         } else {
           userEmail = decoded.email;
           console.log('authorized, petId', petId, 'userEmail:', userEmail);
           dynamo.getItem({TableName:"Pets", Key:{username:"default"}}, readcb);
         }
     });
  } else {
     console.log('invalid authorization token', event.authToken);
     context.done('authorization failure', null);
  }
    ...
```






### Extraire les informations de profil pour affecter un acheteur

La dernière étape consiste à transmettre le JWT à la méthode utilisée par le navigateur client.

La méthode standard s’accompagne d’un en-tête `Autorisation` en tant que jeton du porteur, et vous pouvez utiliser cette méthode en désactivant l’autorisation IAM et en vous appuyant uniquement sur le jeton OpenID pour l’autorisation (vous devrez également mapper l’en-tête Autorisation dans les données d’événement transmises à la fonction AWS Lambda).

Toutefois, si vous utilisez IAM, la passerelle API AWS utilise l’en-tête `Autorisation` pour contenir la signature du message, et vous interromprez l’authentification en insérant le JWT dans cet en-tête. Pour ce faire, vous pouvez soit

* Ajouter un en-tête personnalisé pour le JWT,
* soit placer l’en-tête personnalisé dans le corps du message.

Si vous choisissez d’utiliser un en-tête personnalisé, vous devrez également effectuer un mappage pour la requête d’intégration de la méthode POST pour `pets/purchase`.

Pour simplifier le processus de validation, transmettez le JWT dans le corps du message à la fonction AWS Lambda. Pour ce faire, mettez à jour la méthode `buyPet` dans `home.js` en supprimant le `userName` du corps et en ajoutant `authToken` comme suit :

```javascript lines
function buyPet(user, id) {
    var apigClient = getSecureApiClient();
    var body = {
      petId:id,
      authToken: store.get('token')
    };

    apigClient.petsPurchasePost({}, body)
      .then(function(response) {
        console.log(response);
        $scope.pets = response.data;
        $scope.$apply();
      }).catch(function (response) {
        alert('buy pets failed');
        showError(response);
    });
}
```


Téléversez votre code dans votre bucket S3 et essayez d’acheter un animal de compagnie. Vous verrez le courriel de l’acheteur dans le message résultant.

If you have any errors, double check that you have properly set your secret key. One useful tool for checking issues with your token decoding is [jwt.io](http://jwt.io/).

## Résumé

Dans ce tutoriel, vous avez réalisé ce qui suit :

* Créé une API à l’aide d’AWS API Gateway qui inclut des méthodes utilisant des fonctions AWS Lamdba.
* Sécurisé l’accès à votre API à l’aide des rôles IAM.
* Integrated a <Tooltip tip="Identity Provider (IdP): Service that stores and manages digital identities." cta="View Glossary" href="/docs/glossary?term=SAML">SAML</Tooltip> <Tooltip tip="Security Assertion Markup Language (SAML): Standardized protocol allowing two parties to exchange authentication information without a password." cta="View Glossary" href="/docs/glossary?term=identity+provider">identity provider</Tooltip> with IAM to tie access to the API to your user base;
* Fourni différents niveaux d’accès selon que l’utilisateur s’authentifie à partir de la base de données ou de la connexion sociale.
* Utilisé une règle Auth0 pour renforcer l’attribution des rôles.
* Utilisé un JWT pour fournir un contexte d’autorisation supplémentaire et transmettre les informations d’identité à la fonction Lambda appropriée.