---
og:description: Troubleshooting invalid state errors in the Login by Auth0 WordPress
  plugin
og:image: https://cdn2.auth0.com/docs/1.14553.0/img/share-image.png
og:title: Dépannage des erreurs d’état non valide des plugins WordPress
og:url: https://auth0.com/docs/
permalink: troubleshoot-wordpress-plugin-invalid-state-errors
title: Dépannage des erreurs d’état non valide des plugins WordPress
twitter:description: Troubleshooting invalid state errors in the Login by Auth0 WordPress
  plugin
twitter:title: Dépannage des erreurs d’état non valide des plugins WordPress
---

We added state validation to WordPress plugin version 3.6.0, which you can find in the [wp-auth0 GitHub repository](https://github.com/auth0/wp-auth0/releases/tag/3.6.0). This security measure helps mitigate CSRF attacks by ensuring that the response belongs to a request initiated by the same user To learn more, read [Prevent Attacks and Redirect Users with OAuth 2.0 State Parameter](/docs/secure/attack-protection/state-parameters).

## Fonctionnement de la validation des états

Le plugin effectue la validation d’état en :

1. Setting an `auth0_state` cookie in the browser via Javascript when the Lock login form is shown (on `wp-login.php` or any other page when using a shortcode or widget).
2. Passing that value to the Lock embedded login form so it can be sent with the authentication request.
3. Receiving that value back from Auth0 unchanged in a `state` URL parameter if the Auth0 login was successful.
4. Validating the that value received matches the value sent and stored in the `auth0_state` cookie. If it's valid, then the login process continues. If not, the process stops and an "Invalid state" error message is shown.
5. Deleting the cookie, regardless of validity.
6. Using values in the base64 decoded object to redirect or perform other login actions, if valid.

Ce processus doit être totalement opaque pour l’utilisateur qui se connecte et pour l’administrateur du site. Le serveur Auth0 ne valide pas ou n’exige pas de valeur d’état et la renvoie intacte à l’URL de rappel. Si le message « État non valide » s’affiche, c’est que l’une des quatre premières étapes ci-dessus a échoué.

## Causes courantes de l’erreur « État non valide »

Vous trouverez ci-dessous les causes les plus courantes de l’erreur « État non valide » ainsi que les mesures de dépannage que vous pouvez prendre.

### URL de rappel mis en cache

La cause la plus fréquente de l’erreur « État non valide » est la mise en cache de l’URL de rappel sur le serveur.

Exclude caching on your server for all the URLs listed in the **Allowed Callback URLs** field in [Auth0 Dashboard > Applications > Applications > Settings](https://manage.auth0.com/#/applications/{yourClientId}/settings) and test again. In addition, exclude caching the site URL (`/index.php` on a regular install) if it has an Auth0 URL parameter.

Vérifiez si l’heure de votre serveur est incorrecte. L’erreur `BeforeValidException` peut se produire lorsque le jeton est perçu comme ayant été généré avant l’heure actuelle, ce qui peut se produire si l’heure du serveur est décalée. Vous pouvez vérifier l’heure de votre serveur en utilisant `echo current_time( ’c’ )`. Une solution temporaire peut également consister à modifier le plugin pour ajouter un décalage horaire si vous ne parvenez pas à modifier l’heure du serveur, un problème qui devrait toutefois être résolu pour la production.

Si cela ne résout pas le problème, continuez avec les étapes de dépannage ci-dessous.

### Témoins et paramètres URL mis en cache

Si vous êtes sur un hébergeur géré comme WP-Engine, vous devrez peut-être communiquer avec leur équipe de soutien pour obtenir de l’aide supplémentaire. On nous a signalé des problèmes d’accès aux témoins requis sur l’URL de rappel, ainsi que des problèmes de vérification de l’authentification sur la page finale que les utilisateurs voient après s’être connectés. Plus précisément, demandez que les exclusions de cache soient ajoutées pour :

* **Témoin :**`auth0_state`
* **Témoin :**`auth0_nonce`
* **Paramètre Arg/URL :**`auth0`
* **Paramètre Arg/URL :**`code`
* **Paramètre Arg/URL :**`state`
* **Paramètre Arg/URL :**`id_token`

### Actualisation de la page après un message d’erreur

Si vous actualisez la page après avoir obtenu un autre message d’erreur (vérification de l’adresse électronique, etc.), le message "« État non valide » s’affichera pour tenter de revalider une valeur déjà utilisée. Ce comportement est normal.

### Exigences en matière de noms de témoins

Some hosts, like Pantheon, require specific cookie names to be used. You can alter the cookie name using the `auth0_state_cookie_name` filter in your theme or a custom plugin. To learn more about the `auth0_state_cookie_name` filter, read [Extend Login by Auth0 WordPress Plugin](/docs/customize/integrations/cms/wordpress-plugin/extend-login-by-auth0). For additional information, [see the related GitHub issue](https://github.com/auth0/wp-auth0/issues/494) and [explore its fix](https://github.com/auth0/wp-auth0/pull/495).

### Page de connexion universelle et création de liens

If your site is using the <Tooltip tip="Universal Login: Your application redirects to Universal Login, hosted on Auth0's Authorization Server, to verify a user's identity." cta="View Glossary" href="/docs/glossary?term=Universal+Login">Universal Login</Tooltip> Page and you're building the link yourself in a theme or plugin, you need to:

* Définir un témoin appelé `auth0_state` avec une valeur générée de manière aléatoire
* Envoyer cette valeur dans un paramètre URL `state`.

Alternatively, you can go to Settings > Features tab > Universal Login Page and redirect login requests to the `wp-login.php` page where that cookie and URL parameter will be set automatically. If you want to continue to use a custom-built `/authorize` URL, you can [see the code that runs this process in the GitHub repository](https://github.com/auth0/wp-auth0/blob/master/lib/WP_Auth0_LoginManager.php#L90).

### Visiter l’URL de rappel directement

Si vous visitez votre URL de rappel (typiquement `yourdomain.com/index.php?auth0=1`) directement ou une seconde fois après l’échange du code d’autorisation, l’erreur « État non valide » peut s’afficher. Cela indique que l’état a déjà été vérifié et supprimé.

## Dépannage des erreurs d’état non valide

Notez que certaines des étapes ci-dessous nécessiteront que le processus de connexion soit interrompu pendant le processus (marqué comme tel) :

1. While logged out of WordPress and Auth0, visit the login page being tested.
2. Check if the `auth0_state` cookie is being set (in Chrome, View > Developer > JavaScript Console > Application tab > Storage on the left > Cookies > domain being tested, look for an `auth0_state` cookie with a non-empty value).

   * If this value is not set, check for errors in the JS console and make sure that your browser can accept cookies (login will not work without cookies). This is set in `/assets/js/lock-init.js`. You can [view this code on GitHub](https://github.com/auth0/wp-auth0/blob/master/assets/js/lock-init.js#L22).
   * If the value is set, copy the value and view the source code of the page (in Chrome, **View** > **Developer** > **View Source**). Search for the value, and it should appear as the value associated with parameter `wpAuth0LockGlobal.settings.auth.params.state` ([view sample JSON](https://gist.github.com/joshcanhelp/1b8bb990048325eb7214e2b3d7136b78)). Make a note of this value (you'll need it in a following step).
3. If the value appears there and the Lock form is loading normally then steps 1 and 2 from the first list above are functioning properly.
4. Before logging in, [add this code snippet to the top of your `wp-config.php`](https://gist.github.com/joshcanhelp/ba98f748747c7fd2ecdf54e73c6110f3), so you can do a test install. **WARNING**: This will break login for the WordPress site being tested, so use it only on a non-production install.
5. Log in normally.
6. After you're redirected back to your site's callback URL, the process will stop. You should see an output like what's shown in the linked Gist in step #4 above. If you see something like `Array()` with no additional values, then one of two things could be happening:

   * L’URL de rappel WordPress est mise en cache. La mise en cache des pages peut se faire de différentes manières, raison pour laquelle nous ne pouvons pas vous fournir de marche à suivre explicite. Vérifiez les plugins de mise en cache que vous avez installés, ils intègrent généralement une forme d’exclusion d’URL. Vérifiez également auprès de votre hébergeur que la mise en cache peut être automatisée et nécessiter l’intervention du service d’assistance.
   * The server is not reading the Auth0 cookie. For a possible solution, [see the related GitHub issue](https://github.com/auth0/wp-auth0/issues/494) and [explore its fix](https://github.com/auth0/wp-auth0/pull/495).
7. If the values are present, check the response headers for the callback URL being loaded (in Chrome, View > Developer > JavaScript Console > Network tab, click the first "document" listed with a 500 status and look for "Response Headers"). Look for any evidence of caching here, like a `Cache-Control` with a non-zero `max-age`, an `x-cache` of something other than `MISS`, or any other clue that this page is being served from a cache.
8. Also in the response headers, check that `set-cookie` includes a directive like `auth0_state=deleted` to confirm the validation process is happening.
9. Make sure that the `state` parameter in the URL matches the one recorded from the cookie being set in step #3 above.
10. If there is no evidence of caching, remove the debugging snippet from `wp-config.php` and refresh the callback URL. You should see the "Invalid state" message again. If any caching changes were made, attempt the login process all the way through (make sure to clear your cookies and browser cache for the site before testing).

Les étapes de dépannage suivantes nécessitent des modifications du plugin qui interrompront le processus de connexion et devront être annulées une fois terminées. Ces étapes doivent être effectuées sur un serveur de test ou un serveur intermédiaire.

11. Next, we need to check why the state is coming in but does not match the stored value.

12. In `lib/WP_Auth0_LoginManager.php`, output the values of the stored and returned state and stop the process after. Just before [line 148](https://github.com/auth0/wp-auth0/blob/master/lib/WP_Auth0_LoginManager.php#L148), add:

```bash wrap lines
echo '<h1>$_REQUEST</h1>'; var_dump($_REQUEST); echo '<h1>$_COOKIE</h1>'; var_dump($_COOKIE); die('<h1>Done</h1>');
```






13. Once again, make sure you're logged out and complete the login process.

14. You should see values output when redirected back to the WordPress callback URL.

15. Check if the `state` value in `$_REQUEST` exists and matches the `auth0_state` value in `$_COOKIE`.

* Si cette valeur est différente, elle doit correspondre à la valeur d’origine enregistrée à l’étape 3 ci-dessus. Cela signifie que la valeur de l’état `$_COOKIE` a changé au cours du processus.

If none of the steps above resolve the issue, please collect the results of the steps above and [contact support](https://support.auth0.com/) or [post on Community](https://community.auth0.com/tags/wordpress) with the tag `wordpress`. Also include:

* Version de PHP
* Version de WordPress
* Version du plugin Auth0
* Navigateur et système d’exploitation utilisés pour le test
* A HAR file recording the entire process from loading the page with the login form all the way through the "Invalid state" message. To learn more about HAR files, read [Generate and Analyze HAR Files](/docs/troubleshoot/troubleshooting-tools/generate-and-analyze-har-files).

  <Warning>

  Before sharing a HAR file with anyone (including Auth0), ensure that you remove or obfuscate all sensitive data, such as:

  + Confidential user information
  + Personal identifiable information (PII)
  + Confidential application information

  To learn more, read the following articles on [Auth0 Community](https://community.auth0.com):

  + [Sanitizing HTTP Traces](https://community.auth0.com/t/sanitizing-http-traces/119488)
  + [How to Sanitize an HTTP Trace File Automatically](https://community.auth0.com/t/how-to-sanitize-a-http-trace-file-automatically/120583)
  + [How to Manually Redact Sensitive Information](https://community.auth0.com/t/how-to-manually-redact-sensitive-information/122554)
  + [HAR File is Too Large to Upload to the Support Case](https://community.auth0.com/t/har-file-is-too-large-to-upload-to-the-support-case/122488)
  </Warning>

## Billets associés

* ["Invalid state" error during Auth0 WordPress redirect](https://community.auth0.com/t/invalid-state-error-during-auth0-wordpress-redirect/12552/16) in Auth0 Community
* [Invalid state when visiting the callback URL directly](https://wordpress.org/support/topic/unable-to-resolve-troubleshooting-with-a-client-grant-for-already-exists/) on wordpress.org